<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ù‡ Ø§Ù„Ø§Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ | ØªØ·ÙˆÙŠØ± Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø§Ø­Ù…Ø¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() { emailjs.init("arHaHSMk0C-C01YHE"); })();
    </script>
    <style>
        :root { --bg: #f4f7f6; --card: #ffffff; --p: #2c3e50; --g: #27ae60; --txt: #2c3e50; --red: #e74c3c; --orange: #f39c12; --blue: #3498db; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--txt); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 700px; margin: 10px 0; position: relative; border: 1px solid rgba(0,0,0,0.05); }
        .mustafa-tag { color: var(--g); font-weight: bold; font-size: 13px; text-align: center; display: block; margin: 10px 0; }
        .btn { padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-tech { background: var(--g); color: white; }
        .btn-back { background: rgba(0,0,0,0.1); color: var(--txt); width: auto; padding: 5px 15px; font-size: 12px; position: absolute; top: 10px; right: 10px; z-index: 100; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; background: white; font-size: 14px; }
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
        .grid-item { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid var(--g); cursor: pointer; font-weight: bold; }
        .history-item { background: rgba(0,0,0,0.03); padding: 15px; border-radius: 15px; margin-bottom: 10px; border-right: 5px solid var(--g); position: relative; text-align: right; }
        .re-tag { font-size: 11px; background: var(--orange); color: white; padding: 3px 8px; border-radius: 5px; display: inline-block; margin-top: 5px; }
        .badge-missed { background: var(--red); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; font-weight: bold; text-align: center; cursor: pointer; }
        .terms-box { background: #f9f9f9; padding: 15px; border-radius: 15px; font-size: 13px; margin-top: 20px; border: 1px dashed var(--g); }
        .top-rank { background: linear-gradient(135deg, #f1c40f, #f39c12); color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        footer { margin-top: auto; padding: 20px; font-size: 12px; color: #777; text-align: center; }
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000; }
        .broadcast-box { background: #ebf5ee; padding: 10px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; border: 1px solid var(--g); }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--g); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

<div id="loginGate" class="card">
    <div class="mustafa-tag">| Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ |</div>
    <h2 style="text-align:center;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ›¡ï¸</h2>
    <input type="text" id="entryKey" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ">
    <div id="staffSection" class="hidden">
        <input type="password" id="entryPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    </div>
    <button class="btn btn-tech" onclick="mainAuth()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    <button class="btn" style="background:transparent; color:var(--g);" onclick="document.getElementById('staffSection').classList.toggle('hidden')">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ø¯Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</button>
</div>

<div id="app" class="hidden" style="width:100%; max-width:700px;">
    
    <div id="topTenSection" class="card top-rank">
        <h3 style="margin:0; text-align:center;">ğŸ† Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
        <div id="topList" style="margin-top:10px; font-weight:bold; text-align:center;"></div>
    </div>

    <div id="studentPage" class="hidden card">
        <button class="btn btn-back" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        <h3 id="welcomeMsg"></h3>
        <div id="missedAlert" class="badge-missed hidden" onclick="showMissedDetails()"></div>
        <h4>Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</h4>
        <div id="recordsList"></div>
    </div>

    <div id="teacherDash" class="hidden card">
        <button class="btn btn-back" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        <div id="roleDisplay" class="mustafa-tag"></div>
        <input type="text" id="searchBox" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø·Ø§Ù„Ø¨..." oninput="filterGrid()">
        
        <div id="classTabs" style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0;"></div>
        
        <div id="namesGrid" class="grid"></div>
        <button id="adminBtn" class="btn hidden" style="background:#2c3e50; color:white; margin-top:20px;" onclick="showManagePage()">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        <h3 id="targetName" style="color:var(--g)"></h3>
        <div id="gradeForm">
             <div class="broadcast-box">
                <label class="switch"><input type="checkbox" id="broadcastMode"><span class="slider"></span></label>
                <span style="font-size: 13px; font-weight: bold; color: var(--g);">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="gWeek"></select>
                <select id="gDay">
                    <option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯">ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯</option>
                    <option value="ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
                    <option value="ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
                    <option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
                    <option value="ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³">ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³</option>
                </select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
                <input type="number" id="gMark" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© / 7">
            </div>
            <select id="gStatus">
                <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
                <option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
                <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
                <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
                <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option>
            </select>
            <textarea id="gNote" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø·Ø§Ù„Ø¨ Ù‡Ù†Ø§..."></textarea>
            <button class="btn btn-tech" onclick="saveGrade()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <hr>
        <div id="editHistory"></div>
    </div>

    <div id="managePage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3>ğŸ› ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù… (Ù„Ù„Ø£Ø³ØªØ§Ø° Ø³Ø¹Ø¯)</h3>
        
        <div style="background: #eef2f3; padding: 15px; border-radius: 15px; margin-bottom:15px;">
            <h4>ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„</h4>
            <input type="text" id="newClassName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ (Ù…Ø«Ù„Ø§Ù‹: 4/1)">
            <select id="assignTeacher"></select> <button class="btn btn-tech" onclick="createNewClass()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØµÙ„</button>
            <div id="classesManagerList" style="margin-top:10px; font-size:12px;"></div>
        </div>

        <button class="btn" style="background:var(--red); color:white;" onclick="resetTopTen()">ğŸ§¹ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</button>
        <hr>
        <div style="background: #f9f9f9; padding: 15px; border-radius: 15px;">
            <h4>ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ø¯Ø± ØªØ¹Ù„ÙŠÙ…ÙŠ</h4>
            <input type="text" id="mUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="mPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <div style="text-align:right; font-size:13px; margin:10px 0;">
                <label><input type="checkbox" id="pGrade"> ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±ØµØ¯</label><br>
                <label><input type="checkbox" id="pEdit"> ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</label><br>
                <label><input type="checkbox" id="pAdmin"> ØµÙ„Ø§Ø­ÙŠØ© Ø£Ø¯Ù…Ù†</label>
            </div>
            <button class="btn btn-tech" onclick="addStaff()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØ§Ø¯Ø±</button>
        </div>
        <div id="staffList" style="margin-top:20px;"></div>
        <hr>
        <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h4>
        <input type="text" id="newSName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
        <input type="text" id="newSCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
        <select id="newSClassSelect"></select> <button class="btn btn-tech" onclick="addNewStudent()">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
        <div id="fullList" style="margin-top:10px;"></div>
    </div>
</div>

<div id="missedModal" class="modal hidden">
    <div class="card" style="max-width:500px;">
        <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª</h3>
        <div id="missedListContent"></div>
        <button class="btn btn-tech" onclick="document.getElementById('missedModal').classList.add('hidden')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<footer><b>ØªØ·ÙˆÙŠØ±: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø§Ø­Ù…Ø¯ | Ø§Ù„Ø¯Ø¹Ù…: 0599804296</b></footer>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let students = []; let currentSID = null; let currentStaff = null; let editingIdx = null;
    let broadcastData = { week: null, day: null, page: null };
    let globalClasses = [];

    const weeksArr = ["Ø§Ù„Ø£ÙˆÙ„","Ø§Ù„Ø«Ø§Ù†ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø«","Ø§Ù„Ø±Ø§Ø¨Ø¹","Ø§Ù„Ø®Ø§Ù…Ø³","Ø§Ù„Ø³Ø§Ø¯Ø³","Ø§Ù„Ø³Ø§Ø¨Ø¹","Ø§Ù„Ø«Ø§Ù…Ù†","Ø§Ù„ØªØ§Ø³Ø¹","Ø§Ù„Ø¹Ø§Ø´Ø±","Ø§Ù„Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ø´Ø±","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù…Ù† Ø¹Ø´Ø±","Ø§Ù„ØªØ§Ø³Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø¹Ø´Ø±ÙˆÙ†"];
    document.getElementById('gWeek').innerHTML = weeksArr.map(w => `<option value="Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}</option>`).join('');

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆØ± ---
    async function mainAuth() {
        const key = document.getElementById('entryKey').value.trim();
        const pass = document.getElementById('entryPass').value.trim();
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const stdSnap = await db.ref('students').once('value');
        students = Object.values(stdSnap.val() || {});
        const staffSnap = await db.ref('staff').once('value');
        const staffList = Object.values(staffSnap.val() || {});
        fetchTopTen();
        loadGlobalClasses();

        // 1. Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ø¯Ø± (Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯ÙˆÙ† OTP)
        if(pass !== "") {
            if(key === 'saad' && pass === 'saad2026') {
                currentStaff = { username: 'Ø³Ø¹Ø¯', pGrade: true, pEdit: true, pAdmin: true };
                setupDash();
            } else {
                const member = staffList.find(u => u.username === key && u.pass === pass);
                if(member) { currentStaff = member; setupDash(); }
                else alert("Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø¯Ø±");
            }
        } 
        // 2. Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù…Ø¹ OTP Ø§Ù„Ù…Ø­Ø³Ù†)
        else {
            const std = students.find(x => x.code === key);
            if(std) {
                const otp = Math.floor(100000 + Math.random() * 900000);
                console.log("Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ (OTP) Ù„Ù„Ø·Ø§Ù„Ø¨ Ù‡Ùˆ: " + otp); // Ø¥ØµÙ„Ø§Ø­: Ø§Ù„Ø±Ù…Ø² ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
                
                const emails = ["nosososo68@gmail.com", "meethaq1@gmail.com"];
                emails.forEach(email => {
                    emailjs.send("service_rtw59ul", "template_4cqswa6", { to_email: email, otp_code: otp })
                    .catch(e => console.log("EmailJS Error: ", e));
                });

                const userInput = prompt("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ù„Ø¥ÙŠÙ…ÙŠÙ„Ùƒ ÙˆØ¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø³Ø¹Ø¯. Ø£Ø¯Ø®Ù„Ù‡ Ù‡Ù†Ø§:");
                if(userInput == otp) {
                    currentSID = std.id; showScreen('studentPage'); renderStudentRecords(std);
                } else alert("Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­");
            } else alert("ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­");
        }
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„ ---
    function loadGlobalClasses() {
        db.ref('classes').on('value', snap => {
            globalClasses = Object.values(snap.val() || {});
            renderClassTabs();
            renderManageClasses();
        });
    }

    function createNewClass() {
        if(!currentStaff.pAdmin) return;
        const name = document.getElementById('newClassName').value;
        const teacher = document.getElementById('assignTeacher').value;
        if(!name) return alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„");
        const id = Date.now();
        db.ref('classes/'+id).set({ id, name, teacher }).then(() => {
            alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØµÙ„ Ø¨Ù†Ø¬Ø§Ø­");
            document.getElementById('newClassName').value = "";
        });
    }

    function renderClassTabs() {
        const container = document.getElementById('classTabs');
        // ÙÙ„ØªØ±Ø© Ø§Ù„ÙØµÙˆÙ„: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø£Ø¯Ù…Ù†ØŒ ÙŠØ±Ù‰ ÙÙ‚Ø· ÙØµÙˆÙ„Ù‡ Ø§Ù„Ù…Ø³Ù†Ø¯Ø© Ø¥Ù„ÙŠÙ‡
        const myClasses = currentStaff.pAdmin ? globalClasses : globalClasses.filter(c => c.teacher === currentStaff.username);
        
        container.innerHTML = myClasses.map(c => `
            <button class="btn btn-tech" style="width:auto; padding:8px 15px;" onclick="loadClass('${c.name}')">${c.name}</button>
        `).join('');
    }

    function renderManageClasses() {
        const list = document.getElementById('classesManagerList');
        const select = document.getElementById('newSClassSelect');
        list.innerHTML = globalClasses.map(c => `
            <div style="border-bottom:1px solid #ccc; padding:5px;">
                <b>${c.name}</b> (Ø§Ù„Ù…Ø¹Ù„Ù…: ${c.teacher}) 
                <button onclick="db.ref('classes/${c.id}').remove()" style="color:red; background:none; border:none; cursor:pointer;">[Ø­Ø°Ù]</button>
            </div>
        `).join('');
        select.innerHTML = globalClasses.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
    }

    // --- Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø·ÙÙŠÙØ© Ù„Ù„Ø±Ø¨Ø· ---

    function setupDash() {
        showScreen('teacherDash');
        document.getElementById('roleDisplay').innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹: ${currentStaff.username}`;
        if(currentStaff.pAdmin) {
            document.getElementById('adminBtn').classList.remove('hidden');
            // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù„Ù„Ø£Ø³ØªØ§Ø° Ø³Ø¹Ø¯ Ù„ÙŠØ±Ø¨Ø·Ù‡Ù… Ø¨Ø§Ù„ÙØµÙˆÙ„
            db.ref('staff').once('value', sn => {
                const list = Object.values(sn.val() || {});
                document.getElementById('assignTeacher').innerHTML = list.map(m => `<option value="${m.username}">${m.username}</option>`).join('');
            });
        }
        loadGlobalClasses();
    }

    function loadClass(clsName) {
        const g = document.getElementById('namesGrid'); g.innerHTML = "";
        students.filter(x => x.class === clsName).forEach(s => {
            const d = document.createElement('div'); d.className = 'grid-item'; d.innerText = s.name;
            d.onclick = () => {
                currentSID = s.id; editingIdx = null;
                document.getElementById('targetName').innerText = s.name;
                renderEditHistory(s); showScreen('gradeScreen');
            };
            g.appendChild(d);
        });
    }

    function addNewStudent() {
        const name = document.getElementById('newSName').value;
        const code = document.getElementById('newSCode').value;
        const cls = document.getElementById('newSClassSelect').value;
        if(!name || !code) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        const id = Date.now();
        db.ref('students/'+id).set({ id, name, code, class: cls }).then(() => {
            alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨");
            location.reload();
        });
    }

    // (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© - ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ù†Ø³Ø®ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ©)
    function showScreen(id) { document.getElementById('loginGate').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); document.querySelectorAll('#app > div:not(#topTenSection)').forEach(d => d.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function filterGrid() { const q = document.getElementById('searchBox').value.toLowerCase(); document.querySelectorAll('.grid-item').forEach(i => i.style.display = i.innerText.toLowerCase().includes(q) ? 'block' : 'none'); }
    function fetchTopTen() { db.ref('topTen').on('value', sn => { document.getElementById('topList').innerHTML = (sn.val() || []).join(' | '); }); }
    function resetTopTen() { const n = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©"); if(n) db.ref('topTen').set(n.split('ØŒ')); }
    function saveGrade() {
        if(!currentStaff.pGrade) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø±ØµØ¯");
        const s = students.find(x => x.id == currentSID);
        if(!s.records) s.records = [];
        if(editingIdx !== null) s.records.splice(editingIdx, 1);
        const newRec = {
            week: document.getElementById('gWeek').value, day: document.getElementById('gDay').value,
            page: document.getElementById('gPage').value, mark: document.getElementById('gMark').value,
            status: document.getElementById('gStatus').value, note: document.getElementById('gNote').value,
            by: currentStaff.username
        };
        s.records.push(newRec);
        db.ref('students/'+currentSID+'/records').set(s.records).then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); showScreen('teacherDash'); });
    }
    function renderStudentRecords(s) {
        document.getElementById('welcomeMsg').innerText = "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ: " + s.name;
        const recs = s.records || [];
        document.getElementById('recordsList').innerHTML = recs.map(r => `<div class="history-item"><b>${r.week}</b> - ${r.status}</div>`).reverse().join('');
    }
    function renderEditHistory(s) {
        const recs = s.records || [];
        document.getElementById('editHistory').innerHTML = recs.map((r, i) => `<div class="history-item">${r.week} - ${r.status}</div>`).reverse().join('');
    }
    function addStaff() {
        const id = Date.now();
        db.ref('staff/'+id).set({
            id, username: document.getElementById('mUsername').value, pass: document.getElementById('mPass').value,
            pGrade: document.getElementById('pGrade').checked, pEdit: document.getElementById('pEdit').checked, pAdmin: document.getElementById('pAdmin').checked
        }).then(() => alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"));
    }
</script>
</body>
</html>
