<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ | ØªØ·ÙˆÙŠØ± ÙŠØ²Ù† ÙˆÙ…ØµØ·ÙÙ‰ ÙˆÙ…Ø­Ù…Ø¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --p: #1e4d2b; --g: #d4af37; --bg: #f4f7f6; --card: #ffffff; --txt: #333; }
        .t-blue { --p: #1a3a5f; --g: #00bcd4; --bg: #f0f4f8; --card: #ffffff; --txt: #222; }
        .t-dark { --p: #121212; --g: #bb86fc; --bg: #1e1e1e; --card: #2d2d2d; --txt: #eee; }
        .t-gold { --p: #443305; --g: #d4af37; --bg: #1a1a1a; --card: #2a2208; --txt: #f1e4bc; }
        .t-smart { --p: #4e54c8; --g: #ff0080; --bg: #f8f9fa; --card: #ffffff; --txt: #333; }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--txt); margin: 0; padding: 10px; direction: rtl; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin: 15px auto; max-width: 600px; border-top: 5px solid var(--g); animation: slideIn 0.5s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn { padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin: 8px 0; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-p { background: var(--p); color: white; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid rgba(0,0,0,0.05); border-radius: 10px; background: rgba(0,0,0,0.02); color: inherit; text-align: center; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; }
        .grid-item { background: var(--p); color: white; padding: 10px; border-radius: 12px; cursor: pointer; font-size: 12px; height: 70px; display: flex; align-items: center; justify-content: center; text-align: center; }
        
        .progress-box { background: #e8f5e9; border: 2px solid var(--p); border-radius: 15px; padding: 15px; margin: 15px 0; text-align: center; }
        .progress-box h1 { margin: 5px 0; color: var(--p); font-size: 40px; }
        
        /* ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© */
        .missing-box { background: #ffebee; border: 1px dashed #c62828; color: #c62828; padding: 10px; border-radius: 10px; margin-bottom: 15px; font-size: 13px; text-align: right; }
        
        .footer { font-size: 11px; opacity: 0.7; margin-top: 30px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 10px; }
        .hidden { display: none !important; }
        .theme-ball { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; }
    </style>
</head>
<body id="body">

<div id="app">
    <div id="siteLock" class="card" style="margin-top: 80px;">
        <h2>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ ğŸ“š</h2>
        <input type="password" id="siteKey" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ (12345678w)">
        <button class="btn btn-p" onclick="unlockSite()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="mainMenu" class="hidden card">
        <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
            <div class="theme-ball" style="background:#1e4d2b" onclick="setTheme('')"></div>
            <div class="theme-ball" style="background:#1a3a5f" onclick="setTheme('t-blue')"></div>
            <div class="theme-ball" style="background:#121212" onclick="setTheme('t-dark')"></div>
            <div class="theme-ball" style="background:#d4af37" onclick="setTheme('t-gold')"></div>
            <div class="theme-ball" style="background:#4e54c8" onclick="setTheme('t-smart')"></div>
        </div>
        <h3>Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ</h3>
        <input type="number" id="studentCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ">
        <button class="btn btn-p" onclick="studentLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ / ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</button>
        <hr>
        <button class="btn" style="background:#2c3e50; color:white;" onclick="showScreen('staffLogin')">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø£Ø³ØªØ§Ø°</button>
        <div class="footer">ØªØ·ÙˆÙŠØ±: ÙŠØ²Ù†ØŒ Ù…ØµØ·ÙÙ‰ØŒ Ù…Ø­Ù…Ø¯ | 0599804296</div>
    </div>

    <div id="studentPage" class="hidden card">
        <h2 id="welcomeMsg"></h2>
        <div class="progress-box">
            <span>Ù…Ù‚Ø±Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (4 Ø£ÙˆØ¬Ù‡)</span>
            <h1 id="weekCounter">0 / 4</h1>
            <small id="currentWeekDisplay"></small>
        </div>

        <div id="missingRecords" class="missing-box hidden">
            <b>âš ï¸ Ø¯Ø±ÙˆØ³ Ù„Ù… ØªØ³Ù…Ø¹Ù‡Ø§ Ø¨Ø¹Ø¯:</b>
            <ul id="missingList" style="margin: 5px 0; padding-right: 20px;"></ul>
        </div>

        <div style="background:#fff3e0; padding:10px; border-radius:10px; color:#e65100; font-size:12px; margin-bottom:15px;">
             ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¯Ø±ÙˆØ³ "Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©" ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªØ²ÙŠØ¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ.
        </div>
        
        <h4>Ø³Ø¬Ù„ Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ Ø§Ù„ÙƒØ§Ù…Ù„:</h4>
        <div id="recordsList"></div>
        <button class="btn btn-p" onclick="showScreen('mainMenu')">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="staffLogin" class="hidden card">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù‚Ù…</h3>
        <input type="text" id="user" placeholder="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-p" onclick="staffAuth()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" onclick="showScreen('mainMenu')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="teacherDash" class="hidden card" style="max-width:800px;">
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° Ø³Ø¹Ø¯ ğŸ› ï¸</h3>
        <div style="background:#eee; padding:15px; border-radius:15px; margin-bottom:15px;">
            <label>ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ù„Ø¬Ù…ÙŠØ¹):</label>
            <input type="number" id="globalWeekNum" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙÙ‚Ø· (Ù…Ø«Ù„Ø§Ù‹: 8)">
            <button class="btn-p" style="padding:5px 15px; border-radius:8px;" onclick="updateGlobalWeek()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-p" onclick="loadClass('3/1')">ÙØµÙ„ 3/1</button>
            <button class="btn btn-p" onclick="loadClass('3/2')">ÙØµÙ„ 3/2</button>
        </div>
        <div id="namesGrid" class="grid"></div>
        <hr>
        <button class="btn" style="background:#c0392b; color:white" onclick="showScreen('mainMenu')">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <h3 id="targetName"></h3>
        <p>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b id="activeWeekLabel"></b></p>
        <input type="text" id="gDay" placeholder="Ø§Ù„ÙŠÙˆÙ…">
        <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
        <input type="text" id="gMark" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©">
        <select id="gStatus">
            <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
            <option value="Ù„Ù… ÙŠØ­ÙØ¸">Ù„Ù… ÙŠØ­ÙØ¸ âš ï¸</option>
            <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
            <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
            <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… â›”</option>
        </select>
        <div style="background:#f0f0f0; padding:10px; border-radius:10px; margin:10px 0;">
            <input type="checkbox" id="isLate" style="width:auto;"> <label for="isLate">Ù‡Ø°Ø§ Ø¯Ø±Ø³ "Ù…ØªØ£Ø®Ø±" (Ù‚Ø¯ÙŠÙ…)</label>
        </div>
        <textarea id="gNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°..."></textarea>
        <button class="btn btn-p" onclick="saveGrade()">Ø­ÙØ¸ Ø§Ù„Ø±ØµØ¯</button>
        <button class="btn" onclick="showScreen('teacherDash')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8",
        databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let students = [];
    let currentSID = null;
    let globalWeek = 1;

    db.ref('students').on('value', s => { students = Object.values(s.val() || {}); });
    db.ref('settings/currentWeek').on('value', s => { globalWeek = parseInt(s.val()) || 1; });

    function unlockSite() { if(document.getElementById('siteKey').value === '12345678w') showScreen('mainMenu'); else alert('Ø®Ø·Ø£'); }
    function setTheme(t) { document.getElementById('body').className = t; }

    function studentLogin() {
        const code = document.getElementById('studentCode').value;
        const s = students.find(x => x.code == code);
        if(s) {
            document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${s.name}`;
            document.getElementById('currentWeekDisplay').innerText = `Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${globalWeek}`;
            renderStudentRecords(s);
            showScreen('studentPage');
        } else alert('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­');
    }

    function staffAuth() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        if(u==='saad' && p==='12345678s') showScreen('teacherDash');
        else alert('Ø®Ø·Ø£');
    }

    function loadClass(cls) {
        const grid = document.getElementById('namesGrid'); grid.innerHTML = "";
        students.filter(x => x.class === cls).forEach(s => {
            const div = document.createElement('div');
            div.className = "grid-item"; div.innerText = s.name;
            div.onclick = () => { 
                currentSID = s.id; document.getElementById('targetName').innerText = s.name;
                document.getElementById('activeWeekLabel').innerText = globalWeek;
                showScreen('gradeScreen'); 
            };
            grid.appendChild(div);
        });
    }

    function updateGlobalWeek() {
        const val = document.getElementById('globalWeekNum').value;
        if(val) db.ref('settings/currentWeek').set(val).then(()=>alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹'));
    }

    function saveGrade() {
        const sIdx = students.findIndex(x => x.id == currentSID);
        const rec = {
            week: globalWeek,
            day: document.getElementById('gDay').value,
            page: document.getElementById('gPage').value,
            mark: document.getElementById('gMark').value,
            status: document.getElementById('gStatus').value,
            note: document.getElementById('gNote').value,
            isLate: document.getElementById('isLate').checked
        };
        if(!students[sIdx].records) students[sIdx].records = [];
        students[sIdx].records.unshift(rec);
        db.ref('students').set(students).then(() => { alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); showScreen('teacherDash'); });
    }

    function renderStudentRecords(s) {
        const list = document.getElementById('recordsList');
        const counter = document.getElementById('weekCounter');
        const missingBox = document.getElementById('missingRecords');
        const missingList = document.getElementById('missingList');
        
        // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ
        const weekRecs = (s.records || []).filter(r => r.week == globalWeek && !r.isLate && r.status === "Ø­Ø§ÙØ¸");
        counter.innerText = `${weekRecs.length} / 4`;

        // 2. ÙƒØ´Ù Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„ØªÙŠ Ù„Ù… ØªØ³Ù…Ø¹ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©)
        const missing = (s.records || []).filter(r => r.status !== "Ø­Ø§ÙØ¸");
        if(missing.length > 0) {
            missingBox.classList.remove('hidden');
            missingList.innerHTML = missing.map(m => `<li>Ø£Ø³Ø¨ÙˆØ¹ ${m.week}: ØµÙØ­Ø© (${m.page}) - Ø­Ø§Ù„ØªÙ‡Ø§: ${m.status}</li>`).join('');
        } else {
            missingBox.classList.add('hidden');
        }

        // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„
        list.innerHTML = (s.records || []).map(r => `
            <div style="border-right:5px solid ${r.status==='Ø­Ø§ÙØ¸'?'#27ae60':'#c0392b'}; padding:10px; margin:10px 0; background:white; border-radius:10px;">
                <b>Ø£Ø³Ø¨ÙˆØ¹ ${r.week} - ÙŠÙˆÙ… ${r.day}</b><br>
                Øµ: ${r.page} | Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status}
            </div>
        `).join('');
    }

    function showScreen(id) {
        document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
