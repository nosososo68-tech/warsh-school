<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ v3.0 | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ø§Ù„ÙØ§Ø®Ø±Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        /* [Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø£ÙŠ Ø­Ø±Ù] */
        :root { --primary: #2c3e50; --secondary: #34495e; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; --info: #3498db; --light: #f4f7f6; --dark: #1a1a2e; --white: #ffffff; --shadow: 0 10px 30px rgba(0,0,0,0.1); --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        [data-theme="dark"] { --light: #1a1a2e; --white: #16213e; --primary: #e94560; --txt: #ffffff; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: var(--transition); }
        body { background: var(--light); color: var(--primary); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; line-height: 1.6; }
        .card { background: var(--white); border-radius: 25px; padding: 30px; box-shadow: var(--shadow); width: 100%; max-width: 950px; margin: 15px 0; position: relative; border: 1px solid rgba(0,0,0,0.05); overflow: hidden; }
        .mustafa-tag { color: var(--success); font-weight: 700; font-size: 14px; text-align: center; display: block; margin: 15px 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; letter-spacing: 1px; }
        .btn { padding: 15px 25px; border: none; border-radius: 15px; cursor: pointer; font-weight: 700; width: 100%; margin: 8px 0; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.98); }
        .btn-tech { background: linear-gradient(135deg, var(--success), #2ecc71); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #ff7675); color: white; }
        .btn-info { background: linear-gradient(135deg, var(--info), #81ecec); color: white; }
        .btn-back { background: rgba(0,0,0,0.05); color: var(--primary); width: auto; padding: 8px 20px; position: absolute; top: 20px; right: 20px; z-index: 100; border-radius: 10px; font-size: 12px; }
        input, select, textarea { width: 100%; padding: 16px; margin: 10px 0; border-radius: 15px; border: 2px solid #eee; background: #fafafa; font-size: 15px; outline: none; }
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 25px; width: 100%; }
        .grid-item { background: var(--white); padding: 25px; border-radius: 20px; text-align: center; border: 2px solid #eef2f3; cursor: pointer; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.02); }
        
        /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© */
        .status-Ø­Ø§ÙØ¸ { background: #e8f5e9 !important; border-color: #2ecc71 !important; color: #1b5e20 !important; }
        .status-ØºÙŠØ±-Ø­Ø§ÙØ¸ { background: #fffde7 !important; border-color: #f1c40f !important; color: #f39c12 !important; }
        .status-ØºØ§Ø¦Ø¨ { background: #e3f2fd !important; border-color: #3498db !important; color: #0d47a1 !important; }
        .status-Ù„Ù…-ÙŠØ³Ù…Ø¹ { background: #ffebee !important; border-color: #e74c3c !important; color: #c0392b !important; }
        .status-Ù…Ø­Ø±ÙˆÙ… { background: #34495e !important; border-color: #2c3e50 !important; color: #ffffff !important; }
        .status-Ù…ØªØ§Ø­ { background: #ffffff !important; border-color: #cbd5e1 !important; }

        .history-item { background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 15px; border-right: 8px solid var(--success); position: relative; }
        .original-badge { background: var(--warning); color: #fff; padding: 4px 10px; border-radius: 8px; font-size: 11px; margin-top: 10px; display: inline-block; }
        .guide-step { background: #fff; padding: 20px; border-radius: 20px; margin-bottom: 25px; border-left: 6px solid var(--info); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div id="loginGate" class="card">
    <div class="mustafa-tag">| Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ø§Ù„ÙØ§Ø®Ø±Ø© v3.0 |</div>
    <div style="text-align:center; margin-bottom: 30px;">
        <img src="https://cdn-icons-png.flaticon.com/512/2602/2602414.png" width="90" alt="Logo">
        <h2 style="margin-top:15px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… ğŸ›¡ï¸</h2>
    </div>
    <input type="text" id="entryKey" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
    <div id="staffSection" class="hidden">
        <input type="password" id="entryPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <button class="btn btn-tech" onclick="mainAuth()">ğŸš€ Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
    <button class="btn" style="background:transparent; color:var(--primary);" onclick="toggleStaff()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© / Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
</div>

<div id="app" class="hidden" style="width:100%;">
    <div id="teacherDash" class="hidden card">
        <button class="btn btn-back" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <div id="roleDisplay" class="mustafa-tag"></div>
        
        <div id="broadcastPanel" class="card" style="background:#fff9e6; border:1px solid #ffeaa7;">
            <h4>ğŸ“¢ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø§Ù„Ø±ØµØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹)</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                <select id="bcWeek"></select>
                <select id="bcDay">
                    <option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
                </select>
                <input type="number" id="bcPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
            </div>
            <button class="btn btn-info" onclick="applyBroadcast()">âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ù…ÙŠÙ… ÙˆØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        </div>

        <div id="classTabs" style="display:flex; gap:10px; margin:20px 0;"></div>
        <input type="text" id="searchBox" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." oninput="renderNamesGrid()">
        <div id="namesGrid" class="grid"></div>
        
        <button id="adminBtn" class="btn hidden" style="background:var(--primary); color:white; margin-top:20px;" onclick="showScreen('adminPage')">ğŸ‘‘ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</button>
        <button id="idarahBtn" class="btn hidden" style="background:var(--dark); color:white;" onclick="showScreen('idarahPage')">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… idarah</button>
    </div>

    <div id="idarahPage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h2>âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ Ø§Ù„Ø´Ø§Ù…Ù„Ø© (idarah)</h2>
        <div class="card">
            <h4>ğŸ‘¥ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h4>
            <div id="fullStaffList"></div>
        </div>
        <div class="card" style="background:#fff1f1;">
            <h4 style="color:var(--danger)">ğŸ§¨ ØµÙŠØ§Ù†Ø© Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©</h4>
            <button class="btn btn-danger" onclick="resetDatabase()">Ø­Ø°Ù ÙˆØªØµÙÙŠØ± Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
        </div>
    </div>

    <div id="adminPage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3>ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
        <div class="card">
            <h4>ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ø§Ù„Ø¨</h4>
            <select id="adminStudentSelect" onchange="loadAdminFields()"></select>
            <input type="text" id="adminNewName" placeholder="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…">
            <input type="text" id="adminNewCode" placeholder="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯">
            <select id="adminNewClass">
                <option value="3/1">3/1</option><option value="3/2">3/2</option><option value="3/3">3/3</option>
            </select>
            <button class="btn btn-tech" onclick="adminProcessUpdate()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
        <button class="btn btn-info" onclick="generateReport()">ğŸ“‘ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3 id="targetName"></h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <select id="gWeek"></select>
            <select id="gDay"><option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option></select>
        </div>
        <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
        <select id="gStatus">
            <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
            <option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
            <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
            <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option>
            <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
        </select>
        <button class="btn btn-tech" onclick="saveGrade()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø±ØµØ¯</button>
        <div id="fullHistoryList"></div>
    </div>

    <div id="studentPage" class="hidden card">
        <button class="btn btn-back" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <h2 id="stdNameTitle"></h2>
        <div id="stdStats" class="guide-step">
            <p>ğŸ”´ <b>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª:</b> <span id="lateCount">0</span></p>
            <p style="font-size:12px; color:#666;">* Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª Ù‡ÙŠ Ø£ÙŠ Ø¯Ø±Ø³ Ø­Ø§Ù„ØªÙ‡ ØºÙŠØ± (Ø­Ø§ÙØ¸).</p>
        </div>
        <div class="guide-step" style="background:#f0f9ff; border-left-color:var(--info);">
            <h4>ğŸ“š Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª:</h4>
            <ul style="font-size:13px;">
                <li><b>Ø­Ø§ÙØ¸:</b> Ø³Ù…Ø¹Øª Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­.</li>
                <li><b>Ù„Ù… ÙŠØ³Ù…Ø¹:</b> Ù„Ù… ØªØ³Ù…Ø¹ Ø§Ù„Ø¯Ø±Ø³ Ù…Ø·Ù„Ù‚Ø§Ù‹.</li>
                <li><b>ØºØ§Ø¦Ø¨:</b> Ù„Ù… ØªÙƒÙ† Ù…ØªÙˆØ§Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­ØµØ©.</li>
                <li><b>ØºÙŠØ± Ø­Ø§ÙØ¸:</b> Ø³Ù…Ø¹Øª ÙˆÙ„ÙƒÙ† Ù„Ø¯ÙŠÙƒ Ø£Ø®Ø·Ø§Ø¡ Ù…Ù†Ø¹ØªÙƒ Ù…Ù† Ø§Ù„Ø§Ø¬ØªÙŠØ§Ø².</li>
                <li><b>Ù…Ø­Ø±ÙˆÙ…:</b> Ø¹Ù‚ÙˆØ¨Ø© Ù„Ù…Ø®Ø§Ù„ÙØ© Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ø£Ø³ØªØ§Ø° ØªÙ…Ù†Ø¹Ùƒ Ù…Ù† Ø§Ù„ØªØ³Ù…ÙŠØ¹.</li>
            </ul>
        </div>
        <div id="stdHistoryContainer"></div>
    </div>
</div>

<footer>
    <b>Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ Â© 2026</b><br>
    ØªØ·ÙˆÙŠØ±: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯ | 0599804296
</footer>

<script>
const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let students = [], currentUser = null, targetSID = null, selectedClass = "3/3";
let sessionBroadcast = null;

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
const manualData = [
    {name: "Ø§Ø­Ù…Ø¯ Ø¹Ù…Ø± Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3326"}, {name: "Ø¨Ø³Ø§Ù… Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3370"},
    {name: "Ø¨Ø´Ø§Ø± Ø±Ø§Ù…Ø² ÙƒÙ†Ø¹Ø§Ù†", code: "3355"}, {name: "ØªÙ…ÙŠÙ… Ù†ÙˆØ± Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3309"},
    {name: "Ø­Ø³ÙŠÙ† Ø¹Ø¨Ø¯Ø§Ù„ÙƒØ±ÙŠÙ… Ø¨Ù† Ø¨Ø§Ø¯ÙŠ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3358"}, {name: "Ø®Ø§Ù„Ø¯ Ø³Ù„ÙŠÙ… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3393"},
    {name: "Ø±Ø§Ø¦Ø¯ ÙØ§ÙŠØ² Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ", code: "3301"}, {name: "Ø±ÙŠØ§Ù† Ø¹Ø·Ø§Ù„Ù„Ù‡ Ø¹Ø¨ÙŠØ§Ù† Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3389"},
    {name: "Ø³Ø§Ù…Ø± Ø¹Ù…Ø± Ø¨Ù† Ø¯Ø®ÙŠÙ„ Ø§Ù„Ù„Ù‡ Ø§Ù„ØµØ§Ø¹Ø¯ÙŠ", code: "3259"}, {name: "Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3302"},
    {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ", code: "3357"}, {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø£Ù…ÙŠÙ† Ø­Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙƒÙŠ", code: "3392"},
    {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø¤Ù…Ù† Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„Ø´Ù‡ÙŠØ¯", code: "3379"}, {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù†Ø§ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ø¬Ù†ÙŠ", code: "3304"},
    {name: "Ø¹Ù…Ø§Ø± Ø£Ø­Ù…Ø¯ Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3399"}, {name: "Ø¹Ù…Ø± Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£Ù…ÙŠÙ† â€“ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø´ÙŠØ±", code: "3310"},
    {name: "ØºØ§Ù†Ù… ØµÙ„Ø§Ø­ ØºØ§Ù†Ù… Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3391"}, {name: "ÙØ±Ø§Ø³ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3322"},
    {name: "ÙÙ‡Ø¯ Ù…Ø­Ù…Ø¯ ÙˆØµÙ„ Ø§Ù„Ø²Ø±ÙØ§Ù†ÙŠ", code: "3300"}, {name: "ÙÙŠØµÙ„ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ø§Ø·Ø± Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ", code: "3366"},
    {name: "ÙÙŠØµÙ„ Ø­Ø³Ø§Ù… Ø§Ù„Ø¯ÙŠÙ† â€“ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙ†", code: "3311"}, {name: "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3349"},
    {name: "Ù…Ø®ØªØ§Ø± Ø­Ù…ÙˆØ¯ ÙˆØ§Ù„Ù…Ø­Ù…Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±", code: "3360"}, {name: "Ù…Ø®ØªØ§Ø± Ø±Ø¨ÙŠØ¹ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆÙ„Ø¯ Ø§Ø¨Ø§Ù‡", code: "3365"},
    {name: "Ù…ØµØ·ÙÙ‰ Ù…Ø®ØªØ§Ø± Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø®ØªØ§Ø±", code: "3396"}, {name: "Ù…Ø¤ÙŠØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ù‚ÙˆÙŠÙ… Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ù‡Ù†Ø¯ÙŠ", code: "3387"},
    {name: "Ù†ÙˆØ§Ù Ø¹Ù…Ø± Ø¨Ù† Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ", code: "3395"}, {name: "Ù‡Ø§Ø´Ù… Ø£Ø­Ù…Ø¯ Ø¨Ù† ØµØ§Ù„Ø­ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡", code: "3388"},
    {name: "ÙŠØ­ÙŠÙ‰ Ø£Ø­Ù…Ø¯ Ø²ÙŠÙ† ÙˆÙ„Ø¯ Ù…Ø­Ù…Ø¯ ÙˆÙ„Ø¯ Ù…Ø®ØªØ§Ø±", code: "3344"}
];

function init() {
    const weeks = ["Ø§Ù„Ø£ÙˆÙ„","Ø§Ù„Ø«Ø§Ù†ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø«","Ø§Ù„Ø±Ø§Ø¨Ø¹","Ø§Ù„Ø®Ø§Ù…Ø³","Ø§Ù„Ø³Ø§Ø¯Ø³","Ø§Ù„Ø³Ø§Ø¨Ø¹","Ø§Ù„Ø«Ø§Ù…Ù†","Ø§Ù„ØªØ§Ø³Ø¹","Ø§Ù„Ø¹Ø§Ø´Ø±","Ø§Ù„Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ø´Ø±","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù…Ù† Ø¹Ø´Ø±","Ø§Ù„ØªØ§Ø³Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø¹Ø´Ø±ÙˆÙ†"];
    const wHtml = weeks.map(w => `<option value="Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}</option>`).join('');
    document.getElementById('bcWeek').innerHTML = wHtml;
    document.getElementById('gWeek').innerHTML = wHtml;

    db.ref('students').on('value', snap => {
        if(!snap.val()) { 
            manualData.forEach(s => {
                let cls = s.code.startsWith('33') ? "3/3" : (s.code.startsWith('31') ? "3/1" : "3/2");
                db.ref('students').push({...s, class: cls, records: []});
            });
        }
        students = snap.val() ? Object.entries(snap.val()).map(([id, v]) => ({...v, id})) : [];
        renderNamesGrid();
        renderAdminStudentSelect();
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    db.ref('staff/ibrahim').set({user:"ibrahim", pass:"ibrahim2026", role:"teacher", classes:"3/3"});
    db.ref('staff/saad').set({user:"saad", pass:"saad2026", role:"teacher", classes:"Ø§Ù„ÙƒÙ„"});
    db.ref('staff/admin').set({user:"admin", pass:"admin2026", role:"admin", classes:"Ø§Ù„ÙƒÙ„"});
    db.ref('staff/idarah').set({user:"idarah", pass:"idarah2026", role:"super", classes:"Ø§Ù„ÙƒÙ„"});

    db.ref('staff').on('value', snap => {
        const staff = snap.val() || {};
        document.getElementById('fullStaffList').innerHTML = Object.values(staff).map(s => `<p>ğŸ‘¤ ${s.user} | ğŸ”‘ ${s.pass} | ğŸ“‚ ${s.classes}</p>`).join('');
    });
}

function mainAuth() {
    const u = document.getElementById('entryKey').value.trim();
    const p = document.getElementById('entryPass').value.trim();
    const isS = !document.getElementById('staffSection').classList.contains('hidden');

    if(isS) {
        db.ref('staff').once('value', s => {
            const users = s.val();
            const found = Object.values(users).find(x => x.user === u && x.pass === p);
            if(found) {
                currentUser = found;
                showScreen('teacherDash');
                document.getElementById('roleDisplay').innerText = "Ø§Ù„Ù…Ø¹Ù„Ù…: " + found.user;
                if(found.role === 'admin' || found.role === 'super') document.getElementById('adminBtn').classList.remove('hidden');
                if(found.role === 'super') document.getElementById('idarahBtn').classList.remove('hidden');
                renderTabs();
            } else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        });
    } else {
        const std = students.find(x => x.code === u);
        if(std) setupStudentPage(std); else alert("ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­");
    }
}

function applyBroadcast() {
    sessionBroadcast = {
        week: document.getElementById('bcWeek').value,
        day: document.getElementById('bcDay').value,
        page: document.getElementById('bcPage').value
    };
    alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ù…ÙŠÙ…! ØªÙ„ÙˆÙ†Øª Ø£Ø³Ù…Ø§Ø¡ Ø·Ù„Ø§Ø¨ ÙØµÙ„Ùƒ Ø¨Ø§Ù„Ø£Ø¨ÙŠØ¶ (Ù…ØªØ§Ø­)");
    renderNamesGrid();
}

function renderNamesGrid() {
    const grid = document.getElementById('namesGrid'); grid.innerHTML = "";
    const search = document.getElementById('searchBox').value.toLowerCase();
    
    students.filter(s => s.class === selectedClass && s.name.toLowerCase().includes(search)).forEach(s => {
        const item = document.createElement('div');
        item.className = 'grid-item';
        
        let lastRec = (s.records || []).find(r => sessionBroadcast && r.week === sessionBroadcast.week && r.day === sessionBroadcast.day);
        
        if(lastRec) item.classList.add('status-' + lastRec.status.replace(" ", "-"));
        else if(sessionBroadcast) item.classList.add('status-Ù…ØªØ§Ø­');

        item.innerHTML = `<b>${s.name}</b><br><small>#${s.code}</small>`;
        item.onclick = () => {
            targetSID = s.id;
            document.getElementById('targetName').innerText = s.name;
            if(sessionBroadcast) {
                document.getElementById('gWeek').value = sessionBroadcast.week;
                document.getElementById('gDay').value = sessionBroadcast.day;
                document.getElementById('gPage').value = sessionBroadcast.page;
            }
            renderFullHistory(s);
            showScreen('gradeScreen');
        };
        grid.appendChild(item);
    });
}

function saveGrade() {
    const s = students.find(x => x.id === targetSID);
    if(!s.records) s.records = [];
    const rec = {
        week: document.getElementById('gWeek').value,
        day: document.getElementById('gDay').value,
        page: document.getElementById('gPage').value,
        status: document.getElementById('gStatus').value,
        timestamp: new Date().toISOString()
    };
    const oldIdx = s.records.findIndex(r => r.week === rec.week && r.day === rec.day);
    if(oldIdx > -1) {
        rec.originalStatus = s.records[oldIdx].status;
        s.records[oldIdx] = rec;
    } else s.records.push(rec);
    
    db.ref('students/'+s.id+'/records').set(s.records).then(() => {
        alert("ØªÙ… Ø§Ù„Ø±ØµØ¯!"); showScreen('teacherDash');
    });
}

function setupStudentPage(s) {
    showScreen('studentPage');
    document.getElementById('stdNameTitle').innerText = s.name;
    const lates = (s.records || []).filter(r => r.status !== "Ø­Ø§ÙØ¸");
    document.getElementById('lateCount').innerText = lates.length;
    document.getElementById('stdHistoryContainer').innerHTML = (s.records || []).slice().reverse().map(r => `
        <div class="history-item">
            <b>${r.week} - ${r.day}</b> | Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status} | ØµÙØ­Ø©: ${r.page}
            ${r.originalStatus ? `<br><span class="original-badge">Ø£ØµÙ„ Ø§Ù„Ø­Ø§Ù„Ø©: ${r.originalStatus}</span>` : ''}
        </div>`).join('');
}

function resetDatabase() {
    if(confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ©! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
        db.ref().remove().then(() => location.reload());
    }
}

function adminProcessUpdate() {
    const sid = document.getElementById('adminStudentSelect').value;
    db.ref('students/'+sid).update({
        name: document.getElementById('adminNewName').value,
        code: document.getElementById('adminNewCode').value,
        class: document.getElementById('adminNewClass').value
    }).then(() => alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"));
}

function toggleStaff() { document.getElementById('staffSection').classList.toggle('hidden'); }
function logout() { sessionBroadcast = null; location.reload(); }
function renderTabs() {
    const cls = ["3/1", "3/2", "3/3"];
    document.getElementById('classTabs').innerHTML = cls.filter(c => currentUser.classes === "Ø§Ù„ÙƒÙ„" || currentUser.classes === c).map(c => `<button class="btn" style="width:auto;" onclick="selectedClass='${c}';renderNamesGrid()">${c}</button>`).join('');
}
function showScreen(id) { 
    document.querySelectorAll('.card, #loginGate').forEach(d => d.classList.add('hidden')); 
    document.getElementById('app').classList.remove('hidden');
    document.getElementById(id).classList.remove('hidden'); 
}
function renderAdminStudentSelect() {
    document.getElementById('adminStudentSelect').innerHTML = students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
}
function loadAdminFields() {
    const s = students.find(x => x.id === document.getElementById('adminStudentSelect').value);
    document.getElementById('adminNewName').value = s.name;
    document.getElementById('adminNewCode').value = s.code;
    document.getElementById('adminNewClass').value = s.class;
}
function renderFullHistory(s) {
    document.getElementById('fullHistoryList').innerHTML = (s.records || []).slice().reverse().map(r => `<div class='history-item'>${r.week} - ${r.status}</div>`).join('');
}

init();
</script>
</body>
</html>
