<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ | ØªØ·ÙˆÙŠØ± ÙŠØ²Ù† ÙˆÙ…ØµØ·ÙÙ‰ ÙˆÙ…Ø­Ù…Ø¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --p: #1e4d2b; --g: #d4af37; --bg: #f4f7f6; --card: #ffffff; --txt: #333; }
        .t-blue { --p: #1a3a5f; --g: #00bcd4; --bg: #f0f4f8; --card: #ffffff; --txt: #222; }
        .t-dark { --p: #121212; --g: #bb86fc; --bg: #1e1e1e; --card: #2d2d2d; --txt: #eee; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--txt); margin: 0; padding: 10px; direction: rtl; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin: 15px auto; max-width: 550px; border-top: 5px solid var(--g); animation: slideIn 0.4s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .btn { padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin: 8px 0; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-p { background: var(--p); color: white; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid rgba(0,0,0,0.05); border-radius: 10px; background: rgba(0,0,0,0.02); color: inherit; text-align: center; font-size: 16px; outline: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; margin-top: 15px; }
        .grid-item { background: var(--p); color: white; padding: 10px; border-radius: 12px; cursor: pointer; font-size: 11px; height: 65px; display: flex; align-items: center; justify-content: center; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .progress-box { background: rgba(30, 77, 43, 0.05); border: 2px solid var(--p); border-radius: 15px; padding: 15px; margin: 15px 0; text-align: center; }
        .progress-box h1 { margin: 5px 0; color: var(--p); font-size: 35px; }
        .missing-box { background: #fff5f5; border: 1px dashed #e53935; color: #b71c1c; padding: 10px; border-radius: 10px; margin-bottom: 15px; font-size: 12px; }
        .honor-roll { background: linear-gradient(135deg, var(--p), var(--g)); color: white; padding: 10px; border-radius: 12px; margin-bottom: 15px; font-size: 13px; text-align: center; }
        .footer { font-size: 11px; opacity: 0.7; margin-top: 25px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 10px; text-align: center; }
        .hidden { display: none !important; }
        .theme-ball { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; }
    </style>
</head>
<body id="body">

<div id="app">
    <div id="mainMenu" class="card" style="margin-top: 50px;">
        <div style="display:flex; justify-content:center; gap:8px; margin-bottom:15px;">
            <div class="theme-ball" style="background:#1e4d2b" onclick="setTheme('')"></div>
            <div class="theme-ball" style="background:#1a3a5f" onclick="setTheme('t-blue')"></div>
            <div class="theme-ball" style="background:#121212" onclick="setTheme('t-dark')"></div>
        </div>
        <h2 style="color:var(--p)">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ ğŸ“š</h2>
        <input type="number" id="studentCode" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ø·Ø§Ù„Ø¨">
        <button class="btn btn-p" onclick="studentLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ / ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</button>
        <hr style="opacity: 0.2;">
        <button class="btn" style="background:#455a64; color:white; font-size: 13px;" onclick="showScreen('staffLogin')">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø£Ø³ØªØ§Ø°</button>
        <div class="footer">ØªØ·ÙˆÙŠØ± ÙØ±ÙŠÙ‚: ÙŠØ²Ù†ØŒ Ù…ØµØ·ÙÙ‰ØŒ Ù…Ø­Ù…Ø¯ <br> Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ: 0599804296</div>
    </div>

    <div id="studentPage" class="hidden card">
        <div class="honor-roll">
            ğŸ† <b>Ù„ÙˆØ­Ø© Ø§Ù„Ù€ 20 Ø§Ù„Ø£ÙˆØ§Ø¦Ù„:</b> <br>
            <marquee id="top20" scrollamount="3">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</marquee>
        </div>
        <h2 id="welcomeMsg" style="color:var(--p)"></h2>
        <div class="progress-box">
            <span>Ù…Ù‚Ø±Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (4 Ø£ÙˆØ¬Ù‡)</span>
            <h1 id="weekCounter">0 / 4</h1>
            <small id="currentWeekDisplay" style="font-weight: bold;"></small>
        </div>
        <div id="missingRecords" class="missing-box hidden">
            <b>âš ï¸ Ø¯Ø±ÙˆØ³ Ù„Ù… ØªÙØ­ÙØ¸ (Ø¯ÙŠÙ†):</b>
            <ul id="missingList" style="margin: 5px 0; padding-right: 15px;"></ul>
        </div>
        <h4>Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª:</h4>
        <div id="recordsList"></div>
        <button class="btn btn-p" onclick="showScreen('mainMenu')">Ø®Ø±ÙˆØ¬</button>
        <div class="footer">ØªØ·ÙˆÙŠØ± ÙØ±ÙŠÙ‚: ÙŠØ²Ù†ØŒ Ù…ØµØ·ÙÙ‰ØŒ Ù…Ø­Ù…Ø¯</div>
    </div>

    <div id="staffLogin" class="hidden card">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</h3>
        <input type="text" id="user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-p" onclick="staffAuth()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" onclick="showScreen('mainMenu')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="teacherDash" class="hidden card" style="max-width:850px;">
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° Ø³Ø¹Ø¯ ğŸ› ï¸</h3>
        <div style="background:#f0f4f1; padding:12px; border-radius:12px; margin-bottom:15px;">
            <label>Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„Ø¬Ù…ÙŠØ¹:</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="globalWeekNum" placeholder="Ù…Ø«Ù„Ø§Ù‹: 9" style="margin:0;">
                <button class="btn-p" style="padding:0 15px; border-radius:8px;" onclick="updateGlobalWeek()">ØªØ­Ø¯ÙŠØ«</button>
            </div>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="btn btn-p" onclick="loadClass('3/1')">ÙØµÙ„ 3/1</button>
            <button class="btn btn-p" onclick="loadClass('3/2')">ÙØµÙ„ 3/2</button>
        </div>
        <div id="namesGrid" class="grid"></div>
        <hr>
        <button class="btn" style="background:#c0392b; color:white" onclick="showScreen('mainMenu')">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <h3 id="targetName"></h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <input type="text" id="gDay" placeholder="Ø§Ù„ÙŠÙˆÙ…">
            <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
        </div>
        <input type="text" id="gMark" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©">
        <select id="gStatus">
            <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
            <option value="Ù„Ù… ÙŠØ­ÙØ¸">Ù„Ù… ÙŠØ­ÙØ¸ âš ï¸</option>
            <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
            <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
        </select>
        <div style="background:#f9f9f9; padding:10px; border-radius:10px; margin:5px 0;">
            <input type="checkbox" id="isLate"> <label for="isLate">Ø¯Ø±Ø³ Ù…ØªØ£Ø®Ø± (Ù„Ø§ ÙŠØ­Ø³Ø¨ ÙÙŠ Ø§Ù„Ø¹Ø¯Ø§Ø¯)</label>
        </div>
        <textarea id="gNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
        <button class="btn btn-p" onclick="saveGrade()">ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸</button>
        <button class="btn" onclick="showScreen('teacherDash')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div id="adminDash" class="hidden card">
        <h3>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h3>
        <div id="adminContent" style="text-align: right;"></div>
        <button class="btn btn-p" onclick="showScreen('mainMenu')">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script>
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ø¯Ù…Ø¬ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØªÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§
    const initialStudents = [
        {id:3278, name:"Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø­Ø§Ø±Ø«ÙŠ", code:3278, class:"3/2"},
        {id:3214, name:"Ø§Ù†Ø³ Ù…Ø­Ù…Ø¯ Ø¹ÙŠØ³Ù‰", code:3214, class:"3/2"},
        {id:3216, name:"Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ø­Ù…Ø¯", code:3216, class:"3/2"},
        {id:3210, name:"ÙŠØ²Ù† Ø§Ù†Ø³ Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠ", code:3210, class:"3/2"},
        {id:3101, name:"Ø§Ø­Ù…Ø¯ Ø¨ÙƒØ± Ø³ÙŠÙƒÙˆ Ø¬ÙŠØ§Ù†ÙŠ", code:3101, class:"3/1"},
        // ... (Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù€ 60 Ø·Ø§Ù„Ø¨Ø§Ù‹ Ø¢Ù„ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©)
    ];

    let students = [];
    let currentSID = null;
    let globalWeek = 1;

    db.ref('students').on('value', s => { 
        if(!s.exists()) db.ref('students').set(initialStudents);
        students = Object.values(s.val() || {});
        updateHonorRoll();
    });
    db.ref('settings/currentWeek').on('value', s => { globalWeek = parseInt(s.val()) || 1; });

    function setTheme(t) { document.getElementById('body').className = t; }

    function studentLogin() {
        const code = document.getElementById('studentCode').value;
        const s = students.find(x => x.code == code);
        if(s) {
            document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${s.name} ğŸŒ¿`;
            document.getElementById('currentWeekDisplay').innerText = `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${globalWeek}`;
            renderStudentRecords(s);
            showScreen('studentPage');
        } else alert('Ø§Ù„Ù…ÙØªØ§Ø­ Ø®Ø§Ø·Ø¦');
    }

    function staffAuth() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        if(u==='saad' && p==='12345678w') showScreen('teacherDash');
        else if(u==='admin' && p==='admin26') { renderAdmin(); showScreen('adminDash'); }
        else alert('Ø®Ø·Ø£!');
    }

    function loadClass(cls) {
        const grid = document.getElementById('namesGrid'); grid.innerHTML = "";
        students.filter(x => x.class === cls).forEach(s => {
            const div = document.createElement('div'); div.className = "grid-item"; div.innerText = s.name;
            div.onclick = () => { currentSID = s.id; document.getElementById('targetName').innerText = s.name; showScreen('gradeScreen'); };
            grid.appendChild(div);
        });
    }

    function updateGlobalWeek() {
        const val = document.getElementById('globalWeekNum').value;
        if(val) db.ref('settings/currentWeek').set(val).then(()=>alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«'));
    }

    function saveGrade() {
        const sIdx = students.findIndex(x => x.id == currentSID);
        const rec = { week: globalWeek, day: document.getElementById('gDay').value, page: document.getElementById('gPage').value, mark: document.getElementById('gMark').value, status: document.getElementById('gStatus').value, note: document.getElementById('gNote').value, isLate: document.getElementById('isLate').checked };
        if(!students[sIdx].records) students[sIdx].records = [];
        students[sIdx].records.unshift(rec);
        db.ref('students').set(students).then(() => { alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); showScreen('teacherDash'); });
    }

    function renderStudentRecords(s) {
        const weekRecs = (s.records || []).filter(r => r.week == globalWeek && !r.isLate && r.status === "Ø­Ø§ÙØ¸");
        document.getElementById('weekCounter').innerText = `${weekRecs.length} / 4`;
        
        const missing = (s.records || []).filter(r => r.status !== "Ø­Ø§ÙØ¸");
        const mBox = document.getElementById('missingRecords');
        if(missing.length > 0) {
            mBox.classList.remove('hidden');
            document.getElementById('missingList').innerHTML = missing.map(m => `<li>Ø£Ø³Ø¨ÙˆØ¹ ${m.week}: Øµ (${m.page}) - [${m.status}]</li>`).join('');
        } else mBox.classList.add('hidden');

        document.getElementById('recordsList').innerHTML = (s.records || []).map(r => `
            <div style="border-right:5px solid ${r.status==='Ø­Ø§ÙØ¸'?'#27ae60':'#c0392b'}; padding:10px; margin:5px 0; background:rgba(0,0,0,0.02); border-radius:10px;">
                <b>Ø£Ø³Ø¨ÙˆØ¹ ${r.week} - Øµ ${r.page}</b> ${r.isLate?'(Ù…ØªØ£Ø®Ø±)':''} | ${r.status}
            </div>
        `).join('');
    }

    function updateHonorRoll() {
        const sorted = [...students].sort((a,b) => (b.records?.filter(r=>r.status==='Ø­Ø§ÙØ¸').length || 0) - (a.records?.filter(r=>r.status==='Ø­Ø§ÙØ¸').length || 0));
        document.getElementById('top20').innerText = sorted.slice(0, 20).map((s, i) => `${i+1}. ${s.name}`).join(' | ');
    }

    function renderAdmin() {
        document.getElementById('adminContent').innerHTML = students.map(s => `<div>${s.name} - Ø§Ù„Ù…ÙØªØ§Ø­: <b>${s.code}</b></div>`).join('<hr>');
    }

    function showScreen(id) {
        document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
