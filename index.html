<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ v3.0 |Ø§Ù„Ù†Ø³Ø®Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ù„Ù‡</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --light: #f4f7f6;
            --dark: #1a1a2e;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --light: #1a1a2e;
            --white: #16213e;
            --primary: #e94560;
            --txt: #ffffff;
        }

        * { 
            box-sizing: border-box; 
            font-family: 'Tajawal', sans-serif; 
            transition: var(--transition); 
        }

        body { 
            background: var(--light); 
            color: var(--primary); 
            margin: 0; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            line-height: 1.6;
        }

        .card { 
            background: var(--white); 
            border-radius: 25px; 
            padding: 30px; 
            box-shadow: var(--shadow); 
            width: 100%; 
            max-width: 950px; 
            margin: 15px 0; 
            position: relative; 
            border: 1px solid rgba(0,0,0,0.05); 
            overflow: hidden;
        }

        .mustafa-tag { 
            color: var(--success); 
            font-weight: 700; 
            font-size: 14px; 
            text-align: center; 
            display: block; 
            margin: 15px 0; 
            border-bottom: 2px solid #f0f0f0; 
            padding-bottom: 10px;
            letter-spacing: 1px;
        }

        .btn { 
            padding: 15px 25px; 
            border: none; 
            border-radius: 15px; 
            cursor: pointer; 
            font-weight: 700; 
            width: 100%; 
            margin: 8px 0; 
            font-size: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn:active { transform: scale(0.98); }
        .btn-tech { background: linear-gradient(135deg, var(--success), #2ecc71); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #ff7675); color: white; }
        .btn-info { background: linear-gradient(135deg, var(--info), #81ecec); color: white; }
        .btn-back { 
            background: rgba(0,0,0,0.05); 
            color: var(--primary); 
            width: auto; 
            padding: 8px 20px; 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            z-index: 100; 
            border-radius: 10px; 
            font-size: 12px;
        }

        input, select, textarea { 
            width: 100%; 
            padding: 16px; 
            margin: 10px 0; 
            border-radius: 15px; 
            border: 2px solid #eee; 
            background: #fafafa; 
            font-size: 15px; 
            outline: none;
        }

        .hidden { display: none !important; }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-top: 25px; 
            width: 100%;
        }

        .grid-item { 
            background: var(--white); 
            padding: 25px; 
            border-radius: 20px; 
            text-align: center; 
            border: 2px solid #eef2f3; 
            cursor: pointer; 
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.02);
        }

        /* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ */
        .status-Ø­Ø§ÙØ¸ { background: #e8f5e9 !important; border-color: #2ecc71 !important; color: #1b5e20 !important; }
        .status-ØºÙŠØ±-Ø­Ø§ÙØ¸ { background: #fffde7 !important; border-color: #f1c40f !important; color: #f39c12 !important; }
        .status-ØºØ§Ø¦Ø¨ { background: #e3f2fd !important; border-color: #3498db !important; color: #0d47a1 !important; }
        .status-Ù„Ù…-ÙŠØ³Ù…Ø¹ { background: #ffebee !important; border-color: #e74c3c !important; color: #c0392b !important; }
        .status-Ù…Ø­Ø±ÙˆÙ… { background: #34495e !important; border-color: #2c3e50 !important; color: #ffffff !important; }
        .status-Ù…ØªØ§Ø­ { background: #ffffff !important; border-color: #cbd5e1 !important; }

        .history-item { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 15px; 
            border-right: 8px solid var(--success); 
            position: relative;
        }

        .original-badge { 
            background: var(--warning); 
            color: #fff; 
            padding: 4px 10px; 
            border-radius: 8px; 
            font-size: 11px; 
            margin-top: 10px; 
            display: inline-block; 
        }

        .guide-step { 
            background: #fff; 
            padding: 20px; 
            border-radius: 20px; 
            margin-bottom: 25px; 
            border-left: 6px solid var(--info);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        footer { 
            margin-top: 50px; 
            padding: 30px; 
            text-align: center; 
            border-top: 2px solid #eee; 
            width: 100%; 
            color: #7f8c8d;
        }
    </style>
</head>
<body>

<div id="loginGate" class="card">
    <div class="mustafa-tag">| Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ù‡ v3.0 |</div>
    <div style="text-align:center; margin-bottom: 30px;">
        <img src="https://cdn-icons-png.flaticon.com/512/2602/2602414.png" width="90" alt="Logo">
        <h2 style="margin-top:15px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… ğŸ›¡ï¸</h2>
    </div>

    <input type="text" id="entryKey" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
    <div id="staffSection" class="hidden">
        <input type="password" id="entryPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>

    <button class="btn btn-tech" onclick="mainAuth()">ğŸš€ Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† Ù„Ù„Ù†Ø¸Ø§Ù…</button>
    <button class="btn" style="background:transparent; color:var(--primary);" onclick="toggleStaff()">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ø¯Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ / Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
</div>

<div id="app" class="hidden" style="width:100%; max-width:950px;">
    
    <div id="teacherDash" class="hidden card">
        <button class="btn btn-back" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        <div id="roleDisplay" class="mustafa-tag"></div>

        <div id="broadcastPanel" class="card" style="background:#fff9e6; border:1px solid #ffeaa7;">
            <h4 style="margin: 0 0 10px 0;">ğŸ“¢ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ÙØµÙ„</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
                <select id="bcWeek"></select>
                <select id="bcDay">
                    <option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
                </select>
                <input type="number" id="bcPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
            </div>
            <button class="btn btn-info" onclick="applyBroadcast()">ØªØ¹Ù…ÙŠÙ… Ø­Ø§Ù„Ø© (Ù…ØªØ§Ø­) Ù„Ù„ÙØµÙ„</button>
        </div>

        <div id="classTabs" style="display:flex; gap:10px; margin:20px 0; flex-wrap: wrap;"></div>
        <input type="text" id="searchBox" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." oninput="renderNamesGrid()">
        <div id="namesGrid" class="grid"></div>
        
        <div id="teacherGuide" class="guide-step" style="margin-top:30px;">
            <h4>ğŸ“– Ø´Ø±Ø­ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ù…Ø¹Ù„Ù…:</h4>
            <ul>
                <li><b>Ø§Ù„Ø±ØµØ¯:</b> Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ØŒ Ø³ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŒ Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ø­ÙØ¸.</li>
                <li><b>Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:</b> Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø·Ø§Ù„Ø¨ Ù…Ø±ØµÙˆØ¯ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬ØªÙ‡ Ø£Ùˆ Ø­Ø°ÙÙ‡Ø§.</li>
                <li><b>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</b> ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ØŒ ÙˆØ³ØªØ¸Ù„ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©.</li>
                <li><b>Ø§Ù„ØªØ¹Ù…ÙŠÙ…:</b> Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„Ù‡ØŒ ØªØªÙ„ÙˆÙ† ÙƒÙ„ Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª Ø¨Ø§Ù„Ø£Ø¨ÙŠØ¶ ÙˆÙŠØ³Ù‡Ù„ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø±ØµØ¯.</li>
            </ul>
        </div>

        <div id="passwordPanel" class="card" style="margin-top:20px; background:#f0fdf4;">
            <h4 style="margin:0 0 10px 0;">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</h4>
            <div style="display:flex; gap:10px;">
                <input type="password" id="newSelfPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                <button class="btn btn-tech" style="width:auto;" onclick="changeMyPass()">ØªØ­Ø¯ÙŠØ«</button>
            </div>
        </div>

        <button id="adminBtn" class="btn hidden" style="background:var(--primary); color:white; margin-top:20px;" onclick="showScreen('adminPage')">ğŸ‘‘ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        <button id="idarahBtn" class="btn hidden" style="background:black; color:white;" onclick="showScreen('idarahPage')">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… idarah</button>
    </div>

    <div id="idarahPage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h2>âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ (idarah)</h2>
        <div class="card">
            <h4>ğŸ‘¥ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ¨Ø§Ø³ÙˆØ±Ø¯Ø§ØªÙ‡Ù…</h4>
            <div id="staffAuditList"></div>
        </div>
        <div class="card" style="background:#fff1f1;">
            <h4 style="color:var(--danger)">âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h4>
            <button class="btn btn-danger" onclick="clearFirebase()">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ©</button>
        </div>
    </div>

    <div id="adminPage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h2>ğŸ¢ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
        <div class="card">
            <h4>ğŸ”„ ØªØ¹Ø¯ÙŠÙ„ / Ù†Ù‚Ù„ Ø·Ø§Ù„Ø¨</h4>
            <select id="adminStudentSelect" onchange="loadAdminFields()"></select>
            <input type="text" id="adminNewName" placeholder="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…">
            <input type="text" id="adminNewCode" placeholder="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯">
            <select id="adminNewClass">
                <option>3/1</option><option>3/2</option><option>3/3</option>
            </select>
            <button class="btn btn-tech" onclick="adminUpdateStudent()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
        <button class="btn btn-info" onclick="generateReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ÙØµÙ„</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3 id="targetName" style="color:var(--success)"></h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <select id="gWeek"></select>
            <select id="gDay">
                <option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
            </select>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
            <input type="number" id="gMark" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ù† 7">
        </div>
        <select id="gStatus">
            <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
            <option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
            <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
            <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option>
            <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
        </select>
        <textarea id="gNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
        <button class="btn btn-tech" onclick="saveGrade()">ğŸ’¾ Ø­ÙØ¸ ÙˆØ±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø©</button>
        <div id="fullHistoryList"></div>
    </div>

    <div id="studentPage" class="hidden card">
        <button class="btn btn-back" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <h2 id="stdNameTitle"></h2>
        <div class="guide-step" style="border-right: 10px solid var(--danger);">
            <h4>ğŸ“‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</h4>
            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª: <span id="lateCount" style="font-weight:bold; color:var(--danger);">0</span> Ø¯Ø±Ø³</p>
            <p style="font-size:12px; color:#666;">* Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª Ù‡ÙŠ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„ØªÙŠ Ø­Ø§Ù„ØªÙ‡Ø§ Ù„ÙŠØ³Øª (Ø­Ø§ÙØ¸).</p>
        </div>
        <div class="guide-step" style="background:#eef2f3;">
            <h4>ğŸ“š Ø´Ø±Ø­ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª:</h4>
            <ul>
                <li><b>Ø­Ø§ÙØ¸:</b> Ø³Ù…Ø¹Øª Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­.</li>
                <li><b>Ù„Ù… ÙŠØ³Ù…Ø¹:</b> Ù„Ù… ØªØ³Ù…Ø¹ Ø§Ù„Ø¯Ø±Ø³ Ù…Ø·Ù„Ù‚Ø§Ù‹.</li>
                <li><b>ØºØ§Ø¦Ø¨:</b> Ù„Ù… ØªÙƒÙ† Ù…ØªÙˆØ§Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­ØµØ©.</li>
                <li><b>ØºÙŠØ± Ø­Ø§ÙØ¸:</b> Ø³Ù…Ø¹Øª ÙˆÙ„ÙƒÙ† Ù„Ø¯ÙŠÙƒ Ø£Ø®Ø·Ø§Ø¡ Ù…Ù†Ø¹ØªÙƒ Ù…Ù† Ø§Ù„Ø§Ø¬ØªÙŠØ§Ø².</li>
                <li><b>Ù…Ø­Ø±ÙˆÙ…:</b> Ø¹Ù‚ÙˆØ¨Ø© Ù„Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† ØªÙ…Ù†Ø¹Ùƒ Ù…Ù† Ø§Ù„ØªØ³Ù…ÙŠØ¹.</li>
            </ul>
        </div>
        <div id="stdHistoryContainer"></div>
    </div>

</div>

<footer>ØªØ·ÙˆÙŠØ± Ùˆ ØªÙ†Ø³ÙŠÙ‚ Ùˆ Ø¨Ø±Ù…Ø¬Ù‡: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯| ÙŠØ²Ù† Ø§Ù†Ø³ Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠ |Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ| 0599804296</footer>

<script>
const firebaseConfig = { 
    apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", 
    databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let students = [], currentUser = null, targetSID = null, selectedClass = "3/3", broadcast = null;

const initialData = [
    {name: "Ø§Ø­Ù…Ø¯ Ø¹Ù…Ø± Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3326"}, {name: "Ø¨Ø³Ø§Ù… Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3370"},
    {name: "Ø¨Ø´Ø§Ø± Ø±Ø§Ù…Ø² ÙƒÙ†Ø¹Ø§Ù†", code: "3355"}, {name: "ØªÙ…ÙŠÙ… Ù†ÙˆØ± Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3309"},
    {name: "Ø­Ø³ÙŠÙ† Ø¹Ø¨Ø¯Ø§Ù„ÙƒØ±ÙŠÙ… Ø¨Ù† Ø¨Ø§Ø¯ÙŠ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3358"}, {name: "Ø®Ø§Ù„Ø¯ Ø³Ù„ÙŠÙ… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3393"},
    {name: "Ø±Ø§Ø¦Ø¯ ÙØ§ÙŠØ² Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ", code: "3301"}, {name: "Ø±ÙŠØ§Ù† Ø¹Ø·Ø§Ù„Ù„Ù‡ Ø¹Ø¨ÙŠØ§Ù† Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3389"},
    {name: "Ø³Ø§Ù…Ø± Ø¹Ù…Ø± Ø¨Ù† Ø¯Ø®ÙŠÙ„ Ø§Ù„Ù„Ù‡ Ø§Ù„ØµØ§Ø¹Ø¯ÙŠ", code: "3259"}, {name: "Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3302"},
    {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ", code: "3357"}, {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø£Ù…ÙŠÙ† Ø­Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙƒÙŠ", code: "3392"},
    {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø¤Ù…Ù† Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„Ø´Ù‡ÙŠØ¯", code: "3379"}, {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù†Ø§ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ø¬Ù†ÙŠ", code: "3304"},
    {name: "Ø¹Ù…Ø§Ø± Ø£Ø­Ù…Ø¯ Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3399"}, {name: "Ø¹Ù…Ø± Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£Ù…ÙŠÙ† â€“ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø´ÙŠØ±", code: "3310"},
    {name: "ØºØ§Ù†Ù… ØµÙ„Ø§Ø­ ØºØ§Ù†Ù… Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3391"}, {name: "ÙØ±Ø§Ø³ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3322"},
    {name: "ÙÙ‡Ø¯ Ù…Ø­Ù…Ø¯ ÙˆØµÙ„ Ø§Ù„Ø²Ø±ÙØ§Ù†ÙŠ", code: "3300"}, {name: "ÙÙŠØµÙ„ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ø§Ø·Ø± Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ", code: "3366"},
    {name: "ÙÙŠØµÙ„ Ø­Ø³Ø§Ù… Ø§Ù„Ø¯ÙŠÙ† â€“ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙ†", code: "3311"}, {name: "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3349"},
    {name: "Ù…Ø®ØªØ§Ø± Ø­Ù…ÙˆØ¯ ÙˆØ§Ù„Ù…Ø­Ù…Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±", code: "3360"}, {name: "Ù…Ø®ØªØ§Ø± Ø±Ø¨ÙŠØ¹ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆÙ„Ø¯ Ø§Ø¨Ø§Ù‡", code: "3365"},
    {name: "Ù…ØµØ·ÙÙ‰ Ù…Ø®ØªØ§Ø± Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø®ØªØ§Ø±", code: "3396"}, {name: "Ù…Ø¤ÙŠØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ù‚ÙˆÙŠÙ… Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ù‡Ù†Ø¯ÙŠ", code: "3387"},
    {name: "Ù†ÙˆØ§Ù Ø¹Ù…Ø± Ø¨Ù† Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ", code: "3395"}, {name: "Ù‡Ø§Ø´Ù… Ø£Ø­Ù…Ø¯ Ø¨Ù† ØµØ§Ù„Ø­ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡", code: "3388"},
    {name: "ÙŠØ­ÙŠÙ‰ Ø£Ø­Ù…Ø¯ Ø²ÙŠÙ† ÙˆÙ„Ø¯ Ù…Ø­Ù…Ø¯ ÙˆÙ„Ø¯ Ù…Ø®ØªØ§Ø±", code: "3344"}
];

function init() {
    const weeks = ["Ø§Ù„Ø£ÙˆÙ„","Ø§Ù„Ø«Ø§Ù†ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø«","Ø§Ù„Ø±Ø§Ø¨Ø¹","Ø§Ù„Ø®Ø§Ù…Ø³","Ø§Ù„Ø³Ø§Ø¯Ø³","Ø§Ù„Ø³Ø§Ø¨Ø¹","Ø§Ù„Ø«Ø§Ù…Ù†","Ø§Ù„ØªØ§Ø³Ø¹","Ø§Ù„Ø¹Ø§Ø´Ø±","Ø§Ù„Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ø´Ø±","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù…Ù† Ø¹Ø´Ø±","Ø§Ù„ØªØ§Ø³Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„ÙˆØ§Ø­Ø¯ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù„Ø« ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø±Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø®Ø§Ù…Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø³Ø§Ø¯Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø³Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù…Ù† ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„ØªØ§Ø³Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†"];
    const wHtml = weeks.map(w => `<option value="Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}</option>`).join('');
    document.getElementById('bcWeek').innerHTML = wHtml;
    document.getElementById('gWeek').innerHTML = wHtml;

    db.ref('students').on('value', snap => {
        if(!snap.val()) {
            initialData.forEach(s => {
                let cls = s.code.startsWith('33') ? "3/3" : (s.code.startsWith('31') ? "3/1" : "3/2");
                db.ref('students').push({...s, class: cls, records: []});
            });
        }
        students = snap.val() ? Object.entries(snap.val()).map(([id, v]) => ({...v, id})) : [];
        renderNamesGrid();
        renderAdminStudentSelect();
    });

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    db.ref('staff/ibrahim').update({user:"ibrahim", pass:"ibrahim2026", role:"teacher", classes:"3/3"});
    db.ref('staff/saad').update({user:"saad", pass:"saad2026", role:"teacher", classes:"Ø§Ù„ÙƒÙ„"});
    db.ref('staff/admin').update({user:"admin", pass:"admin2026", role:"admin", classes:"Ø§Ù„ÙƒÙ„"});
    db.ref('staff/idarah').update({user:"idarah", pass:"idarah2026", role:"super", classes:"Ø§Ù„ÙƒÙ„"});

    db.ref('staff').on('value', snap => {
        const staff = snap.val() || {};
        document.getElementById('staffAuditList').innerHTML = Object.values(staff).map(s => `<p>ğŸ‘¤ ${s.user} | ğŸ”‘ ${s.pass}</p>`).join('');
    });
}

function mainAuth() {
    const u = document.getElementById('entryKey').value.trim();
    const p = document.getElementById('entryPass').value.trim();
    const isS = !document.getElementById('staffSection').classList.contains('hidden');

    if(isS) {
        db.ref('staff').once('value', s => {
            const users = s.val();
            const found = Object.values(users).find(x => x.user === u && x.pass === p);
            if(found) {
                currentUser = found;
                showScreen('teacherDash');
                document.getElementById('roleDisplay').innerText = "Ø§Ù„Ù…Ø¹Ù„Ù…: " + found.user;
                if(found.role === 'admin' || found.role === 'super') document.getElementById('adminBtn').classList.remove('hidden');
                if(found.role === 'super') document.getElementById('idarahBtn').classList.remove('hidden');
                renderTabs();
            } else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        });
    } else {
        const std = students.find(x => x.code === u);
        if(std) setupStudentPage(std); else alert("ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­");
    }
}

function applyBroadcast() {
    broadcast = {
        week: document.getElementById('bcWeek').value,
        day: document.getElementById('bcDay').value,
        page: document.getElementById('bcPage').value
    };
    alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ù…ÙŠÙ…! ØªÙ„ÙˆÙ†Øª Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø§Ù„Ø£Ø¨ÙŠØ¶ (Ù…ØªØ§Ø­)");
    renderNamesGrid();
}

function renderNamesGrid() {
    const grid = document.getElementById('namesGrid'); grid.innerHTML = "";
    const search = document.getElementById('searchBox').value.toLowerCase();
    
    students.filter(s => s.class === selectedClass && s.name.toLowerCase().includes(search)).forEach(s => {
        const item = document.createElement('div');
        item.className = 'grid-item';
        
        let todayRec = (s.records || []).find(r => broadcast && r.week === broadcast.week && r.day === broadcast.day);
        
        if(todayRec) item.classList.add('status-' + todayRec.status.replace(" ", "-"));
        else if(broadcast) item.classList.add('status-Ù…ØªØ§Ø­');

        item.innerHTML = `<b>${s.name}</b><br><small>#${s.code}</small>`;
        item.onclick = () => openGrade(s);
        grid.appendChild(item);
    });
}

function openGrade(s) {
    targetSID = s.id;
    document.getElementById('targetName').innerText = s.name;
    if(broadcast) {
        document.getElementById('gWeek').value = broadcast.week;
        document.getElementById('gDay').value = broadcast.day;
        document.getElementById('gPage').value = broadcast.page;
    }
    renderFullHistory(s);
    showScreen('gradeScreen');
}

function saveGrade() {
    const s = students.find(x => x.id === targetSID);
    if(!s.records) s.records = [];
    const rec = {
        week: document.getElementById('gWeek').value,
        day: document.getElementById('gDay').value,
        page: document.getElementById('gPage').value,
        mark: document.getElementById('gMark').value,
        status: document.getElementById('gStatus').value,
        note: document.getElementById('gNote').value
    };
    const oldIdx = s.records.findIndex(r => r.week === rec.week && r.day === rec.day);
    if(oldIdx > -1) {
        rec.originalStatus = s.records[oldIdx].status;
        s.records[oldIdx] = rec;
    } else s.records.push(rec);
    
    db.ref('students/'+s.id+'/records').set(s.records).then(() => {
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸!"); renderNamesGrid(); showScreen('teacherDash');
    });
}

function setupStudentPage(s) {
    showScreen('studentPage');
    document.getElementById('stdNameTitle').innerText = s.name;
    const lates = (s.records || []).filter(r => r.status !== "Ø­Ø§ÙØ¸");
    document.getElementById('lateCount').innerText = lates.length;
    document.getElementById('stdHistoryContainer').innerHTML = (s.records || []).slice().reverse().map(r => `
        <div class="history-item">
            <b>${r.week} - ${r.day}</b> | Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status} | ØµÙØ­Ø©: ${r.page}
            ${r.originalStatus ? `<br><span class="original-badge">Ø£ØµÙ„ Ø§Ù„Ø­Ø§Ù„Ø©: ${r.originalStatus}</span>` : ''}
        </div>`).join('');
}

function changeMyPass() {
    const p = document.getElementById('newSelfPass').value;
    if(p.length < 4) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©");
    db.ref('staff/'+currentUser.user+'/pass').set(p).then(() => alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"));
}

function clearFirebase() {
    if(confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
        db.ref('students').remove().then(() => location.reload());
    }
}

function adminUpdateStudent() {
    const sid = document.getElementById('adminStudentSelect').value;
    db.ref('students/'+sid).update({
        name: document.getElementById('adminNewName').value,
        code: document.getElementById('adminNewCode').value,
        class: document.getElementById('adminNewClass').value
    }).then(() => alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"));
}

function toggleStaff() { document.getElementById('staffSection').classList.toggle('hidden'); }
function logout() { broadcast = null; location.reload(); }
function showScreen(id) { 
    document.querySelectorAll('.card, #loginGate').forEach(d => d.classList.add('hidden')); 
    document.getElementById('app').classList.remove('hidden');
    document.getElementById(id).classList.remove('hidden'); 
}
function renderTabs() {
    const cls = ["3/1", "3/2", "3/3"];
    document.getElementById('classTabs').innerHTML = cls.filter(c => currentUser.classes === "Ø§Ù„ÙƒÙ„" || currentUser.classes === c).map(c => `<button class="btn" style="width:auto; background:${selectedClass===c?'var(--success)':'#eee'}; color:${selectedClass===c?'white':'black'}" onclick="selectedClass='${c}';renderNamesGrid()">${c}</button>`).join('');
}
function renderAdminStudentSelect() {
    document.getElementById('adminStudentSelect').innerHTML = students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
}
function loadAdminFields() {
    const s = students.find(x => x.id === document.getElementById('adminStudentSelect').value);
    document.getElementById('adminNewName').value = s.name;
    document.getElementById('adminNewCode').value = s.code;
    document.getElementById('adminNewClass').value = s.class;
}
function renderFullHistory(s) {
    document.getElementById('fullHistoryList').innerHTML = (s.records || []).slice().reverse().map((r, i) => `
        <div class="history-item">
            ${r.week} | ${r.status} | <button onclick="deleteRec(${s.records.length-1-i})">Ø­Ø°Ù</button>
        </div>`).join('');
}
function deleteRec(idx) {
    const s = students.find(x => x.id === targetSID);
    s.records.splice(idx, 1);
    db.ref('students/'+targetSID+'/records').set(s.records).then(() => renderFullHistory(s));
}

init();
</script>
</body>
</html>
