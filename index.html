<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ | ØªØ·ÙˆÙŠØ± Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #f4f7f6; --card: #ffffff; --p: #2c3e50; --g: #27ae60; --txt: #2c3e50; }
        .theme-black { --bg: #0a0a0a; --card: #1a1a1a; --g: #00ffcc; --txt: #e0f2f1; }
        .theme-blue { --bg: #001a33; --card: #002b55; --g: #00d4ff; --txt: #ffffff; }
        .theme-green { --bg: #e8f5e9; --card: #ffffff; --g: #2e7d32; --txt: #1b5e20; }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--txt); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 700px; margin: 10px 0; position: relative; border: 1px solid rgba(0,0,0,0.05); }
        .mustafa-tag { color: var(--g); font-weight: bold; font-size: 13px; text-align: center; display: block; margin: 10px 0; text-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .btn { padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-tech { background: var(--g); color: white; }
        .btn-back { background: rgba(0,0,0,0.1); color: var(--txt); width: auto; padding: 5px 15px; font-size: 12px; position: absolute; top: 10px; right: 10px; z-index: 100; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; background: rgba(255,255,255,0.9); color: #333; }
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .grid-item { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid var(--g); cursor: pointer; font-weight: bold; }
        .history-item { background: rgba(0,0,0,0.03); padding: 15px; border-radius: 15px; margin-bottom: 10px; border-right: 5px solid var(--g); position: relative; }
        footer { margin-top: auto; text-align: center; font-size: 11px; padding: 20px; color: #888; width: 100%; }
        .theme-selector { display: flex; gap: 8px; justify-content: center; margin-bottom: 15px; }
        .theme-dot { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .badge-missed { background: #ff5252; color: white; padding: 5px 15px; border-radius: 50px; font-size: 13px; cursor: pointer; display: inline-block; margin-bottom: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="loginGate" class="card">
    <div class="theme-selector">
        <div class="theme-dot" style="background:#f4f7f6;" onclick="setTheme('default')"></div>
        <div class="theme-dot" style="background:#e8f5e9;" onclick="setTheme('green')"></div>
        <div class="theme-dot" style="background:#001a33;" onclick="setTheme('blue')"></div>
        <div class="theme-dot" style="background:#0a0a0a;" onclick="setTheme('black')"></div>
    </div>
    <div class="mustafa-tag">| ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„: ØªØ·ÙˆÙŠØ± ÙˆØ¨Ø±Ù…Ø¬Ø© Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ | ÙŠØ²Ù† Ø£Ù†Ø³ & Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ | Ø£ÙÙƒØ§Ø± ÙˆØªØµÙ…ÙŠÙ… |</div>
    <h2 style="text-align:center;">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠØ© ğŸ›¡ï¸</h2>
    <input type="text" id="entryKey" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯Ø®ÙˆÙ„">
    <div id="staffSection" class="hidden">
        <input type="password" id="entryPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    </div>
    <button class="btn btn-tech" onclick="mainAuth()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    <button id="staffBtn" class="btn" style="background:transparent; color:var(--g);" onclick="toggleStaff()">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ø¯Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</button>
    <button id="backToStudent" class="btn hidden" style="background:transparent; color:var(--g);" onclick="toggleStaff()">Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
</div>

<div id="app" class="hidden" style="width:100%; max-width:700px;">
    
    <div id="studentPage" class="hidden card">
        <button class="btn btn-back" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <div class="mustafa-tag">Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡</div>
        <h3 id="welcomeMsg"></h3>
        
        <div id="missedCounterContainer" class="hidden" style="text-align: center;">
            <div class="badge-missed" onclick="toggleMissedDetails()">
                âš ï¸ Ù„Ø¯ÙŠÙƒ <span id="missedCount">0</span> Ø¯Ø±ÙˆØ³ Ù„Ù… ØªÙØ³Ù…Ø¹ (Ø§Ù†Ù‚Ø± Ù„Ù„ØªÙØ§ØµÙŠÙ„)
            </div>
            <div id="missedDetails" class="hidden" style="background:rgba(255,82,82,0.1); padding:10px; border-radius:10px; margin-bottom:15px; font-size:12px;"></div>
        </div>

        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <button class="btn btn-tech" onclick="showTopTen()">ğŸ† Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</button>
            <button class="btn btn-tech" onclick="showTerms()">ğŸ“– Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª</button>
        </div>
        
        <div id="dynamicContent" class="hidden" style="background:rgba(0,0,0,0.02); padding:15px; border-radius:15px; margin-bottom:20px; border:1px dashed var(--g);"></div>

        <h4>Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</h4>
        <div id="recordsList"></div>
    </div>

    <div id="teacherDash" class="hidden card">
        <button class="btn btn-back" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <div class="mustafa-tag">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° Ø³Ø¹Ø¯ - ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø·Ù„Ù‚Ø©</div>
        <input type="text" id="searchBox" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." oninput="filterGrid()">
        <div style="display:flex; gap:10px; margin:10px 0;">
            <button class="btn btn-tech" onclick="loadClass('3/1')">ÙØµÙ„ 3/1</button>
            <button class="btn btn-tech" onclick="loadClass('3/2')">ÙØµÙ„ 3/2</button>
        </div>
        <div id="namesGrid" class="grid"></div>
        <button class="btn" style="background:#444; color:white; margin-top:15px;" onclick="showManageStudents()">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø£ÙƒÙˆØ§Ø¯</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3 id="targetName"></h3>
        <div style="display:flex; align-items:center; gap:10px; background:rgba(0,0,0,0.05); padding:10px; border-radius:10px;">
            <input type="checkbox" id="isLate" style="width:20px;"> <label>Ø¯ÙØ±Ø³ Ù…ÙØªØ£Ø®Ø± (ÙŠØ¶Ø§Ù Ù„Ù„Ù…ØªØ£Ø®Ø±Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠØ­ÙØ¸)</label>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <select id="gWeek"></select>
            <select id="gDay">
                <option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
            </select>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
            <input type="number" id="gMark" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ù† 7" max="7">
        </div>
        <select id="gStatus">
            <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
            <option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
            <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
            <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option>
            <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
        </select>
        <textarea id="gNote" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±..."></textarea>
        <button class="btn btn-tech" id="saveBtn" onclick="saveGrade()">Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¢Ù†</button>
        <hr>
        <div id="editHistory"></div>
    </div>

    <div id="manageStudentsPage" class="hidden card">
        <button class="btn btn-back" id="backFromManage">Ø±Ø¬ÙˆØ¹</button>
        <h3>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
        <input type="text" id="newSName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
        <input type="text" id="newSCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„">
        <select id="newSClass"><option value="3/1">3/1</option><option value="3/2">3/2</option></select>
        <button class="btn btn-tech" onclick="addNewStudent()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        <div id="fullList" style="margin-top:20px;"></div>
    </div>
</div>

<footer>
    <b>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ: 0599804296</b><br>Ø¨Ø±Ù…Ø¬Ø©: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡
</footer>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let students = []; let currentSID = null; let userRole = '';

    const weeksArr = ["Ø§Ù„Ø£ÙˆÙ„","Ø§Ù„Ø«Ø§Ù†ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø«","Ø§Ù„Ø±Ø§Ø¨Ø¹","Ø§Ù„Ø®Ø§Ù…Ø³","Ø§Ù„Ø³Ø§Ø¯Ø³","Ø§Ù„Ø³Ø§Ø¨Ø¹","Ø§Ù„Ø«Ø§Ù…Ù†","Ø§Ù„ØªØ§Ø³Ø¹","Ø§Ù„Ø¹Ø§Ø´Ø±","Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ø´Ø±","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù…Ù† Ø¹Ø´Ø±","Ø§Ù„ØªØ§Ø³Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø­Ø§Ø¯ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù„Ø« ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø±Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø®Ø§Ù…Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø³Ø§Ø¯Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø³Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù…Ù† ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„ØªØ§Ø³Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†"];
    document.getElementById('gWeek').innerHTML = weeksArr.map(w => `<option value="Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}</option>`).join('');

    function setTheme(t) { document.body.className = 'theme-' + t; localStorage.setItem('userTheme', t); }
    if(localStorage.getItem('userTheme')) setTheme(localStorage.getItem('userTheme'));

    function toggleStaff() {
        document.getElementById('staffSection').classList.toggle('hidden');
        document.getElementById('staffBtn').classList.toggle('hidden');
        document.getElementById('backToStudent').classList.toggle('hidden');
    }

    function mainAuth() {
        const key = document.getElementById('entryKey').value.trim();
        const pass = document.getElementById('entryPass').value.trim();
        db.ref('students').once('value', s => {
            students = s.exists() ? Object.values(s.val()) : [];
            if(key === 'saad' && pass === 'saad2026') { userRole = 'saad'; showScreen('teacherDash'); }
            else {
                const std = students.find(x => x.code === key);
                if(std) { currentSID = std.id; userRole = 'student'; showScreen('studentPage'); renderStudentRecords(std); }
                else alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©!');
            }
        });
    }

    function showScreen(id) {
        document.getElementById('loginGate').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'studentPage') document.getElementById('dynamicContent').classList.add('hidden');
    }

    function renderStudentRecords(s) {
        document.getElementById('welcomeMsg').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ " + s.name;
        const recs = s.records || [];
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª
        const missed = recs.filter(r => r.status !== 'Ø­Ø§ÙØ¸');
        const counter = document.getElementById('missedCounterContainer');
        if(missed.length > 0) {
            counter.classList.remove('hidden');
            document.getElementById('missedCount').innerText = missed.length;
            document.getElementById('missedDetails').innerHTML = "<b>Ø¯Ø±ÙˆØ³ ØªØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ¹:</b><br>" + 
                missed.map(m => `â€¢ ${m.week} (${m.day}) - Ø§Ù„Ø­Ø§Ù„Ø©: ${m.status}`).join('<br>');
        } else {
            counter.classList.add('hidden');
        }

        document.getElementById('recordsList').innerHTML = recs.map(r => `
            <div class="history-item">
                <div style="display:flex; justify-content:space-between"><b>${r.week} - ${r.day}</b> <span>Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.mark || 0}/7</span></div>
                <small>Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©: ${r.page}</small> | <b>Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status}</b>
                ${r.prevStatus ? `<div style="color:orange; font-size:11px;">(Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: ${r.prevStatus})</div>` : ''}
                <div style="font-size:11px; color:#777;">${r.note || ''}</div>
            </div>
        `).reverse().join('');
    }

    function toggleMissedDetails() {
        document.getElementById('missedDetails').classList.toggle('hidden');
    }

    // Ø§Ù„Ø£ÙˆØ§Ø¦Ù„
    function showTopTen() {
        const dyn = document.getElementById('dynamicContent');
        dyn.classList.remove('hidden');
        
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
        const sorted = students.map(s => {
            const total = (s.records || []).reduce((sum, r) => sum + (parseFloat(r.mark) || 0), 0);
            return { name: s.name, score: total };
        }).sort((a, b) => b.score - a.score).slice(0, 10);

        dyn.innerHTML = "<h3>ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h3>" + 
            sorted.map((s, i) => `<div>${i+1}. ${s.name} - Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${s.score}</div>`).join('') +
            `<button class="btn" onclick="this.parentElement.classList.add('hidden')">Ø¥ØºÙ„Ø§Ù‚</button>`;
    }

    // Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª
    function showTerms() {
        const dyn = document.getElementById('dynamicContent');
        dyn.classList.remove('hidden');
        dyn.innerHTML = `
            <h3>ğŸ“– Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª</h3>
            <p><b>ØºØ§Ø¦Ø¨:</b> Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù… ÙŠØ­Ø¶Ø± Ø§Ù„Ø­Ù„Ù‚Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.</p>
            <p><b>Ù„Ù… ÙŠØ³Ù…Ø¹:</b> Ø§Ù„Ø·Ø§Ù„Ø¨ Ø­Ø¶Ø± ÙˆÙ„ÙƒÙ†Ù‡ Ù„Ù… ÙŠØªÙ‚Ø¯Ù… Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±.</p>
            <p><b>ØºÙŠØ± Ø­Ø§ÙØ¸:</b> Ø§Ù„Ø·Ø§Ù„Ø¨ Ø³Ù…Ø¹ ÙˆÙ„ÙƒÙ† Ø£Ø®Ø·Ø§Ø¤Ù‡ ÙƒØ«ÙŠØ±Ø© ÙˆÙ„Ù… ÙŠØ¬ØªØ².</p>
            <p><b>Ù…Ø­Ø±ÙˆÙ…:</b> Ø¹Ù‚ÙˆØ¨Ø© Ø¥Ø¯Ø§Ø±ÙŠØ© Ù„Ø¹Ø¯Ù… Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· ØªÙ…Ù†Ø¹ Ù…Ù† Ø§Ù„ØªØ³Ù…ÙŠØ¹.</p>
            <p style="color:var(--g)">* ÙŠÙ…ÙƒÙ† Ù„Ù„Ø·Ø§Ù„Ø¨ ØªØ³Ù…ÙŠØ¹ Ø£ÙŠ Ø¯Ø±Ø³ Ø­Ø§Ù„ØªÙ‡ ØºÙŠØ± "Ø­Ø§ÙØ¸" ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª ÙŠØ­Ø¯Ø¯Ù‡ Ø§Ù„Ø£Ø³ØªØ§Ø°.</p>
            <button class="btn" onclick="this.parentElement.classList.add('hidden')">Ø¥ØºÙ„Ø§Ù‚</button>
        `;
    }

    function loadClass(cls) {
        const g = document.getElementById('namesGrid'); g.innerHTML = "";
        students.filter(x => x.class === cls).forEach(s => {
            const d = document.createElement('div'); d.className = 'grid-item'; d.innerText = s.name;
            d.onclick = () => { currentSID = s.id; document.getElementById('targetName').innerText = s.name; renderEditHistory(s); showScreen('gradeScreen'); };
            g.appendChild(d);
        });
    }

    function saveGrade(editIdx = null) {
        const s = students.find(x => x.id == currentSID);
        if(!s.records) s.records = [];
        
        let oldStatus = null;
        if(editIdx !== null) { oldStatus = s.records[editIdx].status; s.records.splice(editIdx, 1); }

        const newRec = {
            week: document.getElementById('gWeek').value,
            day: document.getElementById('gDay').value,
            page: document.getElementById('gPage').value,
            mark: document.getElementById('gMark').value,
            status: document.getElementById('gStatus').value,
            note: document.getElementById('gNote').value,
            isLate: document.getElementById('isLate').checked,
            prevStatus: oldStatus
        };

        s.records.push(newRec);
        db.ref('students/'+currentSID+'/records').set(s.records).then(() => {
            alert('ØªÙ… Ø§Ù„Ø±ØµØ¯ Ø¨Ù†Ø¬Ø§Ø­');
            location.reload();
        });
    }

    function renderEditHistory(s) {
        document.getElementById('editHistory').innerHTML = "<h4>Ø§Ù„Ø³Ø¬Ù„Ø§Øª:</h4>" + (s.records || []).map((r, i) => `
            <div style="font-size:12px; border-bottom:1px solid #ddd; padding:5px; display:flex; justify-content:space-between">
                <span>${r.week} - Øµ${r.page} - ${r.status}</span>
                <button onclick="delGrade(${i})" style="color:red; border:none; background:none;">Ø­Ø°Ù</button>
            </div>
        `).join('');
    }

    function delGrade(i) {
        if(confirm('Ø­Ø°ÙØŸ')) {
            const s = students.find(x => x.id == currentSID);
            s.records.splice(i, 1);
            db.ref('students/'+currentSID+'/records').set(s.records).then(() => renderEditHistory(s));
        }
    }

    function addNewStudent() {
        const id = Date.now();
        const n = document.getElementById('newSName').value;
        const c = document.getElementById('newSCode').value;
        const cl = document.getElementById('newSClass').value;
        if(n && c) db.ref('students/'+id).set({id, name: n, code: c, class: cl}).then(() => location.reload());
    }

    function logout() { location.reload(); }
    function filterGrid() {
        const q = document.getElementById('searchBox').value.toLowerCase();
        document.querySelectorAll('.grid-item').forEach(i => i.style.display = i.innerText.toLowerCase().includes(q) ? 'block' : 'none');
    }
    function showManageStudents() {
        showScreen('manageStudentsPage');
        document.getElementById('fullList').innerHTML = students.map(s => `<div class="history-item">${s.name} - ${s.code} <button onclick="db.ref('students/${s.id}').remove().then(()=>location.reload())" style="color:red">Ø­Ø°Ù</button></div>`).join('');
    }
</script>
</body>
</html>
