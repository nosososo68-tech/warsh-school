<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ v3.0 | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c;
            --warning: #f39c12; --info: #3498db; --light: #f4f7f6; --white: #ffffff;
        }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background: var(--light); color: var(--primary); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .card { background: var(--white); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 950px; margin: 10px 0; position: relative; border: 1px solid #eee; }
        .mustafa-tag { color: var(--success); font-weight: 700; text-align: center; display: block; margin-bottom: 15px; border-bottom: 2px solid #f9f9f9; padding-bottom: 10px; }
        .btn { padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; width: 100%; margin: 5px 0; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-tech { background: var(--success); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-back { background: #eee; color: #333; width: auto; position: absolute; top: 15px; right: 15px; font-size: 12px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1.5px solid #eee; outline: none; background: #fafafa; }
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; width: 100%; }
        .grid-item { background: white; padding: 20px; border-radius: 15px; text-align: center; border: 2px solid #f0f0f0; cursor: pointer; position: relative; }
        
        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª */
        .status-Ø­Ø§ÙØ¸ { background: #e8f5e9 !important; border-color: #2ecc71 !important; }
        .status-ØºØ§Ø¦Ø¨ { background: #e3f2fd !important; border-color: #3498db !important; }
        .status-Ù„Ù…-ÙŠØ³Ù…Ø¹ { background: #ffebee !important; border-color: #e74c3c !important; }

        footer { margin-top: auto; padding: 20px; text-align: center; font-size: 12px; color: #888; width: 100%; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
    </style>
</head>
<body onload="init()">

<div id="loginGate" class="card">
    <div class="mustafa-tag">| Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© v3.0 |</div>
    <div style="text-align:center;">
        <img src="https://cdn-icons-png.flaticon.com/512/2602/2602414.png" width="70" alt="Logo">
        <h2 style="margin: 15px 0;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… ğŸ›¡ï¸</h2>
        <input type="text" id="entryKey" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
        <div id="staffSection" class="hidden">
            <input type="password" id="entryPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        </div>
        <button class="btn btn-tech" onclick="mainAuth()">ğŸš€ Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
        <button class="btn" style="background:none; color:var(--primary);" onclick="toggleStaff()">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ø¯Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</button>
    </div>
</div>

<div id="app" class="hidden" style="width:100%; max-width:950px;">
    <div id="teacherDash" class="hidden card">
        <button class="btn btn-back" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <div id="roleDisplay" class="mustafa-tag"></div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <select id="viewWeek" onchange="renderNamesGrid()"></select>
            <select id="viewDay" onchange="renderNamesGrid()">
                <option>ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯</option><option>ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³</option>
            </select>
        </div>
        
        <input type="text" id="searchBox" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø£Ùˆ ÙƒÙˆØ¯..." oninput="renderNamesGrid()">
        
        <div style="display: flex; gap: 10px;">
            <button id="adminBtn" class="btn btn-info hidden" onclick="showScreen('adminPage')">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        </div>

        <div id="classTabs" style="display:flex; gap:8px; margin:15px 0; overflow-x:auto; padding-bottom:5px;"></div>
        <div id="namesGrid" class="grid"></div>
    </div>

    <div id="adminPage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3>âš™ï¸ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø§Ù„Ù€ 90 Ø·Ø§Ù„Ø¨)</h3>
        
        <div style="background:#fff9e6; padding:15px; border-radius:15px; margin-bottom:20px;">
            <h4>â• Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨</h4>
            <input type="text" id="admName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
            <input type="text" id="admCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
            <select id="admClass">
                <option>3/1</option><option>3/2</option><option>3/3</option><option>3/4</option><option>3/5</option>
            </select>
            <button class="btn btn-tech" onclick="saveStudentData()">ğŸ’¾ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</button>
            <p style="font-size:11px; color:red;">* Ù„ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ù‡ Ø£Ùˆ ÙƒÙˆØ¯Ù‡ ÙˆØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
        </div>

        <div style="overflow-x:auto;">
            <table id="studentsTable">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="adminList"></tbody>
            </table>
        </div>
    </div>

    <div id="gradeScreen" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3 id="targetName" style="color:var(--success);"></h3>
        <div style="background:#f9f9f9; padding:20px; border-radius:15px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
                <input type="number" id="gMark" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ù† 7">
            </div>
            <select id="gStatus">
                <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option><option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
                <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option><option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
            </select>
            <textarea id="gNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." rows="2"></textarea>
            <button class="btn btn-tech" onclick="saveGrade()">ğŸ’¾ Ø­ÙØ¸ ÙˆØ±ØµØ¯</button>
        </div>
        <div id="fullHistoryList" style="margin-top:20px;"></div>
    </div>
</div>

<footer>
    Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ Â© 2026 | ØªØ·ÙˆÙŠØ±: Ù…ØµØ·ÙÙ‰ & ÙŠØ²Ù†
</footer>

<script>
// 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = { 
    apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", 
    databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let students = [], currentUser = null, targetSID = null, selectedClass = "3/3";
let sessionColors = {};

// 2. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€ 29 Ø·Ø§Ù„Ø¨ (Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹)
const starterData = [
    {name: "Ø§Ø­Ù…Ø¯ Ø¹Ù…Ø± Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3326", class: "3/3"}, {name: "Ø¨Ø³Ø§Ù… Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3370", class: "3/3"},
    {name: "Ø¨Ø´Ø§Ø± Ø±Ø§Ù…Ø² ÙƒÙ†Ø¹Ø§Ù†", code: "3355", class: "3/3"}, {name: "ØªÙ…ÙŠÙ… Ù†ÙˆØ± Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3309", class: "3/3"},
    {name: "Ø­Ø³ÙŠÙ† Ø¹Ø¨Ø¯Ø§Ù„ÙƒØ±ÙŠÙ… Ø¨Ù† Ø¨Ø§Ø¯ÙŠ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3358", class: "3/3"}, {name: "Ø®Ø§Ù„Ø¯ Ø³Ù„ÙŠÙ… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3393", class: "3/3"},
    {name: "Ø±Ø§Ø¦Ø¯ ÙØ§ÙŠØ² Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ", code: "3301", class: "3/3"}, {name: "Ø±ÙŠØ§Ù† Ø¹Ø·Ø§Ù„Ù„Ù‡ Ø¹Ø¨ÙŠØ§Ù† Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3389", class: "3/3"},
    {name: "Ø³Ø§Ù…Ø± Ø¹Ù…Ø± Ø¨Ù† Ø¯Ø®ÙŠÙ„ Ø§Ù„Ù„Ù‡ Ø§Ù„ØµØ§Ø¹Ø¯ÙŠ", code: "3259", class: "3/3"}, {name: "Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3302", class: "3/3"},
    {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ", code: "3357", class: "3/3"}, {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø£Ù…ÙŠÙ† Ø­Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙƒÙŠ", code: "3392", class: "3/3"},
    {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø¤Ù…Ù† Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„Ø´Ù‡ÙŠØ¯", code: "3379", class: "3/3"}, {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù†Ø§ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ø¬Ù†ÙŠ", code: "3304", class: "3/3"},
    {name: "Ø¹Ù…Ø§Ø± Ø£Ø­Ù…Ø¯ Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3399", class: "3/3"}, {name: "Ø¹Ù…Ø± Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£Ù…ÙŠÙ† â€“ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø´ÙŠØ±", code: "3310", class: "3/3"},
    {name: "ØºØ§Ù†Ù… ØµÙ„Ø§Ø­ ØºØ§Ù†Ù… Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3391", class: "3/3"}, {name: "ÙØ±Ø§Ø³ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3322", class: "3/3"},
    {name: "ÙÙ‡Ø¯ Ù…Ø­Ù…Ø¯ ÙˆØµÙ„ Ø§Ù„Ø²Ø±ÙØ§Ù†ÙŠ", code: "3300", class: "3/3"}, {name: "ÙÙŠØµÙ„ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ø§Ø·Ø± Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ", code: "3366", class: "3/3"},
    {name: "ÙÙŠØµÙ„ Ø­Ø³Ø§Ù… Ø§Ù„Ø¯ÙŠÙ† â€“ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙ†", code: "3300", class: "3/3"}, {name: "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3349", class: "3/3"},
    {name: "Ù…Ø®ØªØ§Ø± Ø­Ù…ÙˆØ¯ ÙˆØ£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯Ø³Ø¹Ø¯ ÙˆØ§Ù„Ù…Ø­Ù…Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±", code: "3359", class: "3/3"}, {name: "Ù…Ø®ØªØ§Ø± Ø±Ø¨ÙŠØ¹ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆÙ„Ø¯ Ø§Ø¨Ø§Ù‡", code: "3365", class: "3/3"},
    {name: "Ù…ØµØ·ÙÙ‰ Ù…Ø®ØªØ§Ø± Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø®ØªØ§Ø±", code: "3396", class: "3/3"}, {name: "Ù…Ø¤ÙŠØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ù‚ÙˆÙŠÙ… Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ù‡Ù†Ø¯ÙŠ", code: "3389", class: "3/3"},
    {name: "Ù†ÙˆØ§Ù Ø¹Ù…Ø± Ø¨Ù† Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ", code: "3395", class: "3/3"}, {name: "Ù‡Ø§Ø´Ù… Ø£Ø­Ù…Ø¯ Ø¨Ù† ØµØ§Ù„Ø­ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡", code: "3388", class: "3/3"},
    {name: "ÙŠØ­ÙŠÙ‰ Ø£Ø­Ù…Ø¯ Ø²ÙŠÙ† ÙˆÙ„Ø¯ Ù…Ø­Ù…Ø¯ ÙˆÙ„Ø¯ Ù…Ø®ØªØ§Ø±", code: "3344", class: "3/3"}
];

// 3. Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
function init() {
    const weeksArr = Array.from({length: 35}, (_, i) => `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i + 1}`);
    const weekHTML = weeksArr.map(w => `<option value="${w}">${w}</option>`).join('');
    document.getElementById('viewWeek').innerHTML = weekHTML;

    db.ref('students').on('value', snap => {
        if(!snap.val()) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©ØŒ Ø§Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            starterData.forEach(s => db.ref('students').push(s));
        } else {
            students = Object.entries(snap.val()).map(([id, v]) => ({...v, id}));
            renderNamesGrid();
            renderAdminList();
        }
    });

    // Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    db.ref('staff/admin_').update({user: "admin_", pass: "admin2026", role: "admin", classes: "Ø§Ù„ÙƒÙ„"});
    db.ref('staff/saad').update({user: "saad", pass: "saad2026", role: "teacher", classes: "Ø§Ù„ÙƒÙ„"});
}

function toggleStaff() { document.getElementById('staffSection').classList.toggle('hidden'); }

async function mainAuth() {
    const key = document.getElementById('entryKey').value.trim();
    const pass = document.getElementById('entryPass').value.trim();
    const isStaff = !document.getElementById('staffSection').classList.contains('hidden');

    if(isStaff) {
        db.ref('staff/'+key).once('value', s => {
            const u = s.val();
            if(u && u.pass === pass) { currentUser = u; setupTeacherDash(); }
            else alert("âŒ Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
        });
    } else {
        const std = students.find(s => s.code === key);
        if(std) { alert("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ " + std.name); } // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø· Ø´Ø§Ø´Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø§Ø­Ù‚Ø§Ù‹
        else alert("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­");
    }
}

function setupTeacherDash() {
    showScreen('teacherDash');
    document.getElementById('roleDisplay').innerText = `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser.user}`;
    if(currentUser.role === 'admin') document.getElementById('adminBtn').classList.remove('hidden');
    renderClassTabs();
}

function renderClassTabs() {
    const cls = ["3/1", "3/2", "3/3", "3/4", "3/5"];
    document.getElementById('classTabs').innerHTML = cls.map(c => `
        <button class="btn" style="width:auto; background:${selectedClass===c?'var(--success)':'#eee'}; color:${selectedClass===c?'white':'#000'}" 
        onclick="selectedClass='${c}'; renderClassTabs(); renderNamesGrid();">${c}</button>
    `).join('');
}

function renderNamesGrid() {
    const grid = document.getElementById('namesGrid');
    grid.innerHTML = "";
    const search = document.getElementById('searchBox').value.toLowerCase();
    const vW = document.getElementById('viewWeek').value;
    const vD = document.getElementById('viewDay').value;

    const filtered = students.filter(s => s.class === selectedClass && (s.name.includes(search) || s.code.includes(search)));

    filtered.forEach(s => {
        const item = document.createElement('div');
        item.className = 'grid-item';
        const rec = (s.records || []).find(r => r.week === vW && r.day === vD);
        if(rec) item.classList.add('status-' + rec.status.replace(" ", "-"));
        item.innerHTML = `<b>${s.name}</b><br><small>#${s.code}</small><br>${rec ? 'ØµÙ€ '+rec.page : '---'}`;
        item.onclick = () => openGradeWindow(s);
        grid.appendChild(item);
    });
}

function openGradeWindow(s) {
    targetSID = s.id;
    document.getElementById('targetName').innerText = "Ø±ØµØ¯: " + s.name;
    showScreen('gradeScreen');
}

function saveGrade() {
    const s = students.find(x => x.id === targetSID);
    if(!s.records) s.records = [];
    const data = {
        week: document.getElementById('viewWeek').value,
        day: document.getElementById('viewDay').value,
        page: document.getElementById('gPage').value,
        mark: document.getElementById('gMark').value,
        status: document.getElementById('gStatus').value,
        note: document.getElementById('gNote').value
    };
    const idx = s.records.findIndex(r => r.week === data.week && r.day === data.day);
    if(idx > -1) s.records[idx] = data; else s.records.push(data);

    db.ref('students/'+s.id+'/records').set(s.records).then(() => {
        alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
        showScreen('teacherDash');
    });
}

// 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù€ 90 Ø·Ø§Ù„Ø¨)
function renderAdminList() {
    const list = document.getElementById('adminList');
    list.innerHTML = students.map(s => `
        <tr>
            <td>${s.name}</td>
            <td>${s.code}</td>
            <td>${s.class}</td>
            <td><button onclick="deleteStudent('${s.id}')" style="color:red; border:none; background:none; cursor:pointer;">Ø­Ø°Ù</button></td>
        </tr>
    `).join('');
}

function saveStudentData() {
    const name = document.getElementById('admName').value.trim();
    const code = document.getElementById('admCode').value.trim();
    const cls = document.getElementById('admClass').value;
    
    if(!name || !code) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    const existing = students.find(s => s.code === code || s.name === name);
    if(existing) {
        db.ref('students/'+existing.id).update({name, code, class: cls});
        alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨");
    } else {
        db.ref('students').push({name, code, class: cls});
        alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
    }
}

function deleteStudent(id) {
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) db.ref('students/'+id).remove();
}

function showScreen(id) {
    document.querySelectorAll('#app > div, #loginGate').forEach(d => d.classList.add('hidden'));
    document.getElementById('app').classList.remove('hidden');
    document.getElementById(id).classList.remove('hidden');
}

function logout() { location.reload(); }
</script>
</body>
</html>
