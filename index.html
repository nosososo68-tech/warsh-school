<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ | Ø§Ù„Ù…Ø·ÙˆØ± Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --p: #1e4d2b; --g: #d4af37; --bg: #f4f7f6; --card: #ffffff; --txt: #333; --accent: #2ecc71; }
        .theme-dark { --p: #121212; --g: #bb86fc; --bg: #000; --card: #1e1e1e; --txt: #e0e0e0; }
        .theme-blue { --p: #1a237e; --g: #00bcd4; --bg: #e8eaf6; --card: #fff; --txt: #1a237e; }
        .theme-gold { --p: #3e2723; --g: #d4af37; --bg: #efebe9; --card: #fff; --txt: #3e2723; }
        .theme-tech { --p: #003366; --g: #00ffcc; --bg: #000b18; --card: #001a33; --txt: #00ffcc; }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        body { background: var(--bg); color: var(--txt); margin: 0; padding: 10px; direction: rtl; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card { background: var(--card); border-radius: 25px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); margin: 10px auto; width: 100%; max-width: 600px; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .btn { padding: 15px; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; width: 100%; margin: 8px 0; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-p { background: linear-gradient(135deg, var(--p), #2a633a); color: white; }
        input, select, textarea { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #ddd; border-radius: 12px; font-size: 15px; background: #fff; color: #333; outline: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }
        .grid-item { background: var(--p); color: white; padding: 15px; border-radius: 15px; cursor: pointer; text-align: center; border: 1px solid var(--g); font-size: 13px; }
        .mustafa-tag { font-size: 12px; font-weight: bold; color: var(--g); text-align: center; margin: 10px 0; }
        .hidden { display: none !important; }
        .history-item { background: rgba(0,0,0,0.02); padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #eee; }
        .badge-info { background: rgba(0,0,0,0.05); padding: 15px; border-radius: 15px; margin: 10px 0; font-size: 12px; line-height: 1.6; border-right: 4px solid var(--g); }
        footer { margin-top: auto; text-align: center; padding: 20px; font-size: 11px; color: #888; width: 100%; }
    </style>
</head>
<body class="theme-default">

<div id="loginGate" class="card">
    <div class="mustafa-tag">Ù†Ø¸Ø§Ù… Ù…Ø­Ù…ÙŠ - ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡</div>
    <h2 style="text-align:center;">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠØ© ğŸ›¡ï¸</h2>
    
    <div id="studentLoginPart">
        <input type="text" id="studentCode" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨">
        <button class="btn btn-p" onclick="studentLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ğŸ‘¤</button>
    </div>

    <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
    
    <div id="staffLoginPart">
        <button class="btn" style="background:#455a64; color:white" onclick="toggleStaffLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ğŸ”</button>
        <div id="staffInputs" class="hidden">
            <input type="text" id="user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn btn-p" onclick="staffAuth()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>
    
    <div style="text-align:center; margin-top:20px; font-size:11px; color:#888;">
        Ø§Ù„Ù…Ø·ÙˆØ±: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯ | 0599804296
    </div>
</div>

<div id="app" class="hidden" style="width:100%;">
    
    <div id="studentPage" class="hidden card">
        <div class="mustafa-tag">Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ Ø§Ù„Ù…Ø·ÙˆØ±: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡</div>
        <h3 id="welcomeMsg"></h3>
        <div id="delayBox" style="background:#ffebee; color:#c62828; padding:10px; border-radius:10px; margin-bottom:10px; display:none; font-weight:bold; font-size:13px;"></div>
        
        <div style="background:var(--p); color:white; padding:15px; border-radius:15px; margin:15px 0; text-align:center;">
            <small>Ø§Ø®ØªØ± Ø«ÙŠÙ… Ø§Ù„Ø·Ø§Ù„Ø¨:</small>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                <div onclick="setTheme('default')" style="width:25px;height:25px;border-radius:50%;background:#1e4d2b;cursor:pointer;border:2px solid #fff"></div>
                <div onclick="setTheme('dark')" style="width:25px;height:25px;border-radius:50%;background:#000;cursor:pointer;border:2px solid #fff"></div>
                <div onclick="setTheme('tech')" style="width:25px;height:25px;border-radius:50%;background:#003366;cursor:pointer;border:2px solid #fff"></div>
            </div>
        </div>

        <h4>Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø¯Ø§Ø¦Ù… ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°:</h4>
        <div id="recordsList" style="max-height:300px; overflow-y:auto;"></div>

        <div class="badge-info">
            <b>ØªÙ†ÙˆÙŠÙ‡ Ù„Ù„Ù…ØµØ·Ù„Ø­Ø§Øª:</b><br>
            â€¢ Ù„Ù… ÙŠØ³Ù…Ø¹: Ø­Ø¶ÙˆØ± Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ | â€¢ ØºÙŠØ± Ø­Ø§ÙØ¸: Ø£Ø®Ø·Ø§Ø¡ ÙƒØ«ÙŠØ±Ø© | â€¢ Ù…Ø­Ø±ÙˆÙ…: Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† | â€¢ ØºØ§Ø¦Ø¨: Ù„Ù… ÙŠØ­Ø¶Ø± Ø§Ù„Ø­ØµØ©.
        </div>
        <button class="btn btn-p" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="teacherDash" class="hidden card">
        <div class="mustafa-tag">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„Ø© - Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡</div>
        <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø£Ø³ØªØ§Ø° Ø³Ø¹Ø¯ ğŸ› ï¸</h3>
        <input type="text" id="searchStudent" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ø§Ø³Ù…..." oninput="filterStudents()">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn btn-p" onclick="loadClass('3/1')">ÙØµÙ„ 3/1</button>
            <button class="btn btn-p" onclick="loadClass('3/2')">ÙØµÙ„ 3/2</button>
        </div>
        <div id="namesGrid" class="grid"></div>
        <button class="btn" style="background:#607d8b; color:white; margin-top:20px;" onclick="showManageStudents()">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù)</button>
        <button class="btn btn-p" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <h3 id="targetName"></h3>
        <label>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</label>
        <select id="gWeek"></select>
        <label>Ø§Ù„ÙŠÙˆÙ…:</label>
        <select id="gDay">
            <option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
        </select>
        <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
        <input type="number" id="gMark" max="7" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ù† 7">
        <select id="gStatus">
            <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
            <option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
            <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
            <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option>
            <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
        </select>
        <textarea id="gNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©"></textarea>
        <button class="btn btn-p" onclick="saveGrade()">Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø©</button>
        <button class="btn" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="adminDash" class="hidden card">
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø¹Ø±Ø¶ ÙÙ‚Ø· ğŸ“Š</h3>
        <div id="adminContainer"></div>
        <button class="btn btn-p" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<footer>
    <b>Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ Ø§Ù„Ù…Ø·ÙˆØ±: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯</b><br>
    ÙŠØ²Ù† Ø£Ù†Ø³ & Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ (ÙÙƒØ±Ø© ÙˆØªØµÙ…ÙŠÙ…) | Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ: 0599804296
</footer>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let students = []; let currentSID = null;

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
    function fetchData(callback) {
        db.ref('students').once('value', s => {
            students = s.exists() ? Object.values(s.val()) : [];
            if(callback) callback();
        });
    }

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
    const weeks = ["Ø§Ù„Ø£ÙˆÙ„","Ø§Ù„Ø«Ø§Ù†ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø«","Ø§Ù„Ø±Ø§Ø¨Ø¹","Ø§Ù„Ø®Ø§Ù…Ø³","Ø§Ù„Ø³Ø§Ø¯Ø³","Ø§Ù„Ø³Ø§Ø¨Ø¹","Ø§Ù„Ø«Ø§Ù…Ù†","Ø§Ù„ØªØ§Ø³Ø¹","Ø§Ù„Ø¹Ø§Ø´Ø±","Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ø´Ø±","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù…Ù† Ø¹Ø´Ø±","Ø§Ù„ØªØ§Ø³Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø­Ø§Ø¯ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù„Ø« ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø±Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø®Ø§Ù…Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø³Ø§Ø¯Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø³Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù…Ù† ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„ØªØ§Ø³Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†"];
    document.getElementById('gWeek').innerHTML = weeks.map(w => `<option value="Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}</option>`).join('');

    function toggleStaffLogin() { document.getElementById('staffInputs').classList.toggle('hidden'); }

    function studentLogin() {
        const code = document.getElementById('studentCode').value.trim();
        fetchData(() => {
            const s = students.find(x => x.code === code);
            if(s) {
                document.getElementById('loginGate').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                renderStudentPage(s);
                showScreen('studentPage');
            } else alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙØªØ§Ø­!');
        });
    }

    function staffAuth() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        if(u === 'saad' && p === 'Ø³Ø¹Ø¯ Ø§Ù„ÙÙŠÙ† Ùˆ Ø³ØªÙ‡ Ùˆ Ø¹Ø´Ø±ÙŠÙ†') {
            fetchData(() => {
                document.getElementById('loginGate').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                showScreen('teacherDash');
            });
        } else if(u === 'admin' && p === 'Ø§Ø¯Ù…Ù† 2026') {
            fetchData(() => {
                document.getElementById('loginGate').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                renderAdminDash();
                showScreen('adminDash');
            });
        } else alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!');
    }

    function logout() { location.reload(); }

    function renderStudentPage(s) {
        document.getElementById('welcomeMsg').innerHTML = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ: ${s.name} ğŸŒŸ`;
        const recs = s.records || [];
        document.getElementById('recordsList').innerHTML = recs.map(r => `
            <div class="history-item">
                <b>${r.week} - Øµ ${r.page}</b><br>
                Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status} | Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.mark}/7
                ${r.prevStatus ? `<br><small style="color:red">Ø£ØµÙ„Ù‡Ø§ ÙƒØ§Ù†Øª: ${r.prevStatus}</small>` : ''}
            </div>
        `).reverse().join('');
    }

    function loadClass(cls) {
        const grid = document.getElementById('namesGrid'); grid.innerHTML = "";
        students.filter(x => x.class === cls).forEach(s => {
            const div = document.createElement('div'); div.className = "grid-item";
            div.innerText = s.name;
            div.onclick = () => { currentSID = s.id; document.getElementById('targetName').innerText = `Ø±ØµØ¯: ${s.name}`; showScreen('gradeScreen'); };
            grid.appendChild(div);
        });
    }

    function saveGrade() {
        const s = students.find(x => x.id == currentSID);
        const week = document.getElementById('gWeek').value;
        const page = document.getElementById('gPage').value;
        const status = document.getElementById('gStatus').value;
        const mark = document.getElementById('gMark').value;
        if(!page || !mark) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø®Ø§Ù†Ø§Øª!');
        
        if(!s.records) s.records = [];
        const idx = s.records.findIndex(r => r.week === week && r.page === page);
        let prev = null;
        if(idx !== -1) { prev = s.records[idx].status; s.records.splice(idx,1); }

        s.records.push({ week, page, mark, status, day: document.getElementById('gDay').value, note: document.getElementById('gNote').value, prevStatus: (status==='Ø­Ø§ÙØ¸'&&prev)?prev:null });
        db.ref('students/'+currentSID+'/records').set(s.records).then(()=> { alert('ØªÙ…!'); showScreen('teacherDash'); });
    }

    function filterStudents() {
        const term = document.getElementById('searchStudent').value.toLowerCase();
        document.querySelectorAll('.grid-item').forEach(it => it.style.display = it.innerText.toLowerCase().includes(term) ? 'flex' : 'none');
    }

    function setTheme(t) { document.body.className = 'theme-' + t; }
    function showScreen(id) { document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
</script>
</body>
</html>
