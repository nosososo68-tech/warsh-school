<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ - Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ·ÙÙ‰ ÙˆÙŠØ²Ù† ÙˆÙ…Ø­Ù…Ø¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --p: #1e4d2b; --g: #d4af37; --bg: #f4f7f6; --white: #ffffff; --danger: #e74c3c; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background-color: var(--bg); margin: 0; direction: rtl; color: #333; }
        
        /* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† */
        .card { background: var(--white); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 15px auto; max-width: 500px; border-top: 5px solid var(--g); animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .btn { padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin: 8px 0; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-p { background: var(--p); color: white; }
        .btn-p:hover { transform: scale(1.02); opacity: 0.9; }
        .btn-admin { background: #2c3e50; color: white; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; text-align: center; font-size: 16px; outline: none; }
        input:focus { border-color: var(--p); }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù„Ù„Ø£Ø³ØªØ§Ø° */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .grid-item { background: var(--p); color: white; padding: 15px 5px; border-radius: 12px; cursor: pointer; font-size: 13px; font-weight: bold; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; color: white; }
        .footer-team { font-size: 11px; color: #777; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 10px; }
        .honor-roll { background: linear-gradient(45deg, #1e4d2b, #d4af37); color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="app">
    <div id="loginScreen" class="card" style="margin-top: 50px;">
        <h2 style="color:var(--p)">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ ğŸ“š</h2>
        <p style="font-size:13px">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
        <input type="number" id="loginID" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…">
        <button class="btn btn-p" onclick="studentLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        <hr>
        <button class="btn btn-admin" onclick="showScreen('staffLogin')">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© / Ø§Ù„Ø£Ø³ØªØ§Ø°</button>
        <div class="footer-team">ØµÙ†Ø¹ Ø¨ÙˆØ§Ø³Ø·Ø©: Ù…ØµØ·ÙÙ‰ØŒ ÙŠØ²Ù†ØŒ Ù…Ø­Ù…Ø¯ <br> Ù„Ù„ØªÙˆØ§ØµÙ„: 0599804296</div>
    </div>

    <div id="staffLogin" class="hidden card">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù‚Ù…</h3>
        <input type="text" id="staffUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="staffPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-p" onclick="staffLogin()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" onclick="showScreen('loginScreen')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="studentPage" class="hidden card">
        <div class="honor-roll">â­ Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: <br> <span id="topStudents">Ù‚Ø±ÙŠØ¨Ø§Ù‹..</span></div>
        <h2 id="stNameDisplay">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
        <p id="stCodeDisplay" class="badge" style="background:var(--p)"></p>
        <div style="background: #fff4e5; padding: 10px; border-radius: 10px; font-size: 13px; color: #d35400; font-weight: bold; margin-bottom: 15px;">
            âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ù‚Ø±Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù‡Ùˆ "ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©" ÙÙ‚Ø·.
        </div>
        <h4>Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:</h4>
        <div id="stRecords"></div>
        <div class="footer-team">Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ÙŠÙ†: Ù…ØµØ·ÙÙ‰ØŒ ÙŠØ²Ù†ØŒ Ù…Ø­Ù…Ø¯</div>
    </div>

    <div id="teacherDash" class="hidden card" style="max-width: 800px;">
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° Ø³Ø¹Ø¯ ğŸ› ï¸</h3>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-p" onclick="renderGrid('3/1')">ÙØµÙ„ 3/1</button>
            <button class="btn btn-p" onclick="renderGrid('3/2')">ÙØµÙ„ 3/2</button>
        </div>
        <div id="namesGrid" class="grid-container"></div>
        <hr>
        <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h4>
        <input type="text" id="newStName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
        <input type="number" id="newStCode" placeholder="Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø«Ø§Ù„: 3101)">
        <select id="newStClass"><option value="3/1">3/1</option><option value="3/2">3/2</option></select>
        <button class="btn btn-p" onclick="addNewStudent()">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn" style="background:var(--danger); color:#fff;" onclick="showScreen('loginScreen')">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="gradeModal" class="hidden card">
        <h3 id="targetStName">Ø±ØµØ¯ Ù„Ù„Ø·Ø§Ù„Ø¨</h3>
        <input type="text" id="weekNum" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ù…Ø«Ø§Ù„: Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ø³Ø¹)">
        <input type="text" id="dayName" placeholder="Ø§Ù„ÙŠÙˆÙ… (Ù…Ø«Ø§Ù„: Ø§Ù„Ø®Ù…ÙŠØ³)">
        <input type="text" id="pageNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
        <input type="text" id="manualGrade" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ù…Ø«Ø§Ù„: 10/10)">
        <select id="statusSelect">
            <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
            <option value="Ù„Ù… ÙŠØ­ÙØ¸">Ù„Ù… ÙŠØ­ÙØ¸ (Ø®Ø·Ø£) âš ï¸</option>
            <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ (Ù„Ù… ÙŠØ­ÙØ¸ Ø¨Ø¨ÙŠØªÙ‡) âŒ</option>
            <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… (Ù…Ø®Ø§Ù„ÙØ© Ù‚ÙˆØ§Ù†ÙŠÙ†) â›”</option>
            <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
        </select>
        <textarea id="teacherNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©"></textarea>
        <button class="btn btn-p" onclick="submitGrade()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="btn" onclick="deleteStudent()">Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
        <button class="btn" onclick="showScreen('teacherDash')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div id="adminDash" class="hidden card" style="max-width: 800px;">
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ ÙÙ‚Ø·) ğŸ‘ï¸</h3>
        <div id="adminContent"></div>
        <button class="btn" onclick="showScreen('loginScreen')">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8",
        databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let students = [];
    let selectedStId = null;
    let isReadOnly = false;

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø²Ø§Ù…Ù†ØªÙ‡Ø§
    db.ref('students').on('value', snap => {
        students = snap.val() || [];
        updateHonorRoll();
    });

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯Ø®ÙˆÙ„
    function studentLogin() {
        const code = document.getElementById('loginID').value;
        const s = students.find(x => x.code == code);
        if(s) {
            document.getElementById('stNameDisplay').innerText = s.name;
            document.getElementById('stCodeDisplay').innerText = "ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨: " + s.code;
            renderStudentRecords(s);
            showScreen('studentPage');
        } else { alert("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­!"); }
    }

    function staffLogin() {
        const u = document.getElementById('staffUser').value;
        const p = document.getElementById('staffPass').value;
        if(u === 'saad' && p === '1234567891011s') {
            isReadOnly = false;
            showScreen('teacherDash');
        } else if(u === 'admin' && p === 'admin2026') {
            isReadOnly = true;
            renderAdminView();
            showScreen('adminDash');
        } else { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!"); }
    }

    // Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø³ØªØ§Ø°
    function renderGrid(cls) {
        const container = document.getElementById('namesGrid');
        container.innerHTML = "";
        students.filter(s => s.class === cls).forEach(s => {
            const div = document.createElement('div');
            div.className = "grid-item";
            div.innerText = s.name;
            div.onclick = () => openGradeModal(s.id);
            container.appendChild(div);
        });
    }

    function openGradeModal(id) {
        selectedStId = id;
        const s = students.find(x => x.id == id);
        document.getElementById('targetStName').innerText = "Ø±ØµØ¯: " + s.name;
        showScreen('gradeModal');
    }

    function submitGrade() {
        const idx = students.findIndex(x => x.id == selectedStId);
        const newRecord = {
            week: document.getElementById('weekNum').value,
            day: document.getElementById('dayName').value,
            page: document.getElementById('pageNumber').value,
            grade: document.getElementById('manualGrade').value,
            status: document.getElementById('statusSelect').value,
            note: document.getElementById('teacherNote').value,
            isRetry: false
        };

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© "Ù„Ù… ÙŠØ­ÙØ¸"
        const oldRec = students[idx].records || [];
        if(oldRec.some(r => r.page == newRecord.page && r.status === "Ù„Ù… ÙŠØ­ÙØ¸")) {
            newRecord.isRetry = true;
        }

        if(!students[idx].records) students[idx].records = [];
        students[idx].records.unshift(newRecord);
        
        db.ref('students').set(students).then(() => {
            alert("ØªÙ… Ø§Ù„Ø±ØµØ¯!");
            showScreen('teacherDash');
        });
    }

    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ù„Ø·Ø§Ù„Ø¨
    function renderStudentRecords(s) {
        const container = document.getElementById('stRecords');
        container.innerHTML = s.records ? "" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.";
        (s.records || []).forEach(r => {
            const color = r.status === "Ø­Ø§ÙØ¸" ? "#27ae60" : "#c0392b";
            container.innerHTML += `
                <div style="border-right:4px solid ${color}; padding:10px; background:#f9f9f9; margin-bottom:10px; text-align:right; border-radius:8px;">
                    <b>${r.week} - ${r.day}</b> ${r.isRetry ? '<span style="color:blue">[Ø¥Ø¹Ø§Ø¯Ø©]</span>' : ''}<br>
                    Ø§Ù„ØµÙØ­Ø©: ${r.page} | Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.grade} <br>
                    Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status} <br>
                    <small>Ù…Ù„Ø§Ø­Ø¸Ø©: ${r.note || "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}</small>
                </div>`;
        });
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„Ø­Ø°Ù
    function addNewStudent() {
        const n = document.getElementById('newStName').value;
        const c = document.getElementById('newStCode').value;
        const cls = document.getElementById('newStClass').value;
        if(n && c) {
            students.push({ id: Date.now(), name: n, code: c, class: cls, records: [] });
            db.ref('students').set(students);
            alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
        }
    }

    function deleteStudent() {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) {
            students = students.filter(s => s.id != selectedStId);
            db.ref('students').set(students).then(() => showScreen('teacherDash'));
        }
    }

    function updateHonorRoll() {
        // Ù…Ù†Ø·Ù‚ Ø¨Ø³ÙŠØ·: Ø£ÙˆÙ„ 3 Ø·Ù„Ø§Ø¨ Ù„Ù… ÙŠØ£Ø®Ø°ÙˆØ§ "Ù„Ù… ÙŠØ­ÙØ¸" Ø£Ùˆ "Ù…Ø­Ø±ÙˆÙ…"
        const top = students.filter(s => s.records && s.records[0].status === "Ø­Ø§ÙØ¸").slice(0, 3).map(s => s.name).join(' - ');
        document.getElementById('topStudents').innerText = top || "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ†..";
    }

    function showScreen(id) {
        document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function renderAdminView() {
        const cont = document.getElementById('adminContent');
        cont.innerHTML = students.map(s => `<p>${s.name} (${s.class}): ${s.records ? s.records.length : 0} ØªØ³Ù…ÙŠØ¹Ø§Øª</p>`).join('');
    }

    // ØªØµÙÙŠØ± Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ ÙƒÙ„ Ø®Ù…ÙŠØ³
    setInterval(() => {
        const now = new Date();
        if(now.getDay() === 4 && now.getHours() === 23) { // Ø§Ù„Ø®Ù…ÙŠØ³ Ø§Ù„Ø³Ø§Ø¹Ø© 11 Ù…Ø³Ø§Ø¡Ù‹
            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„ØªØµÙÙŠØ± Ù…ÙŠØ²Ø© Ù…Ø¹ÙŠÙ†Ø© Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
        }
    }, 3600000);

</script>

<style> .hidden { display: none !important; } </style>
</body>
</html>
