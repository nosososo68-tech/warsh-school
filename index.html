<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ | ØªØ·ÙˆÙŠØ± Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯ & ÙŠØ²Ù† Ø£Ù†Ø³</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #f4f7f6; --card: #ffffff; --p: #2c3e50; --g: #27ae60; --txt: #2c3e50; --red: #e74c3c; --orange: #f39c12; --blue: #3498db; --yellow: #f1c40f; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--txt); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 700px; margin: 10px 0; position: relative; border: 1px solid rgba(0,0,0,0.05); }
        .mustafa-tag { color: var(--g); font-weight: bold; font-size: 13px; text-align: center; display: block; margin: 10px 0; }
        .btn { padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-tech { background: var(--g); color: white; }
        .btn-back { background: rgba(0,0,0,0.1); color: var(--txt); width: auto; padding: 5px 15px; font-size: 12px; position: absolute; top: 10px; right: 10px; z-index: 100; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; background: white; font-size: 14px; }
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
        
        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .grid-item { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid #000; cursor: pointer; font-weight: bold; color: #000; }
        .status-Ø­Ø§ÙØ¸ { background: #e8f5e9 !important; color: #1b5e20 !important; border-color: #2e7d32 !important; box-shadow: 0 0 10px #2ecc71; }
        .status-ØºÙŠØ±-Ø­Ø§ÙØ¸ { background: #fffde7 !important; color: #fbc02d !important; border-color: #fdd835 !important; box-shadow: 0 0 10px #f1c40f; }
        .status-ØºØ§Ø¦Ø¨ { background: #e3f2fd !important; color: #0d47a1 !important; border-color: #1565c0 !important; box-shadow: 0 0 10px #3498db; }
        .status-Ù„Ù…-ÙŠØ³Ù…Ø¹, .status-Ù…Ø­Ø±ÙˆÙ… { background: #ffebee !important; color: #b71c1c !important; border-color: #c62828 !important; box-shadow: 0 0 10px #e74c3c; }

        .history-item { background: rgba(0,0,0,0.03); padding: 15px; border-radius: 15px; margin-bottom: 10px; border-right: 5px solid var(--g); position: relative; text-align: right; }
        .modified-badge { background: var(--yellow); color: #000; padding: 2px 8px; border-radius: 5px; font-size: 11px; font-weight: bold; margin-top: 5px; display: inline-block; }
        .modified-card { border: 2px solid var(--yellow) !important; background: #fffde7; }
        .top-rank { background: linear-gradient(135deg, #f1c40f, #f39c12); color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .call-parent { background: #ffeded; border: 2px solid var(--red); color: var(--red); padding: 10px; border-radius: 10px; margin: 10px 0; font-weight: bold; }
        .bubble { display: inline-block; background: var(--g); color: white; padding: 4px 10px; border-radius: 20px; margin: 2px; font-size: 12px; }
        footer { margin-top: auto; padding: 20px; font-size: 12px; color: #777; text-align: center; }
    </style>
</head>
<body>

<div id="loginGate" class="card">
    <div class="mustafa-tag">| Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ |</div>
    <h2 style="text-align:center;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ›¡ï¸</h2>
    <input type="text" id="entryKey" placeholder="Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <div id="staffSection" class="hidden">
        <input type="password" id="entryPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    </div>
    <button class="btn btn-tech" onclick="mainAuth()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    <button class="btn" style="background:transparent; color:var(--g);" onclick="document.getElementById('staffSection').classList.toggle('hidden')">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ø¯Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</button>
</div>

<div id="app" class="hidden" style="width:100%; max-width:700px;">
    
    <div id="topTenSection" class="card top-rank">
        <h3 style="margin:0; text-align:center;">ğŸ† Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
        <div id="topList" style="margin-top:10px; font-weight:bold; text-align:center;"></div>
    </div>

    <div id="studentPage" class="hidden card">
        <button class="btn btn-back" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        <h3 id="welcomeMsg"></h3>
        <div id="parentCallArea"></div>
        <div id="lateStats" class="card" style="background:#f0f0f0; border:1px solid #ccc;"></div>
        <h4>Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</h4>
        <div id="recordsList"></div>
    </div>

    <div id="teacherDash" class="hidden card">
        <button class="btn btn-back" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        <div id="roleDisplay" class="mustafa-tag"></div>
        
        <div style="background:#eee; padding:10px; border-radius:10px; margin-bottom:10px;">
            <label>Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ù„ÙŠÙˆÙ…):</label>
            <div style="display:flex; gap:5px;">
                <select id="viewWeek" onchange="renderNamesGrid()"></select>
                <select id="viewDay" onchange="renderNamesGrid()">
                    <option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯">ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³">ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³</option>
                </select>
            </div>
        </div>

        <input type="text" id="searchBox" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø·Ø§Ù„Ø¨..." oninput="filterGrid()">
        
        <div id="generalBroadcast" class="card" style="background:#fff9e6; border:1px solid #f1c40f;">
            <h4 style="margin:0 0 10px 0;">ğŸ“¢ Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ÙØµÙ„</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <select id="bcWeek"></select>
                <select id="bcDay">
                    <option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯">ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³">ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³</option>
                </select>
            </div>
            <input type="number" id="bcPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© Ù„Ù„ØªØ¹Ù…ÙŠÙ…">
            <button class="btn" style="background:var(--orange); color:white;" onclick="applyBroadcast()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø¹Ù„Ù‰ Ø§Ù„ÙØµÙ„</button>
        </div>

        <div id="classTabs" style="display:flex; gap:10px; margin:10px 0; flex-wrap: wrap;"></div>
        <div id="namesGrid" class="grid"></div>
        
        <button id="adminBtn" class="btn hidden" style="background:#2c3e50; color:white; margin-top:20px;" onclick="showManagePage()">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©</button>
        <button id="idarahBtn" class="btn hidden" style="background:#8e44ad; color:white;" onclick="showIdarahPage()">ğŸ‘‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù„ÙŠØ§</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3 id="targetName" style="color:var(--g)"></h3>
        <div id="gradeForm">
            <select id="gWeek"></select>
            <select id="gDay">
                <option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯">ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³">ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³</option>
            </select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
                <input type="number" id="gMark" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© / 7">
            </div>
            <select id="gStatus">
                <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
                <option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
                <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
                <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option>
                <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
                <option value="Ø§Ø®ØªØ¨Ø§Ø±">Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ù‚Ø±Ø© ğŸ†</option>
            </select>

            <div id="testSection" class="hidden" style="background:#f9f9f9; padding:10px; border-radius:10px; margin:10px 0; border:1px solid #ddd;">
                <label>Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ù‚Ø±Ø©:</label>
                <input type="text" id="testPages" placeholder="Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØµÙØ­Ø§Øª (Ù…Ø«Ø§Ù„: 2 5 10)">
            </div>

            <textarea id="gNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ Ø³Ø¨Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡..."></textarea>
            <label><input type="checkbox" id="isParentCall"> Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆÙ„ÙŠ Ø£Ù…Ø± ğŸš©</label>
            <button class="btn btn-tech" id="saveBtn" onclick="saveGrade()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <hr>
        <div id="editHistory"></div>
    </div>

    <div id="idarahPage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3>ğŸ‘‘ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</h3>
        <div id="teacherManager">
            <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h4>
            <div id="teacherList"></div>
        </div>
        <hr>
        <h4>Ø´Ø±Ø­ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©:</h4>
        <div style="font-size:12px; color:#555;">
            - ÙŠÙ…ÙƒÙ† ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø±ØµØ¯ Ù„Ø£ÙŠ ÙØµÙ„.<br>
            - ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¹Ø¯ ÙˆØ¥Ø¨Ø±Ø§Ù‡ÙŠÙ….<br>
            - Ù…Ø±Ø§Ù‚Ø¨Ø© ÙƒØ§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.
        </div>
    </div>

    <div id="managePage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ÙØµÙˆÙ„</h3>
        <div id="adminTools">
            <input type="text" id="newSName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
            <input type="text" id="newSCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
            <select id="newSClass"></select>
            <button class="btn btn-tech" onclick="addNewStudent()">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
        </div>
        <hr>
        <div id="fullList"></div>
    </div>
</div>

<footer><b>ØªØ·ÙˆÙŠØ±: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯ & ÙŠØ²Ù† Ø£Ù†Ø³ | ØªÙ†Ø³ÙŠÙ‚: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ</b></footer>

<script>
    // ØªÙƒÙˆÙŠÙ† Firebase
    const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    let students = []; 
    let classes = ["3/1", "3/2", "3/3"]; 
    let teachers = [
        {user: 'saad', pass: 'saad2026', role: 'owner'},
        {user: 'ibrahim', pass: 'ibrahim2026', role: 'teacher'}
    ];
    let currentSID = null; 
    let currentUser = null;
    let selectedClass = "3/1";

    const weeksArr = Array.from({length: 30}, (_, i) => `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i + 1}`);

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
    function init() {
        const weekOptions = weeksArr.map(w => `<option value="${w}">${w}</option>`).join('');
        document.getElementById('gWeek').innerHTML = weekOptions;
        document.getElementById('viewWeek').innerHTML = weekOptions;
        document.getElementById('bcWeek').innerHTML = weekOptions;
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        db.ref('students').on('value', snap => {
            const data = snap.val();
            students = data ? Object.entries(data).map(([id, val]) => ({...val, id: id})) : [];
            renderNamesGrid();
        });
        
        db.ref('classes').on('value', s => { if(s.val()) classes = Object.values(s.val()); updateSelectors(); });
        db.ref('topTen').on('value', sn => { document.getElementById('topList').innerHTML = (sn.val() || []).join(' | '); });
    }

    function updateSelectors() {
        const opt = classes.map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('newSClass').innerHTML = opt;
    }

    // Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function mainAuth() {
        const key = document.getElementById('entryKey').value.trim();
        const pass = document.getElementById('entryPass').value.trim();
        const isStaff = !document.getElementById('staffSection').classList.contains('hidden');

        if (isStaff) {
            if (key === 'idarah' && pass === 'idarah2026') {
                currentUser = {user: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', role: 'idarah'};
                setupDash();
            } else if (key === 'admin' && pass === 'admin2026') {
                currentUser = {user: 'Ø§Ù„Ù…Ø¯ÙŠØ±/Ø§Ù„ÙˆÙƒÙŠÙ„', role: 'admin'};
                setupDash();
            } else {
                const t = teachers.find(x => x.user === key && x.pass === pass);
                if(t) { currentUser = t; setupDash(); } else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            }
        } else {
            const std = students.find(x => x.code === key);
            if (std) { currentSID = std.id; showScreen('studentPage'); renderStudentView(std); }
            else alert("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­");
        }
    }

    function setupDash() {
        showScreen('teacherDash');
        document.getElementById('roleDisplay').innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹: ${currentUser.user}`;
        
        if (['owner', 'teacher', 'idarah'].includes(currentUser.role)) {
            document.getElementById('adminBtn').classList.remove('hidden');
        }
        if (currentUser.role === 'idarah') {
            document.getElementById('idarahBtn').classList.remove('hidden');
        }

        const tabs = document.getElementById('classTabs'); tabs.innerHTML = "";
        classes.forEach(c => {
            const btn = document.createElement('button'); btn.className = 'btn btn-tech'; btn.innerText = `ÙØµÙ„ ${c}`;
            btn.onclick = () => { selectedClass = c; renderNamesGrid(); };
            tabs.appendChild(btn);
        });
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ© Ù…Ø¹ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø°ÙƒÙŠØ©
    function renderNamesGrid() {
        if (!currentUser) return;
        const g = document.getElementById('namesGrid'); g.innerHTML = "";
        const vWeek = document.getElementById('viewWeek').value;
        const vDay = document.getElementById('viewDay').value;

        students.filter(x => x.class === selectedClass).forEach(s => {
            const d = document.createElement('div');
            d.className = 'grid-item';
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
            const recordToday = (s.records || []).find(r => r.week === vWeek && r.day === vDay);
            if(recordToday) d.classList.add('status-' + recordToday.status.replace(" ", "-"));
            
            d.innerText = s.name;
            d.onclick = () => openGrade(s);
            g.appendChild(d);
        });
    }

    function openGrade(s) {
        currentSID = s.id;
        document.getElementById('targetName').innerText = s.name;
        document.getElementById('gWeek').value = document.getElementById('viewWeek').value;
        document.getElementById('gDay').value = document.getElementById('viewDay').value;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ¹Ù…ÙŠÙ… Ù…Ø³Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
        const existing = (s.records || []).find(r => r.week === document.getElementById('gWeek').value && r.day === document.getElementById('gDay').value);
        if(existing) {
            document.getElementById('gPage').value = existing.page || "";
            document.getElementById('gMark').value = existing.mark || "";
            document.getElementById('gStatus').value = existing.status || "Ø­Ø§ÙØ¸";
        } else {
            document.getElementById('gPage').value = "";
            document.getElementById('gMark').value = "";
        }
        
        renderEditHistory(s);
        showScreen('gradeScreen');
    }

    // Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ
    function applyBroadcast() {
        if (currentUser.role === 'admin') return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ù…ÙŠÙ…");
        const bW = document.getElementById('bcWeek').value;
        const bD = document.getElementById('bcDay').value;
        const bP = document.getElementById('bcPage').value;

        if(!bP) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© Ù„Ù„ØªØ¹Ù…ÙŠÙ…");

        const batch = students.filter(s => s.class === selectedClass);
        batch.forEach(s => {
            if(!s.records) s.records = [];
            // Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø³Ø¬Ù„ Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø·
            const idx = s.records.findIndex(r => r.week === bW && r.day === bD);
            if(idx > -1) {
                s.records[idx].page = bP;
            } else {
                s.records.push({ week: bW, day: bD, page: bP, status: "Ù„Ù… ÙŠØ³Ù…Ø¹", mark: 0 });
            }
            db.ref('students/'+s.id+'/records').set(s.records);
        });
        alert("ØªÙ… ØªØ¹Ù…ÙŠÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ ÙØµÙ„ " + selectedClass);
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø©
    function saveGrade() {
        if (currentUser.role === 'admin') return alert("Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
        const s = students.find(x => x.id == currentSID);
        if(!s.records) s.records = [];
        
        const week = document.getElementById('gWeek').value;
        const day = document.getElementById('gDay').value;
        const status = document.getElementById('gStatus').value;
        const mark = document.getElementById('gMark').value;
        const page = document.getElementById('gPage').value;
        const note = document.getElementById('gNote').value;
        const isCall = document.getElementById('isParentCall').checked;

        const recIdx = s.records.findIndex(r => r.week === week && r.day === day);
        
        let originalStatus = null;
        if(recIdx > -1 && s.records[recIdx].status !== status) {
            originalStatus = s.records[recIdx].status;
        }

        const newRec = {
            week, day, page, mark, status, note, 
            originalStatus: originalStatus || (recIdx > -1 ? (s.records[recIdx].originalStatus || null) : null),
            isParentCall: isCall,
            testPages: status === 'Ø§Ø®ØªØ¨Ø§Ø±' ? document.getElementById('testPages').value : null
        };

        if(recIdx > -1) s.records[recIdx] = newRec;
        else s.records.push(newRec);

        db.ref('students/'+currentSID+'/records').set(s.records).then(() => {
            alert("ØªÙ… Ø§Ù„Ø±ØµØ¯ Ø¨Ù†Ø¬Ø§Ø­");
            showScreen('teacherDash');
        });
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ø§Ù„Ø¨
    function renderStudentView(s) {
        document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ: ${s.name} (ÙØµÙ„ ${s.class})`;
        
        // Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª
        const lates = (s.records || []).filter(r => r.status === "Ù„Ù… ÙŠØ³Ù…Ø¹");
        document.getElementById('lateStats').innerHTML = `<b>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª: ${lates.length}</b><br>` + 
            lates.map(l => `<small>${l.week} - Øµ ${l.page}</small>`).join(' | ');

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
        const call = (s.records || []).find(r => r.isParentCall === true);
        document.getElementById('parentCallArea').innerHTML = call ? `<div class="call-parent">ğŸš© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆÙ„ÙŠ Ø£Ù…Ø±: ${call.note} (${call.day})</div>` : "";

        // Ø§Ù„Ø³Ø¬Ù„
        document.getElementById('recordsList').innerHTML = (s.records || []).map(r => `
            <div class="history-item ${r.originalStatus ? 'modified-card' : ''}">
                <b>${r.week} - ${r.day}</b><br>
                Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status} | Ø§Ù„ØµÙØ­Ø©: ${r.page} | Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.mark}/7
                ${r.status === 'Ø§Ø®ØªØ¨Ø§Ø±' ? `<br>ØµÙØ­Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${r.testPages.split(' ').map(p => `<span class="bubble">${p}</span>`).join('')}` : ''}
                ${r.originalStatus ? `<br><span class="modified-badge">Ø§Ù„Ø£ØµÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ${r.originalStatus}</span>` : ''}
                ${r.note ? `<br><i style="color:blue">Ù…Ù„Ø§Ø­Ø¸Ø©: ${r.note}</i>` : ''}
            </div>
        `).reverse().join('');
    }

    function renderEditHistory(s) {
        document.getElementById('editHistory').innerHTML = "<h4>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚:</h4>" + (s.records || []).map((r, i) => `
            <div class="history-item" style="font-size:12px;">
                ${r.week} - ${r.day} (${r.status})
                <button onclick="deleteRecord(${i})" style="color:red; background:none; border:none; float:left;">Ø­Ø°Ù</button>
            </div>
        `).reverse().join('');
    }

    function deleteRecord(i) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) {
            const s = students.find(x => x.id == currentSID);
            s.records.splice(i, 1);
            db.ref('students/'+currentSID+'/records').set(s.records);
        }
    }

    function showScreen(id) {
        document.querySelectorAll('#app > div, #loginGate').forEach(d => d.classList.add('hidden'));
        document.getElementById('app').classList.remove('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    function addNewStudent() {
        const name = document.getElementById('newSName').value;
        const code = document.getElementById('newSCode').value;
        const cls = document.getElementById('newSClass').value;
        if(name && code) {
            const id = "std_" + Date.now();
            db.ref('students/'+id).set({id, name, code, class: cls, records: []});
            alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨");
        }
    }

    document.getElementById('gStatus').onchange = function() {
        document.getElementById('testSection').classList.toggle('hidden', this.value !== 'Ø§Ø®ØªØ¨Ø§Ø±');
    };

    function filterGrid() {
        const q = document.getElementById('searchBox').value.toLowerCase();
        document.querySelectorAll('.grid-item').forEach(i => i.style.display = i.innerText.toLowerCase().includes(q) ? 'block' : 'none');
    }

    init();
</script>
</body>
</html>
