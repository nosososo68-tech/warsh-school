<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WARSH OS v7.0 | Ø§Ù„Ù€Ù†Ù€Ø³Ù€Ø®Ù€Ø© Ø§Ù„Ù€Ø·Ù€Ø§ØºÙ€ÙŠÙ€Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #059669; --secondary: #0284c7; --danger: #ef4444;
            --warning: #f59e0b; --dark: #0f172a; --card: #ffffff;
            --bg: #f8fafc; --text: #1e293b; --radius: 18px;
        }

        .theme-dark { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.2s; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .glass-card { background: var(--card); border-radius: var(--radius); padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Stats & UI */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-box { background: var(--primary); color: white; padding: 20px; border-radius: 20px; text-align: center; position: relative; }
        .stat-box i { font-size: 30px; opacity: 0.2; position: absolute; left: 15px; top: 15px; }

        /* Student Grid */
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .std-card { background: var(--card); border: 2px solid transparent; border-radius: var(--radius); padding: 20px; text-align: center; cursor: pointer; position: relative; border: 1px solid rgba(0,0,0,0.05); }
        .std-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .std-card.done { background: var(--primary); color: white; }
        .std-card.absent { border-color: var(--danger); }

        /* Controls */
        .btn { padding: 12px 25px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-admin { background: var(--secondary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        
        .tabs { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card); width: 100%; max-width: 650px; border-radius: 28px; padding: 35px; max-height: 90vh; overflow-y: auto; position: relative; }

        input, select, textarea { width: 100%; padding: 14px; border-radius: 12px; border: 1.5px solid #e2e8f0; margin-top: 8px; background: var(--bg); color: var(--text); font-size: 15px; }
        label { font-weight: 700; font-size: 13px; color: var(--primary); margin-top: 15px; display: block; }

        .hidden { display: none !important; }
        .badge { background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 5px; font-size: 10px; }

        /* Admin Management Tables */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td { padding: 12px; text-align: right; border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        footer { text-align: center; padding: 30px; opacity: 0.5; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginSection" class="glass-card" style="max-width:450px; margin: 80px auto; text-align:center;">
        <h1 style="color:var(--primary); font-weight:900; letter-spacing:-1px;">WARSH OS <span style="font-size:15px; vertical-align:middle; opacity:0.5;">v7.0</span></h1>
        <p style="margin-bottom:30px; opacity:0.6;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„ ÙˆØ§Ù„Ø³ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©</p>
        
        <input type="text" id="uKey" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="uPass" class="hidden" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-primary" style="width:100%; margin-top:20px; height:55px;" onclick="doLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        <p id="toggleLogin" style="margin-top:20px; font-size:14px; color:var(--primary); cursor:pointer; font-weight:700;" onclick="toggleStaffMode()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</p>
    </div>

    <div id="mainApp" class="hidden">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <div>
                <h2 id="welcomeName" style="margin:0; font-weight:800;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
                <div id="roleBadge" style="display:inline-block; background:var(--primary); color:white; padding:2px 12px; border-radius:50px; font-size:11px; font-weight:bold;"></div>
            </div>
            <button class="btn btn-danger" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </header>

        <div class="glass-card" style="background:var(--dark); color:white; display:flex; gap:15px; flex-wrap:wrap;">
            <div style="flex:1; min-width:150px;">
                <label style="color:white; opacity:0.7;">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ</label>
                <select id="selWeek" onchange="renderGrid()"></select>
            </div>
            <div style="flex:1; min-width:150px;">
                <label style="color:white; opacity:0.7;">Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
                <select id="selDay" onchange="renderGrid()">
                    <option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
                </select>
            </div>
        </div>

        <div class="tabs" id="classTabs"></div>

        <div class="stats-grid">
            <div class="stat-box"> <h3 id="statPresent">0</h3> <span>Ø§Ù„Ù…Ø±ØµÙˆØ¯ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</span> </div>
            <div class="stat-box" style="background:var(--secondary)"> <h3 id="statTotal">0</h3> <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ù„Ù‚Ø©</span> </div>
            <div class="stat-box" style="background:var(--warning)"> <h3 id="statAvg">0%</h3> <span>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span> </div>
        </div>

        <div id="mainGrid" class="student-grid"></div>

        <div id="idarahModule" class="hidden" style="margin-top:40px;">
            <div class="glass-card" style="border-top:5px solid var(--secondary);">
                <h2 style="color:var(--secondary);">ğŸ› ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³ÙŠØ§Ø¯Ø© (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§)</h2>
                <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                    <button class="btn btn-admin" onclick="showUserManager('student')">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                    <button class="btn btn-admin" onclick="showUserManager('teacher')">ğŸ‘¨â€ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
                    <button class="btn btn-admin" onclick="showFeedbackModal()">ğŸ“¥ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª</button>
                    <button class="btn btn-danger" onclick="wipeData()">ğŸ§¹ ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="gradeModal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 id="stdNameTitle" style="color:var(--primary); margin:0;"></h2>
        <p id="stdInfoSub" style="font-size:12px; opacity:0.6; margin-bottom:20px;"></p>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div>
                <label>Ø§Ù„Ø³ÙˆØ±Ø©</label>
                <input type="text" id="gSura" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø©">
            </div>
            <div>
                <label>Ø§Ù„ØµÙØ­Ø©</label>
                <input type="text" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div>
                <label>Ø§Ù„Ø¯Ø±Ø¬Ø© (Ù…Ù† 7)</label>
                <input type="number" id="gMark" max="7" min="0">
            </div>
            <div>
                <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸</label>
                <select id="gStatus">
                    <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
                    <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
                    <option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
                    <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option>
                    <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
                </select>
            </div>
        </div>

        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</label>
        <textarea id="gNote" rows="2" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>

        <div style="display:flex; gap:10px; margin-top:25px;">
            <button id="saveBtn" class="btn btn-primary" style="flex:2" onclick="saveGrade()">Ø­ÙØ¸ ÙˆØ±ØµØ¯</button>
            <button id="delGradeBtn" class="btn btn-danger hidden" onclick="deleteGrade()">Ø­Ø°Ù Ø§Ù„Ø±ØµØ¯</button>
            <button class="btn btn-outline" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<div id="userManagerModal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width:900px;">
        <h2 id="mgrTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
        <div class="glass-card" style="background:var(--bg);">
            <h4>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„</h4>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:10px;">
                <input type="hidden" id="editId">
                <input type="text" id="mgrName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="text" id="mgrCode" placeholder="Ø§Ù„ÙƒÙˆØ¯ / Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="text" id="mgrPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <input type="text" id="mgrClass" placeholder="Ø§Ù„ÙØµÙ„ (Ù…Ø«Ø§Ù„: 3/1)">
                <button class="btn btn-primary" onclick="processUser()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>
        <div style="max-height:300px; overflow-y:auto;">
            <table class="admin-table">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="adminTableBody"></tbody>
            </table>
        </div>
        <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="document.getElementById('userManagerModal').classList.add('hidden')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="feedbackModal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª</h3>
        <div id="feedbackList"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="document.getElementById('feedbackModal').classList.add('hidden')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<footer>Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ |Ù…Ø³Ø§Ø¹Ø¯Ù‡ (ÙŠØ²Ù† Ø§Ù†Ø³ Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠ & Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ) | 2026</footer>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let appData = { students: [], teachers: [], user: null, activeClass: "", mgrMode: 'student' };
    const WEEKS = Array.from({length: 30}, (_, i) => `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i+1}`);
    document.getElementById('selWeek').innerHTML = WEEKS.map(w => `<option value="${w}">${w}</option>`).join('');

    // Initialization
    function init() {
        db.ref('teachers').on('value', s => { appData.teachers = s.val() ? Object.entries(s.val()).map(([id,v])=>({...v,id})) : []; });
        db.ref('students').on('value', s => { 
            appData.students = s.val() ? Object.entries(s.val()).map(([id,v])=>({...v,id})) : []; 
            if(appData.user) renderGrid();
            if(!document.getElementById('userManagerModal').classList.contains('hidden')) showUserManager(appData.mgrMode);
        });
    }
    init();

    function toggleStaffMode() {
        const p = document.getElementById('uPass');
        p.classList.toggle('hidden');
        document.getElementById('toggleLogin').innerText = p.classList.contains('hidden') ? "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†" : "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨";
    }

    function doLogin() {
        const key = document.getElementById('uKey').value.trim();
        const pass = document.getElementById('uPass').value.trim();

        // 1. Check Super Admin (idarah)
        if(key === 'idarah' && pass === 'idarah2026') {
            appData.user = { name: "Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…", user: "idarah", role: "super_admin" };
            launchApp(); return;
        }
        // 2. Check Admin (ÙˆÙƒÙŠÙ„)
        if(key === 'admin' && pass === 'admin2026') {
            appData.user = { name: "ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©", user: "admin", role: "admin_view" };
            launchApp(); return;
        }
        // 3. Check Teachers
        const t = appData.teachers.find(x => x.user === key && x.pass === pass);
        if(t) { appData.user = t; launchApp(); return; }
        
        // 4. Check Students
        const s = appData.students.find(x => x.code === key);
        if(s) { alert("Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ " + s.name + "! Ù…ÙŠØ²Ø© Ø¹Ø±Ø¶ Ù†Ù‚Ø§Ø· Ø§Ù„Ø·Ù„Ø§Ø¨ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«."); return; }

        alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ø®Ø§Ø·Ø¦Ø©!");
    }

    function launchApp() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('welcomeName').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ " + appData.user.name;
        document.getElementById('roleBadge').innerText = appData.user.role;

        if(appData.user.role === 'super_admin') {
            document.getElementById('idarahModule').classList.remove('hidden');
        }

        setupClasses();
    }

    function setupClasses() {
        let classes = [];
        if(appData.user.role === 'super_admin' || appData.user.role === 'admin_view') {
            classes = ["3/1", "3/2", "3/3", "3/4", "3/5"];
        } else {
            classes = appData.user.assignedClass ? appData.user.assignedClass.split(',') : [];
        }
        
        appData.activeClass = classes[0];
        document.getElementById('classTabs').innerHTML = classes.map(c => 
            `<button class="btn btn-outline" onclick="switchClass('${c}', this)">${c}</button>`
        ).join('');
        renderGrid();
    }

    function switchClass(c, btn) {
        appData.activeClass = c;
        document.querySelectorAll('#classTabs button').forEach(b => b.className = 'btn btn-outline');
        btn.className = 'btn btn-primary';
        renderGrid();
    }

    function renderGrid() {
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = "";
        const w = document.getElementById('selWeek').value;
        const d = document.getElementById('selDay').value;

        const filtered = appData.students.filter(s => s.class === appData.activeClass);
        let done = 0;

        filtered.forEach(s => {
            const rec = (s.records || []).find(r => r.week === w && r.day === d);
            const card = document.createElement('div');
            card.className = `std-card ${rec ? 'done' : ''}`;
            card.innerHTML = `<b>${s.name}</b><br><small>${rec ? rec.status + ' ('+rec.mark+')' : 'Ù„Ù… ÙŠØ±ØµØ¯ Ø¨Ø¹Ø¯'}</small>`;
            card.onclick = () => openGradeModal(s, rec);
            grid.appendChild(card);
            if(rec) done++;
        });

        document.getElementById('statTotal').innerText = filtered.length;
        document.getElementById('statPresent').innerText = done;
        document.getElementById('statAvg').innerText = filtered.length > 0 ? ((done/filtered.length)*100).toFixed(0) + "%" : "0%";
    }

    function openGradeModal(s, rec) {
        if(appData.user.role === 'admin_view') { alert("Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·"); return; }
        appData.activeSID = s.id;
        document.getElementById('stdNameTitle').innerText = s.name;
        document.getElementById('stdInfoSub').innerText = "ÙØµÙ„: " + s.class + " | ÙƒÙˆØ¯: " + s.code;
        
        if(rec) {
            document.getElementById('gSura').value = rec.sura || "";
            document.getElementById('gPage').value = rec.page || "";
            document.getElementById('gMark').value = rec.mark || "";
            document.getElementById('gStatus').value = rec.status || "Ø­Ø§ÙØ¸";
            document.getElementById('gNote').value = rec.note || "";
            document.getElementById('delGradeBtn').classList.remove('hidden');
        } else {
            document.getElementById('gSura').value = "";
            document.getElementById('gPage').value = "";
            document.getElementById('gMark').value = "";
            document.getElementById('gStatus').value = "Ø­Ø§ÙØ¸";
            document.getElementById('gNote').value = "";
            document.getElementById('delGradeBtn').classList.add('hidden');
        }
        document.getElementById('gradeModal').classList.remove('hidden');
    }

    function saveGrade() {
        const s = appData.students.find(x => x.id === appData.activeSID);
        const w = document.getElementById('selWeek').value;
        const d = document.getElementById('selDay').value;
        const newR = {
            week: w, day: d,
            sura: document.getElementById('gSura').value,
            page: document.getElementById('gPage').value,
            mark: document.getElementById('gMark').value,
            status: document.getElementById('gStatus').value,
            note: document.getElementById('gNote').value,
            teacher: appData.user.name,
            ts: Date.now()
        };
        let records = s.records || [];
        const idx = records.findIndex(r => r.week === w && r.day === d);
        if(idx > -1) records[idx] = newR; else records.push(newR);
        
        db.ref('students/'+s.id+'/records').set(records).then(() => { closeModal(); renderGrid(); });
    }

    function deleteGrade() {
        if(!confirm("Ø­Ø°Ù Ø±ØµØ¯ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…ØŸ")) return;
        const s = appData.students.find(x => x.id === appData.activeSID);
        const w = document.getElementById('selWeek').value;
        const d = document.getElementById('selDay').value;
        const records = s.records.filter(r => !(r.week === w && r.day === d));
        db.ref('students/'+s.id+'/records').set(records).then(() => { closeModal(); renderGrid(); });
    }

    // --- Admin Functions (CRUD) ---
    function showUserManager(type) {
        appData.mgrMode = type;
        document.getElementById('mgrTitle').innerText = type === 'student' ? 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨' : 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†';
        document.getElementById('userManagerModal').classList.remove('hidden');
        const list = type === 'student' ? appData.students : appData.teachers;
        
        document.getElementById('adminTableBody').innerHTML = list.map(u => `
            <tr>
                <td>${u.name}</td>
                <td>${u.code || u.user}</td>
                <td>${u.class || u.assignedClass}</td>
                <td>
                    <button class="badge" style="background:var(--secondary); color:white;" onclick="editUser('${u.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="badge" style="background:var(--danger); color:white;" onclick="deleteUser('${u.id}')">Ø­Ø°Ù</button>
                </td>
            </tr>
        `).join('');
    }

    function processUser() {
        const id = document.getElementById('editId').value;
        const data = {
            name: document.getElementById('mgrName').value,
            class: document.getElementById('mgrClass').value, // for student
            assignedClass: document.getElementById('mgrClass').value, // for teacher
            code: document.getElementById('mgrCode').value, // for student
            user: document.getElementById('mgrCode').value, // for teacher
            pass: document.getElementById('mgrPass').value,
            role: 'teacher'
        };

        const path = appData.mgrMode === 'student' ? 'students' : 'teachers';
        if(id) {
            db.ref(`${path}/${id}`).update(data);
        } else {
            db.ref(path).push(data);
        }
        alert("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
        clearMgrForm();
    }

    function editUser(id) {
        const path = appData.mgrMode === 'student' ? appData.students : appData.teachers;
        const u = path.find(x => x.id === id);
        document.getElementById('editId').value = u.id;
        document.getElementById('mgrName').value = u.name;
        document.getElementById('mgrCode').value = u.code || u.user;
        document.getElementById('mgrPass').value = u.pass || "";
        document.getElementById('mgrClass').value = u.class || u.assignedClass;
    }

    function deleteUser(id) {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ")) return;
        const path = appData.mgrMode === 'student' ? 'students' : 'teachers';
        db.ref(`${path}/${id}`).remove();
    }

    function clearMgrForm() {
        document.getElementById('editId').value = "";
        document.getElementById('mgrName').value = "";
        document.getElementById('mgrCode').value = "";
        document.getElementById('mgrPass').value = "";
        document.getElementById('mgrClass').value = "";
    }

    function showFeedbackModal() {
        document.getElementById('feedbackModal').classList.remove('hidden');
        db.ref('feedbacks').once('value', s => {
            const list = document.getElementById('feedbackList');
            list.innerHTML = s.val() ? Object.entries(s.val()).map(([id, f]) => `
                <div class="glass-card" style="font-size:13px;">
                    <b>${f.name}:</b> ${f.msg} <br>
                    <button class="btn-danger" style="padding:2px 10px; font-size:10px;" onclick="db.ref('feedbacks/${id}').remove(); showFeedbackModal();">Ø­Ø°Ù</button>
                </div>
            `).join('') : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„.";
        });
    }

    function wipeData() {
        if(confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙÙ‚Ø· Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ")) {
            appData.students.forEach(s => db.ref('students/'+s.id+'/records').remove());
            alert("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }
    }

    function closeModal() { document.getElementById('gradeModal').classList.add('hidden'); }
</script>
</body>
</html>
