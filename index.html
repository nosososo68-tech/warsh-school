<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© | Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --gold: #d4af37;
            --dark-blue: #1a2a6c;
            --royal-red: #b21f1f;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --bg: #f0f2f5;
            --card: #ffffff;
            --txt: #2c3e50;
            --shadow: 0 12px 24px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: all 0.25s ease; }
        body { background: var(--bg); color: var(--txt); margin: 0; padding: 0; min-height: 100vh; }

        /* Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© ÙƒØ®Ù„ÙÙŠØ© */
        body::before {
            content: "Ø§Ù„Ù…Ø·ÙˆØ±ÙˆÙ†: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ & ÙŠØ²Ù† Ø£Ù†Ø³ & Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ";
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 4rem; opacity: 0.02; z-index: -1; pointer-events: none; width: 150%; text-align: center;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ */
        header {
            background: linear-gradient(135deg, var(--dark-blue), #000);
            color: white; padding: 30px 20px; text-align: center;
            border-bottom: 5px solid var(--gold); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .header-logo { font-size: 2rem; font-weight: 900; margin: 0; letter-spacing: 1px; }
        .dev-badge {
            background: rgba(212, 175, 55, 0.2); border: 1px solid var(--gold);
            padding: 5px 15px; border-radius: 50px; font-size: 0.85rem; display: inline-block; margin-top: 10px;
        }

        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        
        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .card {
            background: var(--card); border-radius: 20px; padding: 30px;
            box-shadow: var(--shadow); margin-bottom: 30px; border-top: 5px solid var(--dark-blue);
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn {
            padding: 14px 24px; border: none; border-radius: 12px; cursor: pointer;
            font-weight: 700; font-size: 1rem; display: inline-flex; align-items: center;
            justify-content: center; gap: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.95); }
        .btn-gold { background: linear-gradient(135deg, var(--gold), #b8860b); color: white; }
        .btn-dark { background: var(--dark-blue); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±ÙŠØ¯ Ù„Ù„Ø·Ù„Ø§Ø¨ */
        .students-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;
        }
        .std-item {
            background: white; border: 2px solid #eee; padding: 20px; border-radius: 15px;
            text-align: center; cursor: pointer; position: relative; overflow: hidden;
        }
        .std-item:hover { border-color: var(--gold); transform: translateY(-5px); }
        .std-item.active-session { border-color: var(--success); background: #f0fff4; }

        /* Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¯Ø±Ø¬Ø§Øª */
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; }
        .status-Ø­Ø§ÙØ¸ { background: #e6fffa; color: #234e52; border: 1px solid #81e6d9; }
        .status-ØºØ§Ø¦Ø¨ { background: #fff5f5; color: #822727; border: 1px solid #feb2b2; }
        .status-Ù…Ø­Ø±ÙˆÙ… { background: #2d3748; color: white; }

        /* Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
        .admin-sidebar { background: #f8f9fa; border-radius: 15px; padding: 15px; margin-bottom: 20px; }
        .stats-row { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card {
            flex: 1; min-width: 150px; background: white; padding: 20px; border-radius: 15px;
            text-align: center; border-bottom: 4px solid var(--gold);
        }

        /* Ø§Ù„ÙÙˆØ±Ù… */
        input, select, textarea {
            width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px;
            border: 1px solid #ddd; background: #fafafa; font-size: 1rem;
        }
        label { font-weight: 700; display: block; margin-top: 10px; color: var(--dark-blue); }

        .hidden { display: none !important; }
        .maintenance-mode {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }

        footer {
            background: #1a202c; color: #a0aec0; padding: 60px 20px; text-align: center; margin-top: 100px;
        }
        .footer-names { color: var(--gold); font-size: 1.2rem; font-weight: 900; margin-bottom: 10px; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .tabs-container { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 20px; }
        .tab-btn {
            white-space: nowrap; padding: 10px 20px; border-radius: 50px; background: #e2e8f0;
            cursor: pointer; font-weight: bold; border: none;
        }
        .tab-btn.active { background: var(--dark-blue); color: white; }

        @media print { .no-print { display: none; } .card { box-shadow: none; border: 1px solid #000; } }
    </style>
</head>
<body>

<div id="m-overlay" class="maintenance-mode hidden">
    <h1 style="font-size: 4rem;">ğŸ› ï¸</h1>
    <h2>Ø§Ù„Ù†Ø¸Ø§Ù… ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø¢Ù†</h2>
    <p>ØªØ·ÙˆÙŠØ±: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ & ÙŠØ²Ù† Ø£Ù†Ø³</p>
    <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
</div>

<header>
    <div class="header-logo">Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ</div>
    <div class="dev-badge">Ù†Ø³Ø®Ø© Ø°Ù‡Ø¨ÙŠØ© v3.5 - 2026</div>
    <div style="margin-top: 15px; font-weight: bold;">
        Ø§Ù„Ù…Ø·ÙˆØ±ÙˆÙ†: <span style="color:var(--gold)">Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡</span> | <span style="color:var(--gold)">ÙŠØ²Ù† Ø£Ù†Ø³</span> | <span style="color:var(--gold)">Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ</span>
    </div>
</header>

<div class="container">

    <div id="sec-login" class="card no-print">
        <h2 style="text-align: center; color: var(--dark-blue);">ğŸ”’ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <div id="admin-msg-box" class="card" style="background: #fff9db; border: 1px solid #ffd43b; font-size: 0.9rem; text-align: center;">
            ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØµØ¯ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³.
        </div>
        <label>Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ / Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input type="text" id="login-user" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…">
        
        <div id="login-pass-div" class="hidden">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>

        <button class="btn btn-gold" style="width: 100%; margin-top: 20px;" onclick="doLogin()">ğŸš€ Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        <button class="btn btn-dark" style="width: 100%; margin-top: 10px;" onclick="togglePassField()">ØªØ¨Ø¯ÙŠÙ„ (Ù…Ø¹Ù„Ù…/Ø·Ø§Ù„Ø¨)</button>
    </div>

    <div id="sec-app" class="hidden">
        
        <div id="dash-teacher" class="hidden">
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø§Ù„Ù…Ø¹Ù„Ù…: <span id="display-teacher-name" style="color: var(--gold);"></span></h3>
                    <button class="btn btn-danger" onclick="doLogout()">Ø®Ø±ÙˆØ¬</button>
                </div>

                <div id="idarah-only" class="hidden">
                    <div class="admin-sidebar" style="background: #fff0f0; border: 2px dashed var(--royal-red);">
                        <h4 style="color: var(--royal-red); margin-top: 0;">ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ (Idarah)</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <button class="btn btn-dark" onclick="switchPage('page-management')">ğŸ”§ ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
                            <button class="btn btn-dark" onclick="toggleMaint()">âš ï¸ Ù‚ÙÙ„/ÙØªØ­ Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
                            <button class="btn btn-dark" onclick="showAllPasswords()">ğŸ”‘ ÙƒØ´Ù Ø§Ù„Ø³Ø±</button>
                            <button class="btn btn-success" onclick="exportData()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <small>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</small>
                        <div id="stat-total" style="font-size: 1.5rem; font-weight: 900;">0</div>
                    </div>
                    <div class="stat-card">
                        <small>ØªÙ… Ø§Ù„Ø±ØµØ¯ Ø§Ù„ÙŠÙˆÙ…</small>
                        <div id="stat-done" style="font-size: 1.5rem; font-weight: 900; color: var(--success);">0</div>
                    </div>
                    <div class="stat-card">
                        <small>Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†</small>
                        <div id="stat-absent" style="font-size: 1.5rem; font-weight: 900; color: var(--danger);">0</div>
                    </div>
                </div>

                <div class="card" style="background: #f8fafc;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <label>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
                            <select id="sel-week" onchange="refreshGrid()"></select>
                        </div>
                        <div>
                            <label>Ø§Ù„ÙŠÙˆÙ…</label>
                            <select id="sel-day" onchange="refreshGrid()">
                                <option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
                                <option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
                            </select>
                        </div>
                        <div>
                            <label>Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</label>
                            <input type="text" id="std-search" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." oninput="refreshGrid()">
                        </div>
                    </div>
                </div>

                <div class="tabs-container" id="class-tabs"></div>
                <div class="students-grid" id="main-grid"></div>
            </div>
        </div>

        <div id="page-grading" class="hidden card">
            <button class="btn btn-dark" onclick="switchPage('dash-teacher')">ğŸ”™ Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø³Ù…Ø§Ø¡</button>
            <hr>
            <h2 id="grade-student-name">--</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ØµØ¯</label>
                    <input type="text" id="grade-time" disabled>
                    <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                    <select id="grade-status">
                        <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
                        <option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
                        <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
                        <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
                        <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option>
                    </select>
                </div>
                <div>
                    <label>Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©</label>
                    <input type="number" id="grade-page">
                    <label>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© (0-7)</label>
                    <input type="number" id="grade-mark" max="7" min="0">
                </div>
            </div>
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</label>
            <textarea id="grade-note" rows="3"></textarea>
            <div style="margin: 15px 0;">
                <input type="checkbox" id="grade-call" style="width: auto;"> 
                <span style="color: var(--danger); font-weight: bold;">ØªÙ†Ø¨ÙŠÙ‡: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆÙ„ÙŠ Ø£Ù…Ø±ØŸ</span>
            </div>
            <button class="btn btn-success" style="width: 100%;" onclick="submitGrade()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ</button>
            
            <h3 style="margin-top: 40px;">ğŸ“œ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨ (ÙŠÙ…Ø¯ÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù)</h3>
            <div id="grade-history"></div>
        </div>

        <div id="page-management" class="hidden card">
            <button class="btn btn-dark" onclick="switchPage('dash-teacher')">ğŸ”™ Ø¹ÙˆØ¯Ø©</button>
            <h2>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Idarah Control</h2>
            <div class="card" style="background: #f1f5f9;">
                <h4>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙØµÙ„</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <input type="text" id="new-std-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
                    <input type="text" id="new-std-code" placeholder="Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹: 3311)">
                    <select id="new-std-class">
                        <option>3/1</option><option>3/2</option><option selected>3/3</option>
                        <option>3/4</option><option>3/5</option>
                    </select>
                </div>
                <button class="btn btn-gold" onclick="addNewStudent()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
            </div>
            <div id="full-user-list"></div>
        </div>

        <div id="page-student" class="hidden">
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center;">
                    <h2 id="std-view-name"></h2>
                    <button class="btn btn-danger" onclick="doLogout()">Ø®Ø±ÙˆØ¬</button>
                </div>
                <div id="std-call-alert" class="hidden alert-box" style="background: #fff5f5; color: #c53030; padding: 20px; border-radius: 10px; border-right: 8px solid #c53030; margin-bottom: 20px;">
                    âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…: ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ø±ÙÙ‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª.
                </div>
                <div class="stats-row">
                    <div class="stat-card" style="border-color: var(--success);">
                        <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙØ¸</small>
                        <div id="std-stat-pages" style="font-size: 1.5rem; font-weight: 900;">0</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--danger);">
                        <small>Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</small>
                        <div id="std-stat-abs" style="font-size: 1.5rem; font-weight: 900;">0</div>
                    </div>
                </div>
                <h3>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙØµÙ„:</h3>
                <div id="std-report-list"></div>
                <button class="btn btn-dark" style="width: 100%; margin-top: 20px;" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>
        </div>

    </div>
</div>

<footer>
    <div class="footer-names">Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯ & ÙŠØ²Ù† Ø£Ù†Ø³ Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠ & Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ</div>
    <p>Â© 2026 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ</p>
    <p style="font-size: 0.7rem; opacity: 0.5;">ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ© Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´</p>
</footer>

<script>
// --- CORE ENGINE (Ù…ØµØ·ÙÙ‰ & ÙŠØ²Ù†) ---

const firebaseConfig = { 
    apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", 
    databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let state = {
    students: [],
    user: null,
    currentClass: "3/3",
    currentSID: null,
    sessions: {} 
};

const WEEKS = Array.from({length: 35}, (_, i) => `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i+1}`);

// INITIALIZATION
function initSystem() {
    // Fill Weeks
    const weekHTML = WEEKS.map(w => `<option value="${w}">${w}</option>`).join('');
    document.getElementById('sel-week').innerHTML = weekHTML;

    // Listen to Maintenance
    db.ref('maintenance').on('value', s => {
        if(s.val() && (!state.user || state.user.role !== 'admin')) {
            document.getElementById('m-overlay').classList.remove('hidden');
        } else {
            document.getElementById('m-overlay').classList.add('hidden');
        }
    });

    // Listen to Students
    db.ref('students').on('value', s => {
        const val = s.val();
        if(val) {
            state.students = Object.entries(val).map(([id, data]) => ({id, ...data}));
            refreshGrid();
            updateGlobalStats();
        } else {
            // Seed initial data if empty
            seedData();
        }
    });

    // Setup Basic Staff
    db.ref('staff/idarah').update({user:'idarah', pass:'idarah2026', role:'admin', classes:'Ø§Ù„ÙƒÙ„'});
    db.ref('staff/saad').update({user:'saad', pass:'saad2026', role:'teacher', classes:'Ø§Ù„ÙƒÙ„'});
    db.ref('staff/ibrahim').update({user:'ibrahim', pass:'ibrahim2026', role:'teacher', classes:'3/3'});
}

// NAVIGATION
function switchPage(id) {
    document.querySelectorAll('#sec-app > div').forEach(d => d.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo(0,0);
}

function togglePassField() {
    document.getElementById('login-pass-div').classList.toggle('hidden');
}

// LOGIN LOGIC
function doLogin() {
    const user = document.getElementById('login-user').value.trim();
    const pass = document.getElementById('login-pass').value.trim();
    const isStaff = !document.getElementById('login-pass-div').classList.contains('hidden');

    if(isStaff) {
        db.ref('staff/' + user).once('value', s => {
            const v = s.val();
            if(v && v.pass === pass) {
                state.user = v;
                renderClassTabs();
                document.getElementById('display-teacher-name').innerText = v.user;
                if(v.role === 'admin') document.getElementById('idarah-only').classList.remove('hidden');
                document.getElementById('sec-login').classList.add('hidden');
                document.getElementById('sec-app').classList.remove('hidden');
                switchPage('dash-teacher');
            } else alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©");
        });
    } else {
        const std = state.students.find(x => x.code === user);
        if(std) {
            state.user = { role: 'student', data: std };
            showStudentReport(std);
            document.getElementById('sec-login').classList.add('hidden');
            document.getElementById('sec-app').classList.remove('hidden');
            switchPage('page-student');
        } else alert("ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„");
    }
}

// TEACHER FUNCTIONS
function renderClassTabs() {
    const cls = ["3/1", "3/2", "3/3", "3/4", "3/5"];
    let h = "";
    cls.forEach(c => {
        if(state.user.classes === "Ø§Ù„ÙƒÙ„" || state.user.classes.includes(c)) {
            h += `<button class="tab-btn ${state.currentClass===c?'active':''}" onclick="changeClass('${c}')">${c}</button>`;
        }
    });
    document.getElementById('class-tabs').innerHTML = h;
}

function changeClass(c) {
    state.currentClass = c;
    renderClassTabs();
    refreshGrid();
}

function refreshGrid() {
    const grid = document.getElementById('main-grid');
    grid.innerHTML = "";
    const search = document.getElementById('std-search').value.toLowerCase();
    const w = document.getElementById('sel-week').value;
    const d = document.getElementById('sel-day').value;

    const filtered = state.students.filter(s => s.class === state.currentClass && s.name.toLowerCase().includes(search));
    
    filtered.forEach(s => {
        const div = document.createElement('div');
        div.className = 'std-item';
        
        const rec = (s.records || []).find(r => r.week === w && r.day === d);
        if(state.sessions[s.id]) div.classList.add('active-session');
        
        let statusTag = rec ? `<span class="badge status-${rec.status.replace(" ","-")}">${rec.status}</span>` : '<span style="color:#ccc">Ù„Ù… ÙŠØ±ØµØ¯</span>';
        
        div.innerHTML = `
            <div style="font-weight:900;">${s.name}</div>
            <div style="font-size:0.8rem; color:#666; margin:5px 0;">${s.code}</div>
            ${statusTag}
            <div style="font-size:0.75rem; margin-top:5px; color:var(--dark-blue)">${rec ? 'ØµÙ€ ' + rec.page : ''}</div>
        `;
        div.onclick = () => openGrading(s);
        grid.appendChild(div);
    });
    updateDashStats(filtered, w, d);
}

function updateDashStats(list, w, d) {
    const total = list.length;
    const done = list.filter(s => (s.records || []).some(r => r.week === w && r.day === d)).length;
    const abs = list.filter(s => (s.records || []).some(r => r.week === w && r.day === d && r.status === 'ØºØ§Ø¦Ø¨')).length;
    
    document.getElementById('stat-total').innerText = total;
    document.getElementById('stat-done').innerText = done;
    document.getElementById('stat-absent').innerText = abs;
}

// GRADING LOGIC
function openGrading(s) {
    state.currentSID = s.id;
    document.getElementById('grade-student-name').innerText = s.name;
    document.getElementById('grade-time').value = new Date().toLocaleDateString('ar-SA');
    switchPage('page-grading');
    renderHistory(s);
}

function submitGrade() {
    const s = state.students.find(x => x.id === state.currentSID);
    const recs = s.records || [];
    
    const data = {
        week: document.getElementById('sel-week').value,
        day: document.getElementById('sel-day').value,
        status: document.getElementById('grade-status').value,
        page: document.getElementById('grade-page').value,
        mark: document.getElementById('grade-mark').value,
        note: document.getElementById('grade-note').value,
        isCall: document.getElementById('grade-call').checked,
        teacher: state.user.user,
        timestamp: new Date().getTime()
    };

    const idx = recs.findIndex(r => r.week === data.week && r.day === data.day);
    if(idx > -1) recs[idx] = data;
    else recs.push(data);

    state.sessions[s.id] = true;
    db.ref('students/' + s.id + '/records').set(recs).then(() => {
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±ØµØ¯ Ø¨Ù†Ø¬Ø§Ø­");
        switchPage('dash-teacher');
    });
}

function renderHistory(s) {
    const h = (s.records || []).slice().reverse().map((r, i) => `
        <div class="card" style="margin-bottom:10px; border-right: 5px solid var(--gold);">
            <div style="display:flex; justify-content:space-between;">
                <b>${r.week} - ${r.day}</b>
                <button class="btn-danger" style="padding:4px 8px; font-size:0.7rem;" onclick="deleteRec('${s.id}', ${s.records.length-1-i})">Ø­Ø°Ù</button>
            </div>
            <div>Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status} | ØµÙØ­Ø©: ${r.page} | Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.mark}</div>
            <div style="font-size:0.8rem; color:#888;">Ø¨ÙˆØ§Ø³Ø·Ø©: ${r.teacher || 'Ø§Ù„Ù†Ø¸Ø§Ù…'}</div>
        </div>
    `).join('');
    document.getElementById('grade-history').innerHTML = h || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©";
}

function deleteRec(sid, idx) {
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±ØµØ¯ØŸ")) {
        const s = state.students.find(x => x.id === sid);
        s.records.splice(idx, 1);
        db.ref('students/'+sid+'/records').set(s.records).then(() => renderHistory(s));
    }
}

// STUDENT VIEW
function showStudentReport(s) {
    document.getElementById('std-view-name').innerText = s.name;
    const recs = s.records || [];
    
    const hasCall = recs.some(r => r.isCall);
    if(hasCall) document.getElementById('std-call-alert').classList.remove('hidden');

    const totalPages = recs.reduce((sum, r) => sum + (parseInt(r.page) || 0), 0);
    const totalAbs = recs.filter(r => r.status === 'ØºØ§Ø¦Ø¨').length;

    document.getElementById('std-stat-pages').innerText = totalPages;
    document.getElementById('std-stat-abs').innerText = totalAbs;

    document.getElementById('std-report-list').innerHTML = recs.slice().reverse().map(r => `
        <div class="card" style="border-right: 8px solid ${r.status==='Ø­Ø§ÙØ¸'?'var(--success)':'var(--danger)'}">
            <div style="display:flex; justify-content:space-between;">
                <strong>${r.week} - ${r.day}</strong>
                <span class="badge">${r.status}</span>
            </div>
            <p>Ø§Ù„Ù…Ù‚Ø¯Ø§Ø±: ØµÙØ­Ø© ${r.page} | Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.mark}/7</p>
            <p style="font-style:italic; color:#666;">Ù…Ù„Ø§Ø­Ø¸Ø©: ${r.note || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
        </div>
    `).join('');
}

// ADMIN FUNCTIONS (Idarah)
function toggleMaint() {
    db.ref('maintenance').once('value', s => db.ref('maintenance').set(!s.val()));
}

function addNewStudent() {
    const n = document.getElementById('new-std-name').value;
    const c = document.getElementById('new-std-code').value;
    const cl = document.getElementById('new-std-class').value;
    if(n && c) {
        db.ref('students').push({name: n, code: c, class: cl, records: []});
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    }
}

function showAllPasswords() {
    db.ref('staff').once('value', s => {
        let txt = "ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ± Ø§Ù„Ø·Ø§Ù‚Ù…:\n";
        Object.values(s.val()).forEach(u => txt += `${u.user}: ${u.pass}\n`);
        alert(txt);
    });
}

function doLogout() {
    state.user = null;
    state.sessions = {};
    location.reload();
}

function seedData() {
    const list = [
        {name: "Ø§Ø­Ù…Ø¯ Ø¹Ù…Ø± Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3326", class: "3/3"},
        {name: "Ø¨Ø³Ø§Ù… Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3370", class: "3/3"},
        {name: "Ø¨Ø´Ø§Ø± Ø±Ø§Ù…Ø² ÙƒÙ†Ø¹Ø§Ù†", code: "3355", class: "3/3"},
        {name: "ØªÙ…ÙŠÙ… Ù†ÙˆØ± Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3309", class: "3/3"},
        {name: "Ø­Ø³ÙŠÙ† Ø¹Ø¨Ø¯Ø§Ù„ÙƒØ±ÙŠÙ… Ø¨Ù† Ø¨Ø§Ø¯ÙŠ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3358", class: "3/3"},
        {name: "Ø®Ø§Ù„Ø¯ Ø³Ù„ÙŠÙ… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3393", class: "3/3"},
        {name: "Ø±Ø§Ø¦Ø¯ ÙØ§ÙŠØ² Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ", code: "3301", class: "3/3"},
        {name: "Ø±ÙŠØ§Ù† Ø¹Ø·Ø§Ù„Ù„Ù‡ Ø¹Ø¨ÙŠØ§Ù† Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3389", class: "3/3"},
        {name: "Ø³Ø§Ù…Ø± Ø¹Ù…Ø± Ø¨Ù† Ø¯Ø®ÙŠÙ„ Ø§Ù„Ù„Ù‡ Ø§Ù„ØµØ§Ø¹Ø¯ÙŠ", code: "3259", class: "3/3"},
        {name: "Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3302", class: "3/3"},
        {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ", code: "3357", class: "3/3"},
        {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø£Ù…ÙŠÙ† Ø­Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙƒÙŠ", code: "3392", class: "3/3"},
        {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø¤Ù…Ù† Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„Ø´Ù‡ÙŠØ¯", code: "3379", class: "3/3"},
        {name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù†Ø§ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ø¬Ù†ÙŠ", code: "3304", class: "3/3"},
        {name: "Ø¹Ù…Ø§Ø± Ø£Ø­Ù…Ø¯ Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3399", class: "3/3"},
        {name: "Ø¹Ù…Ø± Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£Ù…ÙŠÙ† â€“ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø´ÙŠØ±", code: "3310", class: "3/3"},
        {name: "ØºØ§Ù†Ù… ØµÙ„Ø§Ø­ ØºØ§Ù†Ù… Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3391", class: "3/3"},
        {name: "ÙØ±Ø§Ø³ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code: "3322", class: "3/3"},
        {name: "ÙÙ‡Ø¯ Ù…Ø­Ù…Ø¯ ÙˆØµÙ„ Ø§Ù„Ø²Ø±ÙØ§Ù†ÙŠ", code: "3300", class: "3/3"},
        {name: "ÙÙŠØµÙ„ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ø§Ø·Ø± Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ", code: "3366", class: "3/3"},
        {name: "ÙÙŠØµÙ„ Ø­Ø³Ø§Ù… Ø§Ù„Ø¯ÙŠÙ† â€“ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙ†", code: "3300", class: "3/3"},
        {name: "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code: "3349", class: "3/3"},
        {name: "Ù…Ø®ØªØ§Ø± Ø­Ù…ÙˆØ¯ ÙˆØ£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯Ø³Ø¹Ø¯ ÙˆØ§Ù„Ù…Ø­Ù…Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±", code: "3359", class: "3/3"},
        {name: "Ù…Ø®ØªØ§Ø± Ø±Ø¨ÙŠØ¹ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙˆÙ„Ø¯ Ø§Ø¨Ø§Ù‡", code: "3365", class: "3/3"},
        {name: "Ù…ØµØ·ÙÙ‰ Ù…Ø®ØªØ§Ø± Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø®ØªØ§Ø±", code: "3396", class: "3/3"},
        {name: "Ù…Ø¤ÙŠØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ù‚ÙˆÙŠÙ… Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ù‡Ù†Ø¯ÙŠ", code: "3389", class: "3/3"},
        {name: "Ù†ÙˆØ§Ù Ø¹Ù…Ø± Ø¨Ù† Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ", code: "3395", class: "3/3"},
        {name: "Ù‡Ø§Ø´Ù… Ø£Ø­Ù…Ø¯ Ø¨Ù† ØµØ§Ù„Ø­ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡", code: "3388", class: "3/3"},
        {name: "ÙŠØ­ÙŠÙ‰ Ø£Ø­Ù…Ø¯ Ø²ÙŠÙ† ÙˆÙ„Ø¯ Ù…Ø­Ù…Ø¯ ÙˆÙ„Ø¯ Ù…Ø®ØªØ§Ø±", code: "3344", class: "3/3"}
    ];
    list.forEach(s => db.ref('students').push(s));
}

// Start
initSystem();
</script>
</body>
</html>
