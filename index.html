<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ | ØªØ·ÙˆÙŠØ± ÙŠØ²Ù† ÙˆÙ…ØµØ·ÙÙ‰ ÙˆÙ…Ø­Ù…Ø¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --p: #1e4d2b; --g: #d4af37; --bg: #f4f7f6; --card: #ffffff; --txt: #333; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--txt); margin: 0; padding: 10px; direction: rtl; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 10px auto; max-width: 550px; border-top: 5px solid var(--g); }
        .btn { padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; font-size: 16px; }
        .btn-p { background: var(--p); color: white; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
        .grid-item { background: var(--p); color: white; padding: 10px; border-radius: 12px; cursor: pointer; font-size: 11px; text-align: center; height: 60px; display: flex; align-items: center; justify-content: center; }
        .progress-box { background: rgba(30, 77, 43, 0.05); border: 2px solid var(--p); border-radius: 15px; padding: 15px; margin: 10px 0; text-align: center; }
        .progress-box h1 { margin: 5px 0; color: var(--p); font-size: 35px; }
        .honor-roll { background: #fffde7; border: 1px solid #fbc02d; padding: 10px; border-radius: 12px; margin-bottom: 10px; font-size: 13px; }
        .footer { font-size: 11px; opacity: 0.7; margin-top: 20px; text-align: center; border-top: 1px solid #ddd; padding-top: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app">
    <div id="mainMenu" class="card">
        <h2 style="color:var(--p); text-align:center;">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ ğŸ“š</h2>
        <input type="number" id="studentCode" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ø·Ø§Ù„Ø¨">
        <button class="btn btn-p" onclick="studentLogin()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" style="background:#455a64; color:white;" onclick="showScreen('staffLogin')">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        <div class="footer">ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: Ù…ØµØ·ÙÙ‰ ÙˆÙŠØ²Ù† ÙˆÙ…Ø­Ù…Ø¯</div>
    </div>

    <div id="studentPage" class="hidden card">
        <div class="honor-roll">ğŸ† <b>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ…ÙŠØ² (Ø£ÙØ¶Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨):</b> <marquee id="topStudents" scrollamount="4"></marquee></div>
        <h3 id="welcomeMsg" style="color:var(--p)"></h3>
        <p id="devMsg" style="font-size:12px; background:#e8f5e9; padding:8px; border-radius:8px;"></p>
        <div class="progress-box">
            <span id="targetLabel">Ù…Ù‚Ø±Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
            <h1 id="weekCounter">0 / 4</h1>
            <small id="currentWeekDisplay"></small>
        </div>
        <div id="missingRecords" class="hidden" style="color:red; font-size:12px; margin-bottom:10px;">âš ï¸ Ù„Ø¯ÙŠÙƒ Ø¯Ø±ÙˆØ³ Ù„Ù… ØªÙØ­ÙØ¸ Ø¨Ø¹Ø¯!</div>
        <h4>Ø³Ø¬Ù„ Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ:</h4>
        <div id="recordsList" style="max-height:200px; overflow-y:auto;"></div>
        <button class="btn btn-p" onclick="showScreen('mainMenu')">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="teacherDash" class="hidden card" style="max-width:800px;">
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° Ø³Ø¹Ø¯ ğŸ› ï¸</h3>
        <div style="background:#eee; padding:10px; border-radius:10px; margin-bottom:10px;">
            <div style="display:flex; gap:5px;">
                <input type="number" id="globalWeekNum" placeholder="Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹">
                <input type="number" id="weeklyTarget" placeholder="Ø§Ù„Ù…Ù‚Ø±Ø± (Ù…Ø«Ù„Ø§Ù‹ 5)">
            </div>
            <button class="btn btn-p" onclick="updateSettings()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-p" onclick="loadClass('3/1')">ÙØµÙ„ 3/1</button>
            <button class="btn btn-p" onclick="loadClass('3/2')">ÙØµÙ„ 3/2</button>
        </div>
        <div id="namesGrid" class="grid" style="margin-top:10px;"></div>
        <button class="btn" onclick="showScreen('mainMenu')">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <h3 id="targetName"></h3>
        <input type="text" id="gDay" placeholder="Ø§Ù„ÙŠÙˆÙ…">
        <input type="number" id="gPage" placeholder="Ø§Ù„ØµÙØ­Ø©">
        <select id="gStatus">
            <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
            <option value="Ù„Ù… ÙŠØ­ÙØ¸">Ù„Ù… ÙŠØ­ÙØ¸ âš ï¸</option>
            <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
        </select>
        <input type="checkbox" id="isLate"> Ø¯Ø±Ø³ Ù…ØªØ£Ø®Ø±
        <button class="btn btn-p" onclick="saveGrade()">Ø­ÙØ¸</button>
        <button class="btn" onclick="showScreen('teacherDash')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div id="staffLogin" class="hidden card">
        <input type="text" id="user" placeholder="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-p" onclick="staffAuth()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" onclick="showScreen('mainMenu')">Ø±Ø¬ÙˆØ¹</button>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    const allStudents = [
        // ÙØµÙ„ 3/2
        {id:3278, name:"Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø­Ø§Ø±Ø«ÙŠ", code:3278, class:"3/2"}, {id:3214, name:"Ø§Ù†Ø³ Ù…Ø­Ù…Ø¯ Ø¹ÙŠØ³Ù‰", code:3214, class:"3/2"}, {id:3291, name:"ØªÙŠØ³ÙŠØ± Ø±Ø¶Ø§ Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠ", code:3291, class:"3/2"},
        {id:3246, name:"Ø­Ø³Ø§Ù† Ø³Ù„ÙŠÙ…Ø§Ù† Ø§Ù„Ø¬Ø§Ø¨Ø±ÙŠ", code:3246, class:"3/2"}, {id:3283, name:"Ø­Ø³Ù† Ø¹Ø¨Ø¯Ù‡", code:3283, class:"3/2"}, {id:3209, name:"Ø¹Ø§Ù…Ø± ÙŠÙˆØ³Ù Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code:3209, class:"3/2"},
        {id:3267, name:"Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ù…Ø§Ø¬Ø¯ Ø§Ù„Ø±Ø®ÙŠÙ…ÙŠ", code:3267, class:"3/2"}, {id:3235, name:"Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø¹Ù…Ø± Ø§Ù„Ø±ÙˆÙŠØ«ÙŠ", code:3235, class:"3/2"}, {id:3298, name:"Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† ØµØºÙŠØ±", code:3298, class:"3/2"},
        {id:3218, name:"Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø­ÙƒÙ…ÙŠ", code:3218, class:"3/2"}, {id:3271, name:"Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ù…Ø±ÙˆØ§Ù†", code:3271, class:"3/2"}, {id:3242, name:"Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙÙ‡Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code:3242, class:"3/2"},
        {id:3289, name:"Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø¨Ø¯Ø± Ø§Ù„Ø¹ÙˆÙÙŠ", code:3289, class:"3/2"}, {id:3226, name:"Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ù‡Ø§Ø¯ÙŠ Ø§Ù„Ø¹Ù…Ø±ÙŠ", code:3226, class:"3/2"}, {id:3275, name:"Ø¹Ø¨Ø¯Ø§Ù„Ù…Ù„Ùƒ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code:3275, class:"3/2"},
        {id:3207, name:"Ø¹Ø¨Ø¯Ø§Ù„Ù…Ù„Ùƒ Ø¹ÙŠØ§Ø¯Ù‡ Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code:3207, class:"3/2"}, {id:3294, name:"Ø¹Ù…Ø§Ø¯ Ø­Ù…Ø¯Ø§Ù† Ø§Ù„Ø§Ø­Ù…Ø¯ÙŠ", code:3294, class:"3/2"}, {id:3231, name:"Ø¹Ù…Ø± Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø³Ù‡Ù„ÙŠ", code:3231, class:"3/2"},
        {id:3260, name:"Ø¹Ù…Ø± Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø³Ø§Ø¹Ø¯ÙŠ", code:3260, class:"3/2"}, {id:3281, name:"ÙÙŠØµÙ„ Ù‚ÙˆØ´ÙŠØ­", code:3281, class:"3/2"}, {id:3212, name:"Ù„Ø²Ø§Ù… Ù…Ø§Ù‡Ø± Ø§Ø¨Ùˆ Ø­Ø³ÙŠÙ†", code:3212, class:"3/2"},
        {id:3279, name:"Ù…Ø§Ù„Ùƒ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code:3279, class:"3/2"}, {id:3249, name:"Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ Ø§Ù„Ø£Ù…ÙŠÙ†", code:3249, class:"3/2"}, {id:3290, name:"Ù…Ø­Ù…Ø¯ Ø§Ù„ØªØ±Ø§Ø¯", code:3290, class:"3/2"},
        {id:3205, name:"Ù…Ø­Ù…Ø¯ Ø¨Ù†Ø¯Ø± Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code:3205, class:"3/2"}, {id:3264, name:"Ù…Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code:3264, class:"3/2"}, {id:3286, name:"Ù…Ø­Ù…Ø¯ Ø³Ø¹ÙŠØ¯ Ø§Ù„Ø¬Ù‡Ù†ÙŠ", code:3286, class:"3/2"},
        {id:3223, name:"Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code:3223, class:"3/2"}, {id:3273, name:"Ù…Ø­Ù…Ø¯ Ù…Ù†ÙˆØ± Ø§Ù„Ø¹Ù†Ø²ÙŠ", code:3273, class:"3/2"}, {id:3216, name:"Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ø­Ù…Ø¯", code:3216, class:"3/2"},
        {id:3210, name:"ÙŠØ²Ù† Ø§Ù†Ø³ Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠ", code:3210, class:"3/2"},
        // ÙØµÙ„ 3/1
        {id:3101, name:"Ø§Ø­Ù…Ø¯ Ø¨ÙƒØ± Ø³ÙŠÙƒÙˆ Ø¬ÙŠØ§Ù†ÙŠ", code:3101, class:"3/1"}, {id:3102, name:"Ø§Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯ Ø­Ù…Ø¯Ø§Ù† Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ", code:3102, class:"3/1"}, {id:3103, name:"Ø§Ø­Ù…Ø¯ Ù†Ø§ØµØ± Ø§Ø­Ù…Ø¯ Ø¹Ù…Ø±", code:3103, class:"3/1"},
        {id:3104, name:"Ø§Ø³Ø§Ù…Ù‡ Ø§Ø¨Ø§Ù‡ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£Ù…ÙŠÙ†", code:3104, class:"3/1"}, {id:3105, name:"Ø§Ù…ÙŠÙ† Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code:3105, class:"3/1"}, {id:3106, name:"Ø£Ù…ÙŠÙ† Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ø·ÙŠÙ Ù…Ø­Ù…Ø¯", code:3106, class:"3/1"},
        {id:3107, name:"Ø£Ù†Ø³ Ø­ÙŠØ¯Ø± ÙŠØ­ÙŠÙ‰ Ù†Ø®ÙŠÙÙŠ", code:3107, class:"3/1"}, {id:3108, name:"Ø§ÙŠØ§Ø¯ Ø­Ù…Ø²Ù‡ Ø±Ø§Ø¬Ø­ Ø§Ù„Ø§Ø­Ù…Ø¯ÙŠ", code:3108, class:"3/1"}, {id:3109, name:"ØªÙ…ÙŠÙ… Ø·Ø§Ø±Ù‚ Ø¨Ù† Ø³Ø¹ÙŠØ¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ", code:3109, class:"3/1"},
        {id:3110, name:"ØªÙ…ÙŠÙ… ÙÙ‡Ø¯ Ø¨Ù† Ø¬Ø²Ø§Ø¡ Ø§Ù„ØªÙ…ÙŠÙ…ÙŠ", code:3110, class:"3/1"}, {id:3111, name:"Ø¬Ù‡Ø§Ø¯ Ù…Ø´Ø¹Ù„ Ø³Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø¯Ø§Ø¯ÙŠ", code:3111, class:"3/1"}, {id:3112, name:"Ø­Ù…Ø²Ù‡ Ù…Ø­Ù…Ø¯ Ù†ÙˆØ± Ø±ÙŠØ§Ø¶ Ø´Ø§Ù‡ÙŠÙ†", code:3112, class:"3/1"},
        {id:3113, name:"Ø±Ø§Ø´Ø¯ Ø¹Ù…Ø± Ø¨Ù† Ø¹Ù„ÙŠ Ø§Ù„Ø§Ø­Ù…Ø¯ÙŠ", code:3113, class:"3/1"}, {id:3114, name:"Ø±ÙŠØ§Ù† Ù…Ø­Ù…Ø¯ Ø¬Ø§Ø¨Ø± Ù…Ø­Ù…Ø¯", code:3114, class:"3/1"}, {id:3115, name:"Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­ÙŠÙ… Ù…Ø­Ù…Ø¯ Ø§Ù„Ø§Ù…ÙŠÙ† Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code:3115, class:"3/1"},
        {id:3116, name:"Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø¨Ø®Ø§Ø±ÙŠ", code:3116, class:"3/1"}, {id:3117, name:"Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ø¬Ø²Ø§Ø¡ Ø§Ù„ØªÙ…ÙŠÙ…ÙŠ", code:3117, class:"3/1"}, {id:3118, name:"Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…ÙˆØ¯ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code:3118, class:"3/1"},
        {id:3119, name:"Ø¹Ø¨Ø¯Ø§Ù„Ù…Ù„Ùƒ Ø³Ø¹Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ø±ÙŠØ¯Ù‡", code:3119, class:"3/1"}, {id:3120, name:"Ø¹Ù…Ø± Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø­Ø¶ÙŠØ¶ Ø§Ù„ØªÙ…ÙŠÙ…ÙŠ", code:3120, class:"3/1"}, {id:3121, name:"Ø¹Ù…Ø± Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù…Ø±ÙŠ", code:3121, class:"3/1"},
        {id:3122, name:"Ø¹Ù…Ø± Ø¹Ø¨Ø¯Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ø­Ù…Ø¯ Ø¨ÙƒØ§Ø±ÙŠ", code:3122, class:"3/1"}, {id:3123, name:"Ù‚Ø§Ø³Ù… Ø¨Ù†Ø¯Ø± Ø¨Ù† Ù‚Ø§Ø³Ù… Ø§Ù„Ø§Ù†ØµØ§Ø±ÙŠ", code:3123, class:"3/1"}, {id:3124, name:"Ù‚ØµÙŠ Ø³Ø¹Ø¯ÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø«ÙŠÙ…ÙŠÙ†ÙŠ", code:3124, class:"3/1"},
        {id:3125, name:"Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code:3125, class:"3/1"}, {id:3126, name:"Ù…Ø­Ù…Ø¯ Ù…Ø®ØªØ§Ø± Ø¨Ù† Ù…Ø­Ù…Ø¯ ÙˆÙ„Ø¯ Ø§Ø¨Ø§", code:3126, class:"3/1"}, {id:3127, name:"Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø§Ø¨Ø¯ Ø§Ø­Ù…Ø¯ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code:3127, class:"3/1"},
        {id:3128, name:"Ù…ØµØ·ÙÙ‰ Ø¹Ù…Ø± Ø¨Ù† Ø§Ù„Ø£Ù…ÙŠÙ† Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code:3128, class:"3/1"}, {id:3129, name:"Ù…Ø¹Ø§Ø° Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·ÙŠØ¨ Ø§Ù„ÙˆÙ„ÙŠ", code:3129, class:"3/1"}, {id:3130, name:"Ù…Ø¹Ø§Ø° Ø§Ù„Ø§Ù…ÙŠÙ† Ø¨Ù† Ø®Ø¶Ø± Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ", code:3130, class:"3/1"}
    ];

    let students = [];
    let settings = { currentWeek: 1, target: 4 };

    db.ref('students').on('value', s => { 
        if(!s.exists()) db.ref('students').set(allStudents);
        students = Object.values(s.val() || {});
        updateHonorRoll();
    });
    db.ref('settings').on('value', s => { if(s.exists()) settings = s.val(); });

    function studentLogin() {
        const code = document.getElementById('studentCode').value;
        const s = students.find(x => x.code == code);
        if(s) {
            document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${s.name} ğŸŒ¿`;
            document.getElementById('devMsg').innerText = "Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø£Ù†Ø§ ÙˆÙŠØ²Ù† ÙˆÙ…Ø­Ù…Ø¯ Ø¨ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø®ØµÙŠØµØ§Ù‹ Ù„Ùƒ ÙˆÙ„Ø²Ù…Ù„Ø§Ø¦Ùƒ.";
            renderStudentRecords(s);
            showScreen('studentPage');
        } else alert('Ø§Ù„Ù…ÙØªØ§Ø­ Ø®Ø§Ø·Ø¦!');
    }

    function updateSettings() {
        const w = document.getElementById('globalWeekNum').value;
        const t = document.getElementById('weeklyTarget').value;
        db.ref('settings').set({ currentWeek: w || settings.currentWeek, target: t || settings.target });
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
    }

    function saveGrade() {
        const sIdx = students.findIndex(x => x.id == currentSID);
        const rec = { week: settings.currentWeek, day: document.getElementById('gDay').value, page: document.getElementById('gPage').value, status: document.getElementById('gStatus').value, isLate: document.getElementById('isLate').checked };
        if(!students[sIdx].records) students[sIdx].records = [];
        students[sIdx].records.unshift(rec);
        db.ref('students').set(students).then(() => { alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); showScreen('teacherDash'); });
    }

    function renderStudentRecords(s) {
        document.getElementById('currentWeekDisplay').innerText = `Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${settings.currentWeek}`;
        const weekRecs = (s.records || []).filter(r => r.week == settings.currentWeek && !r.isLate && r.status === "Ø­Ø§ÙØ¸");
        document.getElementById('weekCounter').innerText = `${weekRecs.length} / ${settings.target}`;
        
        document.getElementById('recordsList').innerHTML = (s.records || []).map(r => `
            <div style="padding:8px; margin:5px 0; background:#f9f9f9; border-radius:8px; border-right:4px solid ${r.status==='Ø­Ø§ÙØ¸'?'green':'red'}">
                Ø£Ø³Ø¨ÙˆØ¹ ${r.week} - Øµ ${r.page} | ${r.status} ${r.isLate?'(Ù…ØªØ£Ø®Ø±)':''}
            </div>
        `).join('');
    }

    function updateHonorRoll() {
        const sorted = [...students].sort((a,b) => (b.records?.filter(r=>r.status==='Ø­Ø§ÙØ¸').length || 0) - (a.records?.filter(r=>r.status==='Ø­Ø§ÙØ¸').length || 0));
        document.getElementById('topStudents').innerText = sorted.slice(0, 20).map((s, i) => `${i+1}. ${s.name}`).join(' | ');
    }

    function staffAuth() {
        if(document.getElementById('user').value === 'saad' && document.getElementById('pass').value === '12345678w') showScreen('teacherDash');
        else alert('Ø®Ø·Ø£');
    }

    function loadClass(cls) {
        const grid = document.getElementById('namesGrid'); grid.innerHTML = "";
        students.filter(x => x.class === cls).forEach(s => {
            const div = document.createElement('div'); div.className = "grid-item"; div.innerText = s.name;
            div.onclick = () => { currentSID = s.id; document.getElementById('targetName').innerText = s.name; showScreen('gradeScreen'); };
            grid.appendChild(div);
        });
    }

    function showScreen(id) {
        document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
