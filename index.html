<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ù…Ø·ÙˆØ± - Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #1e4d2b; --secondary: #4a7c44; --gold: #d4af37; --white: #ffffff; --bg: #fdfaf5; --danger: #c0392b; }
        .theme-blue { --primary: #0a192f; --secondary: #112240; --gold: #64ffda; --bg: #f0f4f8; }
        .theme-orange { --primary: #d35400; --secondary: #e67e22; --gold: #c0392b; --bg: #fff5e6; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background-color: var(--bg); margin: 0; padding: 20px; text-align: center; }
        #lockScreen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .glass-card { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); width: 90%; max-width: 400px; border: 3px solid var(--gold); }
        .container { max-width: 800px; margin: auto; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; border-bottom: 5px solid var(--gold); }
        .btn { padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; width: 100%; margin: 5px 0; font-size: 16px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .hidden { display: none !important; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #eee; border-radius: 10px; text-align: center; font-size: 16px; }
        .st-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 15px 0; }
        .stat-box { padding: 10px; border-radius: 10px; color: white; font-size: 12px; font-weight: bold; }
        .history-item { text-align: right; padding: 10px; border: 1px solid #eee; margin: 5px 0; border-radius: 10px; font-size: 14px; position: relative; }
        .edit-tool { position: absolute; left: 10px; top: 10px; display: flex; gap: 5px; }
        .bar-chart { display: flex; align-items: flex-end; justify-content: space-around; height: 150px; margin-top: 20px; }
        .bar { width: 30px; background: var(--primary); border-radius: 5px 5px 0 0; position: relative; }
        .bar-label { position: absolute; bottom: -25px; font-size: 10px; width: 100%; }
        footer { margin-top: 30px; font-size: 11px; color: #777; }
    </style>
</head>
<body id="bodyTag">

<div id="lockScreen">
    <div class="glass-card">
        <h2>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´</h2>
        <input type="password" id="siteKey" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ">
        <button class="btn btn-primary" onclick="unlockSite()">ÙØªØ­ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        <p style="font-size: 11px;">Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯</p>
    </div>
</div>

<div class="container hidden" id="mainApp">
    <header>
        <h3 style="color: var(--primary);">Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´</h3>
        <p style="font-size: 12px; font-weight: bold; color: var(--gold);">Ø¥Ø´Ø±Ø§Ù Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯</p>
    </header>

    <div id="roleSelection">
        <div class="card">
            <button class="btn btn-primary" onclick="showScreen('loginScreen')">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„Ø£Ø³ØªØ§Ø° Ø³Ø¹Ø¯)</button>
            <button class="btn btn-secondary" onclick="showScreen('studentPortal')">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        </div>
        <div class="card">
            <h4>ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ†</h4>
            <div class="bar-chart" id="honorChart"></div>
        </div>
    </div>

    <div id="studentPortal" class="hidden card">
        <h4>Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</h4>
        <select id="selStudentClass" onchange="fillStudentList('selStudentClass', 'selStudentName')">
            <option value="">Ø§Ø®ØªØ± ÙØµÙ„Ùƒ</option>
            <option value="3/1">ÙØµÙ„ 3/1</option>
            <option value="3/2">ÙØµÙ„ 3/2</option>
        </select>
        <select id="selStudentName" class="hidden"><option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ</option></select>
        <button id="btnViewReport" class="btn btn-primary hidden" onclick="viewStudentReport()">Ø¹Ø±Ø¶ Ù…Ù„ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</button>
        <button class="btn" onclick="showScreen('roleSelection')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="studentReport" class="hidden">
        <div class="card">
            <h3 id="reportTitle">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
            <div class="stats-grid">
                <div class="stat-box" style="background: #e67e22;">Ù„Ù… ÙŠØ­ÙØ¸: <span id="statFail">0</span></div>
                <div class="stat-box" style="background: #c0392b;">Ù…Ø­Ø±ÙˆÙ…: <span id="statBanned">0</span></div>
                <div class="stat-box" style="background: #7f8c8d;">ØºØ§Ø¦Ø¨: <span id="statAbs">0</span></div>
            </div>
            <hr>
            <h4>Ø³Ø¬Ù„ Ø§Ù„ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®ÙŠØ±:</h4>
            <div id="reportHistory"></div>
        </div>
        <button class="btn btn-secondary" onclick="showScreen('studentPortal')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¨Ø­Ø«</button>
    </div>

    <div id="loginScreen" class="card hidden">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
        <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-primary" onclick="teacherLogin()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" onclick="showScreen('roleSelection')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="teacherDash" class="hidden">
        <div class="card">
            <input type="text" id="stName" placeholder="Ø§Ø³Ù… Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯">
            <select id="stClass"><option value="3/1">3/1</option><option value="3/2">3/2</option></select>
            <button class="btn btn-primary" onclick="addStudent()">Ø¥Ø¶Ø§ÙØ©</button>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-secondary" onclick="loadClass('3/1')">Ø·Ù„Ø§Ø¨ 3/1</button>
                <button class="btn btn-secondary" onclick="loadClass('3/2')">Ø·Ù„Ø§Ø¨ 3/2</button>
            </div>
        </div>
        <div id="classStudentsList" class="card hidden"></div>
        <button class="btn" onclick="showScreen('roleSelection')">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="gradingPage" class="hidden card">
        <h3 id="activeStName">Ø§Ù„Ø§Ø³Ù…</h3>
        <input type="number" id="rPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
        <select id="rStatus">
            <option value="Ø­ÙØ¸">Ø­ÙØ¸ âœ…</option>
            <option value="Ù„Ù… ÙŠØ­ÙØ¸">Ù„Ù… ÙŠØ­ÙØ¸ âŒ</option>
            <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… â›”</option>
            <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
        </select>
        <select id="rScore">
            <option value="0">0 (Ø¨Ø¯ÙˆÙ† Ø¯Ø±Ø¬Ø©)</option>
            <option value="7">7 - Ù…Ù…ØªØ§Ø²</option>
            <option value="6">6 - Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</option>
            <option value="5">5 - Ù…Ù‚Ø¨ÙˆÙ„</option>
            <option value="4">4 - Ø¶Ø¹ÙŠÙ</option>
        </select>
        <textarea id="rNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª.."></textarea>
        <button class="btn btn-primary" id="btnSaveRecord" onclick="saveRecord()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø­Ø§Ø¨</button>
        <button class="btn btn-secondary" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <hr>
        <h4>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„):</h4>
        <div id="editHistory"></div>
    </div>

    <footer>
        <p>ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯ | Ø¬ÙˆØ§Ù„: 0599804296</p>
    </footer>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let students = [];
    let currentStId = null;
    let editIndex = null;

    function loadData() {
        db.ref('students').on('value', (snapshot) => {
            students = snapshot.val() || [];
            renderChart();
        });
    }
    loadData();

    function saveData() { db.ref('students').set(students); }

    function unlockSite() {
        if(document.getElementById('siteKey').value === "2026") {
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');
        } else { alert("Ø§Ù„Ø±Ù…Ø² Ø®Ø·Ø£!"); }
    }

    function showScreen(id) {
        document.querySelectorAll('.container > div').forEach(d => { if(d.id !== 'roleSelection' && d.tagName !== 'HEADER' && d.tagName !== 'FOOTER') d.classList.add('hidden'); });
        document.getElementById('roleSelection').classList.toggle('hidden', id !== 'roleSelection');
        if(id !== 'roleSelection') document.getElementById(id).classList.remove('hidden');
    }

    function teacherLogin() {
        if(document.getElementById('username').value === 'saad' && document.getElementById('password').value === '1234567891011s') {
            showScreen('teacherDash');
        } else { alert("Ø®Ø·Ø£!"); }
    }

    function fillStudentList(classSelId, nameSelId) {
        const cls = document.getElementById(classSelId).value;
        const nameSel = document.getElementById(nameSelId);
        nameSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù…</option>';
        if(!cls) { nameSel.classList.add('hidden'); return; }
        students.filter(s => s.class === cls).forEach(s => {
            nameSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
        nameSel.classList.remove('hidden');
        if(classSelId === 'selStudentClass') document.getElementById('btnViewReport').classList.remove('hidden');
    }

    function viewStudentReport() {
        const id = document.getElementById('selStudentName').value;
        if(!id) return;
        const s = students.find(x => x.id == id);
        document.getElementById('reportTitle').innerText = s.name;
        const records = s.records || [];
        document.getElementById('statFail').innerText = records.filter(r => r.status === 'Ù„Ù… ÙŠØ­ÙØ¸').length;
        document.getElementById('statBanned').innerText = records.filter(r => r.status === 'Ù…Ø­Ø±ÙˆÙ…').length;
        document.getElementById('statAbs').innerText = records.filter(r => r.status === 'ØºØ§Ø¦Ø¨').length;
        
        const historyDiv = document.getElementById('reportHistory');
        historyDiv.innerHTML = records.length ? "" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.";
        records.forEach(r => {
            historyDiv.innerHTML += `<div class="history-item">ğŸ“… ${r.date} | Øµ: ${r.page} | Ø§Ù„Ø­Ø§Ù„Ø©: <b>${r.status}</b> | Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.score} <br> ğŸ“ ${r.note || '-'}</div>`;
        });
        showScreen('studentReport');
    }

    function loadClass(cls) {
        const list = document.getElementById('classStudentsList');
        list.classList.remove('hidden');
        list.innerHTML = `<h4>ÙØµÙ„ ${cls}</h4>`;
        students.filter(s => s.class === cls).forEach(s => {
            list.innerHTML += `<div class="st-row"><span>${s.name}</span><div><button class="btn btn-secondary" style="width:auto;" onclick="openGrading(${s.id})">ØªØ³Ù…ÙŠØ¹/ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn btn-danger" style="width:auto;" onclick="deleteStudent(${s.id})">Ø­Ø°Ù</button></div></div>`;
        });
    }

    function openGrading(id) {
        currentStId = id;
        editIndex = null;
        const s = students.find(x => x.id == id);
        document.getElementById('activeStName').innerText = s.name;
        document.getElementById('btnSaveRecord').innerText = "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø­Ø§Ø¨";
        refreshEditHistory(s);
        showScreen('gradingPage');
    }

    function refreshEditHistory(s) {
        const div = document.getElementById('editHistory');
        div.innerHTML = "";
        (s.records || []).forEach((r, idx) => {
            div.innerHTML += `<div class="history-item">${r.date} - Ø¯Ø±Ø¬Ø©: ${r.score} <div class="edit-tool"><button onclick="startEdit(${idx})" style="color:blue">ØªØ¹Ø¯ÙŠÙ„</button><button onclick="deleteRecord(${idx})" style="color:red">Ø­Ø°Ù</button></div></div>`;
        });
    }

    function saveRecord() {
        const sIdx = students.findIndex(x => x.id == currentStId);
        const record = {
            date: new Date().toLocaleDateString('ar-SA'),
            page: document.getElementById('rPage').value,
            status: document.getElementById('rStatus').value,
            score: document.getElementById('rScore').value,
            note: document.getElementById('rNote').value
        };
        if(!students[sIdx].records) students[sIdx].records = [];
        if(editIndex !== null) students[sIdx].records[editIndex] = record;
        else students[sIdx].records.unshift(record);
        saveData();
        alert("ØªÙ… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ âœ…");
        showScreen('teacherDash');
    }

    function startEdit(idx) {
        editIndex = idx;
        const s = students.find(x => x.id == currentStId);
        const r = s.records[idx];
        document.getElementById('rPage').value = r.page;
        document.getElementById('rStatus').value = r.status;
        document.getElementById('rScore').value = r.score;
        document.getElementById('rNote').value = r.note;
        document.getElementById('btnSaveRecord').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ";
        window.scrollTo(0,0);
    }

    function deleteRecord(idx) {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø¬Ø©ØŸ")) {
            const sIdx = students.findIndex(x => x.id == currentStId);
            students[sIdx].records.splice(idx, 1);
            saveData();
            openGrading(currentStId);
        }
    }

    function addStudent() {
        const n = document.getElementById('stName').value;
        const c = document.getElementById('stClass').value;
        if(n) { students.push({id: Date.now(), name: n, class: c, records: []}); saveData(); document.getElementById('stName').value=""; }
    }

    function deleteStudent(id) { if(confirm("Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) { students = students.filter(s => s.id != id); saveData(); } }

    function renderChart() {
        const chart = document.getElementById('honorChart');
        chart.innerHTML = "";
        let top = students.map(s => ({
            name: s.name,
            total: (s.records || []).reduce((a, b) => a + parseInt(b.score || 0), 0)
        })).filter(s => s.total > 0).sort((a,b) => b.total - a.total).slice(0, 5);
        if(!top.length) { chart.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªÙÙˆÙ‚ÙˆÙ†"; return; }
        top.forEach(s => {
            let h = (s.total / top[0].total) * 100;
            chart.innerHTML += `<div class="bar" style="height:${h}%"><span style="font-size:9px; top:-15px; position:absolute;">${s.total}</span><span class="bar-label">${s.name.split(' ')[0]}</span></div>`;
        });
    }
</script>
</body>
</html> 
