<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ | ØªØ·ÙˆÙŠØ± Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #f4f7f6; --card: #ffffff; --p: #2c3e50; --g: #27ae60; --txt: #2c3e50; --red: #e74c3c; --orange: #f39c12; --blue: #3498db; --yellow: #f1c40f; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--txt); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 700px; margin: 10px 0; position: relative; border: 1px solid rgba(0,0,0,0.05); }
        .mustafa-tag { color: var(--g); font-weight: bold; font-size: 13px; text-align: center; display: block; margin: 10px 0; }
        .btn { padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-tech { background: var(--g); color: white; }
        .btn-back { background: rgba(0,0,0,0.1); color: var(--txt); width: auto; padding: 5px 15px; font-size: 12px; position: absolute; top: 10px; right: 10px; z-index: 100; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; background: white; font-size: 14px; }
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
        .grid-item { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid var(--g); cursor: pointer; font-weight: bold; }
        .history-item { background: rgba(0,0,0,0.03); padding: 15px; border-radius: 15px; margin-bottom: 10px; border-right: 5px solid var(--g); position: relative; text-align: right; }
        footer { margin-top: auto; padding: 20px; font-size: 12px; color: #777; text-align: center; }
        @media print { .btn, .btn-back, #gradeForm, #passChangeSec, .mustafa-tag { display: none !important; } .card { box-shadow: none; border: 1px solid #000; } }
    </style>
</head>
<body>

<div id="loginGate" class="card">
    <div class="mustafa-tag">| Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ |</div>
    <h2 style="text-align:center;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ›¡ï¸</h2>
    <input type="text" id="entryKey" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (Ù„Ù„Ø·Ø§Ù„Ø¨) Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <div id="staffSection" class="hidden">
        <input type="password" id="entryPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    </div>
    <button class="btn btn-tech" onclick="mainAuth()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    <button class="btn" style="background:transparent; color:var(--g);" onclick="document.getElementById('staffSection').classList.toggle('hidden')">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ø¯Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</button>
</div>

<div id="app" class="hidden" style="width:100%; max-width:700px;">
    
    <div id="studentPage" class="hidden card">
        <button class="btn btn-back" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        <h3 id="welcomeMsg"></h3>
        <div id="recordsList"></div>
    </div>

    <div id="teacherDash" class="hidden card">
        <button class="btn btn-back" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        <div id="roleDisplay" class="mustafa-tag"></div>
        
        <div id="passChangeSec" style="background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:10px;">
            <input type="password" id="newTeacherPass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©" style="width:60%; display:inline-block;">
            <button class="btn btn-tech" style="width:35%; display:inline-block; padding:10px;" onclick="updateMyPass()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø±</button>
        </div>

        <input type="text" id="searchBox" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø·Ø§Ù„Ø¨..." oninput="filterGrid()">
        <div id="classTabs" style="display:flex; gap:10px; margin:10px 0; flex-wrap: wrap;"></div>
        <div id="namesGrid" class="grid"></div>
        <button id="adminBtn" class="btn hidden" style="background:#2c3e50; color:white; margin-top:20px;" onclick="showManagePage()">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3 id="targetName" style="color:var(--g)"></h3>
        <div id="gradeForm">
            <select id="gWeek"></select>
            <select id="gDay">
                <option>ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯</option><option>ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³</option>
            </select>
            <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
            <input type="number" id="gMark" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© / 7">
            <select id="gStatus">
                <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option><option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
                <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option><option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option><option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
            </select>
            <textarea id="gNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø·Ø§Ù„Ø¨..."></textarea>
            <button class="btn btn-tech" id="saveBtn" onclick="saveGrade()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <button class="btn" onclick="window.print()" style="background:var(--blue); color:white;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        <hr>
        <h4 id="historyTitle">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</h4>
        <div id="editHistory"></div>
    </div>

    <div id="managePage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</h3>
        
        <div id="idarahOnly" class="hidden" style="border:2px solid var(--red); padding:10px; border-radius:10px; margin-bottom:15px;">
            <p style="color:var(--red); font-weight:bold;">ğŸ› ï¸ ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø®Ø§Øµ Ø¨Ø­Ø³Ø§Ø¨ idarah)</p>
            <input type="text" id="tUser" placeholder="ÙŠÙˆØ²Ø± Ø§Ù„Ù…Ø¹Ù„Ù…">
            <input type="text" id="tPass" placeholder="Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…">
            <select id="tClassAssign"></select>
            <button class="btn btn-tech" onclick="addNewTeacher()">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù… Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <h4>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨:</h4>
        <input type="text" id="newSName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
        <input type="text" id="newSCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
        <select id="newSClass"></select>
        <button class="btn btn-tech" onclick="addNewStudent()">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        <hr>
        <div id="fullList"></div>
    </div>
</div>

<footer><b>ØªØ·ÙˆÙŠØ±: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯ | 0599804296</b></footer>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let students = [], classes = ["3/1", "3/2", "3/3", "3/4", "3/5"], teachers = [];
    let currentSID = null, currentUser = null, currentTID = null;

    const weeksArr = ["Ø§Ù„Ø£ÙˆÙ„","Ø§Ù„Ø«Ø§Ù†ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø«","Ø§Ù„Ø±Ø§Ø¨Ø¹","Ø§Ù„Ø®Ø§Ù…Ø³","Ø§Ù„Ø³Ø§Ø¯Ø³","Ø§Ù„Ø³Ø§Ø¨Ø¹","Ø§Ù„Ø«Ø§Ù…Ù†","Ø§Ù„ØªØ§Ø³Ø¹","Ø§Ù„Ø¹Ø§Ø´Ø±","Ø§Ù„Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ø´Ø±","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø±"];
    document.getElementById('gWeek').innerHTML = weeksArr.map(w => `<option value="Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}</option>`).join('');

    function init() {
        db.ref('teachers').on('value', s => {
            const data = s.val();
            teachers = data ? Object.entries(data).map(([id, val]) => ({...val, tid: id})) : [];
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯
            if(!teachers.find(t=>t.user==='idarah')) db.ref('teachers').push({user:'idarah', pass:'idrah2026', role:'super_admin'});
            if(!teachers.find(t=>t.user==='admin')) db.ref('teachers').push({user:'admin', pass:'admin2026', role:'school_admin'});
            if(!teachers.find(t=>t.user==='saad')) db.ref('teachers').push({user:'saad', pass:'saad2026', role:'teacher', assignedClass:'3/3'});
        });
        db.ref('students').on('value', snap => {
            const data = snap.val();
            students = data ? Object.entries(data).map(([id, val]) => ({...val, id: id})) : [];
        });
        updateSelectors();
    }
    init();

    function updateSelectors() {
        const options = classes.map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('tClassAssign').innerHTML = options;
        document.getElementById('newSClass').innerHTML = options;
    }

    function mainAuth() {
        const key = document.getElementById('entryKey').value.trim();
        const pass = document.getElementById('entryPass').value.trim();
        const isStaff = !document.getElementById('staffSection').classList.contains('hidden');

        if (isStaff) {
            const t = teachers.find(x => x.user === key && x.pass === pass);
            if(t) { 
                currentUser = t; 
                currentTID = t.tid;
                setupDash(); 
            } else alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©");
        } else {
            const std = students.find(x => x.code === key);
            if (std) { currentSID = std.id; showScreen('studentPage'); renderStudentRecords(std); }
            else alert("ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­");
        }
    }

    function updateMyPass() {
        const newPass = document.getElementById('newTeacherPass').value;
        if(newPass.length < 4) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©");
        db.ref('teachers/' + currentTID).update({pass: newPass}).then(() => alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­"));
    }

    function setupDash() {
        showScreen('teacherDash');
        document.getElementById('roleDisplay').innerText = `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser.user}`;
        if (currentUser.role === 'super_admin' || currentUser.role === 'school_admin') {
            document.getElementById('adminBtn').classList.remove('hidden');
        }
        const tabs = document.getElementById('classTabs'); tabs.innerHTML = "";
        const myClasses = (currentUser.role === 'super_admin' || currentUser.role === 'school_admin') ? classes : [currentUser.assignedClass];
        myClasses.forEach(c => {
            const btn = document.createElement('button'); btn.className = 'btn btn-tech'; btn.innerText = `ÙØµÙ„ ${c}`;
            btn.style.width = "auto";
            btn.onclick = () => loadClass(c); tabs.appendChild(btn);
        });
    }

    function loadClass(cls) {
        const g = document.getElementById('namesGrid'); g.innerHTML = "";
        students.filter(x => x.class === cls).forEach(s => {
            const d = document.createElement('div'); d.className = 'grid-item'; d.innerText = s.name;
            d.onclick = () => {
                currentSID = s.id;
                document.getElementById('targetName').innerText = s.name;
                if(currentUser.role === 'school_admin') document.getElementById('gradeForm').classList.add('hidden');
                else document.getElementById('gradeForm').classList.remove('hidden');
                renderEditHistory(s);
                showScreen('gradeScreen');
            };
            g.appendChild(d);
        });
    }

    function saveGrade(idx = null) {
        const s = students.find(x => x.id == currentSID);
        if(!s.records) s.records = [];
        const rec = {
            week: document.getElementById('gWeek').value,
            day: document.getElementById('gDay').value,
            page: document.getElementById('gPage').value,
            mark: document.getElementById('gMark').value,
            status: document.getElementById('gStatus').value,
            note: document.getElementById('gNote').value
        };
        if(idx !== null) s.records[idx] = rec; else s.records.push(rec);
        db.ref('students/'+currentSID+'/records').set(s.records).then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); showScreen('teacherDash'); });
    }

    function renderEditHistory(s) {
        document.getElementById('editHistory').innerHTML = (s.records || []).map((r, i) => `
            <div class="history-item">
                <b>${r.week}</b> - ${r.status} 
                ${currentUser.role !== 'school_admin' ? `<button onclick="delRec(${i})" style="color:red; border:none; background:none;">[Ø­Ø°Ù]</button>` : ''}
            </div>`).reverse().join('');
    }

    function showManagePage() {
        showScreen('managePage');
        if(currentUser.role === 'super_admin') document.getElementById('idarahOnly').classList.remove('hidden');
        else document.getElementById('idarahOnly').classList.add('hidden');

        document.getElementById('fullList').innerHTML = students.map(s => `
            <div class="history-item"><b>${s.name}</b> (ÙƒÙˆØ¯: ${s.code})
                <button onclick="editStudentInfo('${s.id}')" style="color:blue; float:left;">ØªØ¹Ø¯ÙŠÙ„</button>
                <button onclick="delStudent('${s.id}')" style="color:red; float:left; margin-left:10px;">Ø­Ø°Ù</button>
            </div>`).join('');
    }

    function editStudentInfo(id) {
        const s = students.find(x => x.id === id);
        document.getElementById('newSName').value = s.name;
        document.getElementById('newSCode').value = s.code;
        document.getElementById('newSClass').value = s.class;
        currentSID = id;
    }

    function addNewStudent() {
        const name = document.getElementById('newSName').value, code = document.getElementById('newSCode').value, cls = document.getElementById('newSClass').value;
        if(name && code) {
            const id = currentSID || Date.now().toString();
            db.ref('students/'+id).update({id, name, code, class: cls}).then(()=> { alert("ØªÙ… Ø¨Ù†Ø¬Ø§Ø­"); currentSID = null; showManagePage(); });
        }
    }

    function addNewTeacher() {
        const user = document.getElementById('tUser').value, pass = document.getElementById('tPass').value, cls = document.getElementById('tClassAssign').value;
        if(user && pass) db.ref('teachers').push({user, pass, assignedClass: cls, role:'teacher'}).then(()=> alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù…"));
    }

    function renderStudentRecords(s) {
        document.getElementById('welcomeMsg').innerText = "Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨: " + s.name;
        document.getElementById('recordsList').innerHTML = (s.records || []).map(r => `
            <div class="history-item"><b>${r.week} - ${r.day}</b><br>Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status} | Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.mark}/7</div>`).reverse().join('');
    }

    function delStudent(id) { if(confirm("Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) db.ref('students/'+id).remove(); }
    function delRec(i) { if(confirm("Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ")) { const s = students.find(x => x.id == currentSID); s.records.splice(i,1); db.ref('students/'+currentSID+'/records').set(s.records); } }
    function showScreen(id) { document.querySelectorAll('#app > div, #loginGate').forEach(d => d.classList.add('hidden')); document.getElementById('app').classList.remove('hidden'); document.getElementById(id).classList.remove('hidden'); }
    function filterGrid() { const q = document.getElementById('searchBox').value.toLowerCase(); document.querySelectorAll('.grid-item').forEach(i => i.style.display = i.innerText.toLowerCase().includes(q) ? 'block' : 'none'); }
</script>
</body>
</html>
