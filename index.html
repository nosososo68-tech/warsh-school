<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ÙˆØ±Ø´ v5 | Ultra Enterprise</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #059669; --primary-light: #ecfdf5; --dark: #1e293b;
            --danger: #e11d48; --warning: #f59e0b; --bg: #f8fafc; --card: #ffffff;
            --radius: 24px;
        }

        .theme-dark { --primary: #10b981; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --primary-light: rgba(16,185,129,0.1); }
        .theme-royal { --primary: #8b5cf6; --bg: #f5f3ff; --card: #ffffff; --text: #2e1065; --primary-light: #ede9fe; }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .glass-card { background: var(--card); border-radius: var(--radius); padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; overflow: hidden; }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-box { background: var(--primary); color: white; padding: 15px; border-radius: 18px; text-align: center; }
        .stat-box h4 { margin: 0; font-size: 22px; }
        .stat-box span { font-size: 12px; opacity: 0.8; }

        /* Student List */
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .std-card { background: var(--card); border: 2px solid transparent; border-radius: var(--radius); padding: 18px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.03); position: relative; }
        .std-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .std-card.done { border-color: var(--primary); background: var(--primary-light); }
        .badge { position: absolute; top: 10px; right: 10px; font-size: 18px; }

        /* Tabs & Controls */
        .tabs { display: flex; gap: 8px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .btn { padding: 12px 20px; border-radius: 15px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* Admin & Feedback */
        .feedback-item { background: var(--bg); padding: 15px; border-radius: 15px; border-right: 5px solid var(--primary); margin-bottom: 10px; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: var(--card); width: 100%; max-width: 700px; border-radius: 30px; padding: 35px; max-height: 90vh; overflow-y: auto; }

        input, select, textarea { width: 100%; padding: 14px; border-radius: 15px; border: 1.5px solid #e2e8f0; margin-top: 8px; background: var(--bg); color: var(--text); }
        .hidden { display: none !important; }
        
        footer { text-align: center; padding: 40px; opacity: 0.6; font-size: 12px; }
    </style>
</head>
<body class="theme-modern">

<div class="container">
    <div id="loginSection" class="glass-card" style="max-width:450px; margin: 80px auto; text-align:center;">
        <h1 style="color:var(--primary); font-weight: 800; font-size: 32px; margin-bottom: 5px;">WARSH ULTRA</h1>
        <p style="opacity: 0.6; margin-bottom: 25px;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ 2026</p>
        
        <div class="theme-picker" style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
            <div onclick="setTheme('theme-modern')" style="width:30px; height:30px; background:#2563eb; border-radius:50%; cursor:pointer;"></div>
            <div onclick="setTheme('theme-dark')" style="width:30px; height:30px; background:#10b981; border-radius:50%; cursor:pointer;"></div>
            <div onclick="setTheme('theme-royal')" style="width:30px; height:30px; background:#8b5cf6; border-radius:50%; cursor:pointer;"></div>
        </div>

        <input type="text" id="uKey" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
        <input type="password" id="uPass" class="hidden" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø³Ø±ÙŠØ©">
        <button class="btn btn-primary" style="width:100%; margin-top:20px; height:55px;" onclick="doLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <p id="toggleLogin" style="margin-top:20px; font-size:14px; color:var(--primary); cursor:pointer; font-weight:700;" onclick="toggleStaffMode()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</p>
    </div>

    <div id="mainApp" class="hidden">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <div>
                <h2 id="welcomeName" style="margin:0">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
                <span id="roleLabel" style="font-size:12px; font-weight:700; color:var(--primary)"></span>
            </div>
            <button class="btn btn-outline" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </header>

        <div id="teacherModule" class="hidden">
            <div class="stats-grid">
                <div class="stat-box"> <h4 id="statPresent">0</h4> <span>Ø§Ù„Ù…Ø±ØµÙˆØ¯ÙŠÙ†</span> </div>
                <div class="stat-box" style="background:var(--dark)"> <h4 id="statTotal">0</h4> <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span> </div>
                <div class="stat-box" style="background:var(--warning)"> <h4 id="statAvg">0</h4> <span>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡</span> </div>
            </div>

            <div class="glass-card" style="background:var(--dark); color:white; padding:15px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <select id="selWeek" onchange="renderGrid()"></select>
                    <select id="selDay" onchange="renderGrid()">
                        <option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
                    </select>
                </div>
            </div>

            <div class="tabs" id="classTabs" style="margin-bottom:20px;"></div>
            <div id="mainGrid" class="student-grid"></div>
        </div>

        <div id="adminModule" class="hidden">
            <div class="glass-card">
                <h3 style="margin-top:0">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ (idarah)</h3>
                <div id="teacherMonitor" style="margin-bottom:20px;"></div>
                <button class="btn btn-primary" onclick="showFeedbackModal()">ÙØªØ­ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª</button>
                <button class="btn btn-outline" style="margin-top:10px; border-color:var(--danger); color:var(--danger)" onclick="wipeData()">ØªØµÙÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>

        <div id="studentModule" class="hidden">
            <div class="glass-card" style="text-align:center; background: linear-gradient(135deg, var(--primary), #059669);">
                <h2 style="color:white; margin:0;" id="stdTotalPoints">0</h2>
                <p style="color:white; opacity:0.8; margin:0;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù†Ù‚Ø§Ø·Ùƒ</p>
            </div>
            <div class="glass-card">
                <h3>Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
                <textarea id="stdFeedback" placeholder="Ø§ÙƒØªØ¨ Ø§Ù‚ØªØ±Ø§Ø­Ùƒ Ø£Ùˆ Ù…Ø´ÙƒÙ„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                <button class="btn btn-primary" style="margin-top:10px;" onclick="sendFeedback()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†</button>
            </div>
            <h3>ØªØ§Ø±ÙŠØ® Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ</h3>
            <div id="stdHistory"></div>
        </div>
    </div>
</div>

<div id="gradeModal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 id="stdNameTitle" style="color:var(--primary); margin-top:0;"></h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div>
                <label>Ø§Ù„Ø³ÙˆØ±Ø© / (ÙŠÙØ¹Ù…Ù…)</label>
                <input type="text" id="gSura" oninput="globalSura = this.value">
            </div>
            <div>
                <label>Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© (ÙŠÙØ¹Ù…Ù…)</label>
                <input type="text" id="gPage" oninput="globalPage = this.value">
            </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px;">
            <div>
                <label>Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ù† 7</label>
                <input type="number" id="gMark" max="7" min="0">
           <div>
    <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸</label>
    <select id="gStatus">
        <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
        <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
        <option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
        <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option>
        <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
    </select>
</div>
        </div>
        <textarea id="gNote" style="margin-top:15px;" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø®Ø§ØµØ©..."></textarea>
        
        <div style="display:flex; gap:10px; margin-top:25px;">
            <button class="btn btn-primary" style="flex:2" onclick="saveGrade()">Ø­ÙØ¸ ÙˆØ±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø©</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <hr style="margin:25px 0; opacity:0.1;">
        <h4>Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨:</h4>
        <div id="historyLogs"></div>
    </div>
</div>

<div id="feedbackModal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰</h3>
        <div id="feedbackList"></div>
        <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="document.getElementById('feedbackModal').classList.add('hidden')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<footer>Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø§Ø­Ù…Ø¯ |Ù…Ø³Ø§Ø¹Ø¯Ù‡ Ùˆ ØªÙ†Ø³ÙŠÙ‚ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø´Ù†Ù‚ÙŠØ·ÙŠ & ÙŠØ²Ù† Ø§Ù†Ø³ Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠ | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚Ø© v5.0</footer>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let appData = { students: [], teachers: [], user: null, activeClass: "3/1" };
    let globalPage = "", globalSura = "";

    const WEEKS = Array.from({length: 30}, (_, i) => `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${["Ø§Ù„Ø£ÙˆÙ„","Ø§Ù„Ø«Ø§Ù†ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø«","Ø§Ù„Ø±Ø§Ø¨Ø¹","Ø§Ù„Ø®Ø§Ù…Ø³","Ø§Ù„Ø³Ø§Ø¯Ø³","Ø§Ù„Ø³Ø§Ø¨Ø¹","Ø§Ù„Ø«Ø§Ù…Ù†","Ø§Ù„ØªØ§Ø³Ø¹","Ø§Ù„Ø¹Ø§Ø´Ø±","Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ø´Ø±","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¯Ø³ Ø¹Ø´Ø±","Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù…Ù† Ø¹Ø´Ø±","Ø§Ù„ØªØ§Ø³Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø­Ø§Ø¯ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù„Ø« ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø±Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø®Ø§Ù…Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø³Ø§Ø¯Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø³Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ø§Ù…Ù† ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„ØªØ§Ø³Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†","Ø§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†"][i]}`);
    document.getElementById('selWeek').innerHTML = WEEKS.map(w => `<option value="${w}">${w}</option>`).join('');

    function setTheme(t) { document.body.className = t; }

    function init() {
        db.ref('teachers').on('value', s => { appData.teachers = s.val() ? Object.entries(s.val()).map(([id,v])=>({...v,id})) : []; });
        db.ref('students').on('value', s => { 
            appData.students = s.val() ? Object.entries(s.val()).map(([id,v])=>({...v,id})) : []; 
            if(appData.user) renderGrid();
        });
    }
    init();

    function toggleStaffMode() {
        const p = document.getElementById('uPass');
        p.classList.toggle('hidden');
        document.getElementById('toggleLogin').innerText = p.classList.contains('hidden') ? "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†" : "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨";
    }

    function doLogin() {
        const key = document.getElementById('uKey').value.trim();
        const pass = document.getElementById('uPass').value.trim();
        if(pass) {
            const t = appData.teachers.find(x => x.user === key && x.pass === pass);
            if(t) { appData.user = t; launchApp(); } else alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
        } else {
            const s = appData.students.find(x => x.code === key);
            if(s) { appData.user = s; launchStudentApp(s); } else alert("ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        }
    }

    function launchApp() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('welcomeName').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ " + (appData.user.user || appData.user.name);
        document.getElementById('roleLabel').innerText = appData.user.role === 'super_admin' ? "Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… (idarah)" : "Ù…Ø¹Ù„Ù… Ø§Ù„ÙØµÙ„";
        
        if(appData.user.role === 'super_admin' || appData.user.user === 'idarah') {
            document.getElementById('adminModule').classList.remove('hidden');
        }
        document.getElementById('teacherModule').classList.remove('hidden');

        const myClasses = (appData.user.role === 'super_admin' || appData.user.user === 'idarah') ? ["3/1", "3/2", "3/3", "3/4", "3/5"] : (Array.isArray(appData.user.assignedClass) ? appData.user.assignedClass : [appData.user.assignedClass]);
        appData.activeClass = myClasses[0];
        document.getElementById('classTabs').innerHTML = myClasses.map(c => `<button class="btn btn-outline" onclick="switchClass('${c}', this)">${c}</button>`).join('');
        renderGrid();
    }

    function switchClass(c, btn) {
        appData.activeClass = c;
        document.querySelectorAll('#classTabs button').forEach(b => b.className = 'btn btn-outline');
        btn.className = 'btn btn-primary';
        renderGrid();
    }

    function launchStudentApp(s) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('studentModule').classList.remove('hidden');
        document.getElementById('welcomeName').innerText = s.name;
        document.getElementById('roleLabel').innerText = "Ø·Ø§Ù„Ø¨ - ÙØµÙ„ " + s.class;
        
        let totalPoints = (s.records || []).reduce((acc, curr) => acc + parseInt(curr.mark || 0), 0);
        document.getElementById('stdTotalPoints').innerText = totalPoints;

        document.getElementById('stdHistory').innerHTML = (s.records || []).map(r => `
            <div class="feedback-item">
                <b>${r.week} (${r.day})</b><br>
                <span>Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.mark} | Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status}</span><br>
                <small>Ø§Ù„Ù…ÙˆØ¶Ø¹: ${r.sura} - Øµ ${r.page}</small>
            </div>`).reverse().join('');
    }

    function renderGrid() {
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = "";
        const week = document.getElementById('selWeek').value;
        const day = document.getElementById('selDay').value;

        const filtered = appData.students.filter(s => s.class === appData.activeClass);
        let done = 0;

        filtered.forEach(s => {
            const rec = (s.records || []).find(r => r.week === week && r.day === day);
            const card = document.createElement('div');
            card.className = `std-card ${rec ? 'done' : ''}`;
            
            // Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆØ³Ù…Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¢Ø®Ø± 3 Ø¯Ø±Ø¬Ø§Øª Ù‡ÙŠ 7
            let isExcel = s.records && s.records.slice(-3).every(r => r.mark == 7);
            const badge = isExcel ? '<span class="badge">â­</span>' : '';

            card.innerHTML = `${badge} <b>${s.name}</b><br><small>${rec ? 'Ø¯Ø±Ø¬Ø©: '+rec.mark : 'Ù„Ù… ÙŠØ±ØµØ¯'}</small>`;
            card.onclick = () => openGradeModal(s);
            grid.appendChild(card);
            if(rec) done++;
        });

        document.getElementById('statTotal').innerText = filtered.length;
        document.getElementById('statPresent').innerText = done;
        document.getElementById('statAvg').innerText = filtered.length > 0 ? ((done/filtered.length)*100).toFixed(0) + "%" : "0%";
    }

    function openGradeModal(s) {
        appData.activeSID = s.id;
        document.getElementById('stdNameTitle').innerText = s.name;
        document.getElementById('gPage').value = globalPage;
        document.getElementById('gSura').value = globalSura;
        document.getElementById('gMark').value = "";
        document.getElementById('gNote').value = "";
        document.getElementById('gradeModal').classList.remove('hidden');
        renderHistory(s);
    }

    function saveGrade() {
        const s = appData.students.find(x => x.id === appData.activeSID);
        const newR = {
            week: document.getElementById('selWeek').value,
            day: document.getElementById('selDay').value,
            page: document.getElementById('gPage').value,
            sura: document.getElementById('gSura').value,
            mark: document.getElementById('gMark').value,
            status: document.getElementById('gStatus').value,
            note: document.getElementById('gNote').value,
            teacher: appData.user.user,
            ts: Date.now()
        };
        if(!s.records) s.records = [];
        const idx = s.records.findIndex(r => r.week === newR.week && r.day === newR.day);
        if(idx !== -1) s.records[idx] = newR; else s.records.push(newR);

        db.ref('students/'+s.id+'/records').set(s.records).then(() => {
            closeModal();
            renderGrid();
        });
    }

    function renderHistory(s) {
        document.getElementById('historyLogs').innerHTML = (s.records || []).map(r => `
            <div class="feedback-item" style="font-size:12px;">
                <b>${r.week}</b>: ${r.status} (${r.mark}/7) - ${r.sura}
            </div>`).reverse().join('');
    }

    function sendFeedback() {
        const msg = document.getElementById('stdFeedback').value;
        if(!msg) return;
        db.ref('feedbacks').push({ name: appData.user.name, class: appData.user.class, msg: msg, ts: Date.now() });
        alert("Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©.");
        document.getElementById('stdFeedback').value = "";
    }

    function showFeedbackModal() {
        document.getElementById('feedbackModal').classList.remove('hidden');
        db.ref('feedbacks').on('value', s => {
            const list = document.getElementById('feedbackList');
            list.innerHTML = s.val() ? Object.entries(s.val()).map(([id, f]) => `
                <div class="feedback-item">
                    <b>${f.name} (ÙØµÙ„ ${f.class}):</b><br>${f.msg}
                    <button onclick="db.ref('feedbacks/${id}').remove()" style="float:left; color:red; border:none; background:none; cursor:pointer;">Ø­Ø°Ù</button>
                </div>`).reverse().join('') : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©.";
        });
    }

    function wipeData() {
        const pass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ£ÙƒÙŠØ¯ (idarah2026):");
        if(pass === "idarah2026") {
            appData.students.forEach(s => db.ref('students/'+s.id+'/records').remove());
            alert("ØªÙ… ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
        }
    }

    function closeModal() { document.getElementById('gradeModal').classList.add('hidden'); }
</script>
</body>
</html>
