<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ | Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #f0f2f5; --card: #ffffff; --g: #27ae60; --r: #e74c3c; --txt: #2c3e50; --btn: #27ae60; --accent: #3498db; }
        [data-theme="dark"] { --bg: #1a1a1a; --card: #2d2d2d; --g: #2ecc71; --r: #ff5252; --txt: #eeeeee; --btn: #27ae60; --accent: #bb86fc; }
        [data-theme="gold"] { --bg: #fdfaf0; --card: #ffffff; --g: #d4af37; --r: #a94442; --txt: #4a4a4a; --btn: #d4af37; --accent: #8a6d3b; }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s ease; }
        body { background: var(--bg); color: var(--txt); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 700px; margin: 10px 0; position: relative; border-bottom: 5px solid var(--g); }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        .btn { padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-tech { background: var(--btn); color: white; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3); }
        .btn-tech:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-back { background: rgba(0,0,0,0.05); color: var(--txt); width: auto; padding: 6px 15px; position: absolute; top: 15px; right: 15px; font-size: 13px; }

        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø±ØµØ¯ Ø§Ù„Ù…Ù„ÙˆÙ†Ø© */
        .done-status { font-size: 11px; display: block; margin-top: 5px; padding: 3px; border-radius: 6px; font-weight: bold; }
        .status-green { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-red { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid rgba(0,0,0,0.1); background: var(--card); color: var(--txt); font-size: 14px; }
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 15px; }
        .grid-item { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; border: 2px solid transparent; box-shadow: 0 4px 10px rgba(0,0,0,0.04); cursor: pointer; }
        .grid-item:hover { border-color: var(--accent); transform: scale(1.02); }
        
        .history-item { background: rgba(0,0,0,0.02); padding: 15px; border-radius: 15px; margin-bottom: 10px; border-right: 5px solid var(--accent); position: relative; }
        .admin-sec { background: rgba(0,0,0,0.03); padding: 15px; border-radius: 15px; margin: 15px 0; border: 1px solid rgba(0,0,0,0.05); }
        
        .report-box { background: #fff3cd; color: #856404; padding: 15px; border-radius: 12px; border: 1px solid #ffeeba; margin: 10px 0; }
        footer { margin-top: auto; padding: 20px; font-size: 12px; color: #777; text-align: center; }
    </style>
</head>
<body>

<div id="loginGate" class="card">
    <div style="text-align:center; margin-bottom:15px;">
        <span style="background:var(--g); color:white; padding:5px 15px; border-radius:20px; font-size:12px;">Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø°ÙƒÙŠØ© v2026</span>
    </div>
    <h2 style="text-align:center; margin-top:0;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ›¡ï¸</h2>
    <input type="text" id="entryKey" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <div id="staffSection" class="hidden">
        <input type="password" id="entryPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    </div>
    <button class="btn btn-tech" onclick="mainAuth()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    <button class="btn" style="background:transparent; color:var(--accent);" onclick="document.getElementById('staffSection').classList.toggle('hidden')">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ø¯Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</button>
</div>

<div id="app" class="hidden" style="width:100%; max-width:700px;">
    
    <div id="teacherDash" class="hidden card">
        <button class="btn btn-back" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        <div id="roleDisplay" style="font-size:14px; font-weight:bold; color:var(--accent); margin-bottom:10px;"></div>
        
        <div id="themeSwitcher" style="display: flex; gap: 8px; margin-bottom: 15px;">
            <button onclick="setTheme('default')" style="background:#eee; width:25px; height:25px; border-radius:50%; border:none; cursor:pointer;"></button>
            <button onclick="setTheme('dark')" style="background:#333; width:25px; height:25px; border-radius:50%; border:none; cursor:pointer;"></button>
            <button onclick="setTheme('gold')" style="background:#d4af37; width:25px; height:25px; border-radius:50%; border:none; cursor:pointer;"></button>
        </div>

        <input type="text" id="searchBox" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." oninput="filterGrid()">
        <div id="classTabs" style="display:flex; gap:10px; margin:10px 0; overflow-x:auto; padding-bottom:5px;"></div>
        <div id="namesGrid" class="grid"></div>
        
        <hr>
        <button class="btn" style="background:var(--accent); color:white;" onclick="showSettings()">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
        <button id="adminBtn" class="btn hidden" style="background:#2c3e50; color:white;" onclick="showManagePage()">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø¥ØºÙ„Ø§Ù‚</button>
        <h3 id="targetName" style="color:var(--g)"></h3>
        
        <div id="gradeForm" class="admin-sec">
            <div style="display:flex; gap:10px;">
                <select id="gWeek"></select>
                <select id="gDay">
                    <option>ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯</option><option>ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³</option>
                </select>
            </div>
            <div id="ayatSection" class="hidden">
                <input type="text" id="gAyatFrom" placeholder="Ø§Ù„Ø¢ÙŠØ§Øª Ù…Ù†">
                <input type="text" id="gAyatTo" placeholder="Ø¥Ù„Ù‰">
            </div>
            <div id="pageSection">
                <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
            </div>
            <input type="number" id="gMark" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© / 7">
            <select id="gStatus">
                <option value="" selected disabled>-- Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© --</option>
                <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
                <option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
                <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
                <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
                <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option>
            </select>
            <textarea id="gNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø®Ø§ØµØ©..."></textarea>
            <button id="saveBtn" class="btn btn-tech" onclick="saveGrade()">Ø±ØµØ¯ ÙˆØ­ÙØ¸</button>
        </div>
        
        <h4>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ (Ø§Ø¶ØºØ· Ù„Ù„ØªØ¹Ø¯ÙŠÙ„):</h4>
        <div id="editHistory"></div>
    </div>

    <div id="studentPage" class="hidden card">
        <button class="btn btn-back" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        <h3 id="welcomeMsg"></h3>
        <button class="btn" style="background:#f39c12; color:white;" onclick="toggleLates()">ğŸ“Š Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª</button>
        <div id="latesBox" class="hidden report-box"></div>
        <div id="recordsList"></div>
    </div>

    <div id="managePage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3 id="manageTitle">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
        
        <div id="idarahOnly" class="admin-sec hidden">
            <p style="color:red; font-weight:bold;">ğŸ› ï¸ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ (idarah)</p>
            <input type="text" id="tUser" placeholder="ÙŠÙˆØ²Ø± Ø§Ù„Ù…Ø¹Ù„Ù…">
            <input type="text" id="tPass" placeholder="Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…">
            <select id="tRole">
                <option value="teacher">Ù…Ø¹Ù„Ù…</option>
                <option value="teacher_lead">Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù… (Ø³Ø¹Ø¯)</option>
                <option value="school_admin">Ø¥Ø¯Ø§Ø±ÙŠ</option>
            </select>
            <select id="tClassAssign" multiple style="height:80px;"></select>
            <button class="btn btn-tech" onclick="addNewTeacher()">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù… Ø¬Ø¯ÙŠØ¯</button>
            <div id="teachersMasterList" style="margin-top:15px;"></div>
        </div>

        <div class="admin-sec">
            <p>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</p>
            <input type="text" id="newSName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
            <input type="text" id="newSCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
            <select id="newSClass"></select>
            <button class="btn btn-tech" onclick="addNewStudent()">Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ« Ø·Ø§Ù„Ø¨</button>
            <div id="studentsMasterList" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="settingsPage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3>ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
        <input type="password" id="oldPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
        <input type="password" id="newPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
        <button class="btn btn-tech" onclick="changeMyPass()">ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
    </div>

</div>

<footer><b>ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯ | 0599804296</b></footer>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let students = [], teachers = [], classes = ["3/1", "3/2", "3/3", "3/4", "3/5"];
    let currentUser = null, currentSID = null, currentTID = null, editingRecIdx = null;
    let autoData = { week: "", day: "", page: "", ayatFrom: "", ayatTo: "", currentClass: "" };

    const weeksArr = ["Ø§Ù„Ø£ÙˆÙ„","Ø§Ù„Ø«Ø§Ù†ÙŠ","Ø§Ù„Ø«Ø§Ù„Ø«","Ø§Ù„Ø±Ø§Ø¨Ø¹","Ø§Ù„Ø®Ø§Ù…Ø³","Ø§Ù„Ø³Ø§Ø¯Ø³","Ø§Ù„Ø³Ø§Ø¨Ø¹","Ø§Ù„Ø«Ø§Ù…Ù†","Ø§Ù„ØªØ§Ø³Ø¹","Ø§Ù„Ø¹Ø§Ø´Ø±","Ø§Ù„Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±","Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ø´Ø±","Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ø´Ø±","Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø±"];
    document.getElementById('gWeek').innerHTML = weeksArr.map(w => `<option value="Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}</option>`).join('');
    document.getElementById('tClassAssign').innerHTML = classes.map(c => `<option value="${c}">${c}</option>`).join('');
    document.getElementById('newSClass').innerHTML = classes.map(c => `<option value="${c}">${c}</option>`).join('');

    function setTheme(t) { document.documentElement.setAttribute('data-theme', t); }

    function init() {
        db.ref('teachers').on('value', s => {
            teachers = s.val() ? Object.entries(s.val()).map(([id, val]) => ({...val, tid: id})) : [];
            // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯
            if(!teachers.find(t=>t.user==='idarah')) db.ref('teachers').push({user:'idarah', pass:'2026', role:'super_admin'});
        });
        db.ref('students').on('value', s => {
            students = s.val() ? Object.entries(s.val()).map(([id, val]) => ({...val, id: id})) : [];
            if(currentUser) refreshUI();
        });
    }
    init();

    function mainAuth() {
        const user = document.getElementById('entryKey').value.trim();
        const pass = document.getElementById('entryPass').value.trim();
        const isStaff = !document.getElementById('staffSection').classList.contains('hidden');

        if(isStaff) {
            const t = teachers.find(x => x.user === user && x.pass === pass);
            if(t) { currentUser = t; setupDash(); } else alert("Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„");
        } else {
            const std = students.find(x => x.code === user);
            if(std) { currentSID = std.id; showScreen('studentPage'); renderStudentRecords(std); } else alert("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        }
    }

    function setupDash() {
        showScreen('teacherDash');
        document.getElementById('roleDisplay').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ: ${currentUser.user} (${currentUser.role})`;
        if(['super_admin', 'teacher_lead', 'school_admin'].includes(currentUser.role)) document.getElementById('adminBtn').classList.remove('hidden');
        
        const myClasses = (currentUser.role === 'super_admin' || currentUser.user === 'saad') ? classes : (Array.isArray(currentUser.assignedClass) ? currentUser.assignedClass : [currentUser.assignedClass]);
        const tabs = document.getElementById('classTabs'); tabs.innerHTML = "";
        myClasses.forEach(c => {
            const b = document.createElement('button'); b.className = 'btn'; b.style.width='auto'; b.style.background='white'; b.style.color='#333';
            b.innerText = `ÙØµÙ„ ${c}`; b.onclick = () => { autoData.currentClass = c; loadClass(c); };
            tabs.appendChild(b);
        });
    }

    function loadClass(cls) {
        const grid = document.getElementById('namesGrid'); grid.innerHTML = "";
        const curW = autoData.week || document.getElementById('gWeek').value;
        const curD = autoData.day || document.getElementById('gDay').value;

        students.filter(s => s.class === cls).forEach(s => {
            const rec = (s.records || []).find(r => r.week === curW && r.day === curD);
            const d = document.createElement('div'); d.className = 'grid-item';
            let statusTag = "";
            if(rec) {
                const style = rec.status === 'Ø­Ø§ÙØ¸' ? 'status-green' : 'status-red';
                statusTag = `<span class="done-status ${style}">ØªÙ… Ø§Ù„Ø±ØµØ¯: ${rec.status}</span>`;
            }
            d.innerHTML = `<b>${s.name}</b>${statusTag}`;
            d.onclick = () => openGrade(s);
            grid.appendChild(d);
        });
    }

    function openGrade(s) {
        currentSID = s.id; editingRecIdx = null;
        document.getElementById('targetName').innerText = "Ø±ØµØ¯ Ù„Ù„Ø·Ø§Ù„Ø¨: " + s.name;
        document.getElementById('saveBtn').innerText = "Ø±ØµØ¯ ÙˆØ­ÙØ¸";
        
        if(autoData.week) document.getElementById('gWeek').value = autoData.week;
        if(autoData.day) document.getElementById('gDay').value = autoData.day;
        
        if(currentUser.user === 'ibrahim') {
            document.getElementById('ayatSection').classList.remove('hidden');
            document.getElementById('pageSection').classList.add('hidden');
        }
        
        renderHistory(s);
        showScreen('gradeScreen');
    }

    function saveGrade() {
        const s = students.find(x => x.id === currentSID);
        const mark = document.getElementById('gMark').value;
        const status = document.getElementById('gStatus').value;
        if(!status || !mark) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        // ØªØ¹Ù…ÙŠÙ… Ø§Ù„Ù‚ÙŠÙ…
        autoData.week = document.getElementById('gWeek').value;
        autoData.day = document.getElementById('gDay').value;
        autoData.page = document.getElementById('gPage').value;
        autoData.ayatFrom = document.getElementById('gAyatFrom').value;
        autoData.ayatTo = document.getElementById('gAyatTo').value;

        const rec = {
            week: autoData.week, day: autoData.day,
            page: currentUser.user === 'ibrahim' ? `Ø¢ÙŠØ§Øª ${autoData.ayatFrom}-${autoData.ayatTo}` : `ØµÙØ­Ø© ${autoData.page}`,
            mark: mark, status: status, note: document.getElementById('gNote').value,
            teacher: currentUser.user, timestamp: new Date().toLocaleString()
        };

        if(!s.records) s.records = [];
        if(editingRecIdx !== null) s.records[editingRecIdx] = rec; else s.records.push(rec);

        db.ref('students/'+currentSID+'/records').set(s.records).then(() => {
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
            showScreen('teacherDash');
            loadClass(autoData.currentClass);
        });
    }

    function renderHistory(s) {
        document.getElementById('editHistory').innerHTML = (s.records || []).map((r, i) => `
            <div class="history-item" onclick="prepareEdit(${i})">
                <b>${r.week} - ${r.day}</b> | Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status} (${r.mark}/7)
                <br><small>Ø§Ù„Ù…ØµØ­Ø­: ${r.teacher} | ${r.timestamp}</small>
            </div>`).reverse().join('');
    }

    function prepareEdit(i) {
        const r = students.find(s=>s.id===currentSID).records[i];
        editingRecIdx = i;
        document.getElementById('gWeek').value = r.week;
        document.getElementById('gDay').value = r.day;
        document.getElementById('gMark').value = r.mark;
        document.getElementById('gStatus').value = r.status;
        document.getElementById('gNote').value = r.note;
        document.getElementById('saveBtn').innerText = `ØªØ¹Ø¯ÙŠÙ„ (Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: ${r.status})`;
        window.scrollTo(0,0);
    }

    function toggleLates() {
        const s = students.find(x => x.id === currentSID);
        const box = document.getElementById('latesBox'); box.classList.toggle('hidden');
        if(s.records) {
            const absent = s.records.filter(r => r.status === 'ØºØ§Ø¦Ø¨').length;
            const notSaved = s.records.filter(r => r.status === 'Ù„Ù… ÙŠØ³Ù…Ø¹').length;
            const weak = s.records.filter(r => parseInt(r.mark) < 5).length;
            box.innerHTML = `ğŸ›‘ ØºÙŠØ§Ø¨: ${absent} | âŒ Ù„Ù… ÙŠØ³Ù…Ø¹: ${notSaved} | ğŸ“‰ Ø¯Ø±Ø¬Ø§Øª Ø¶Ø¹ÙŠÙØ©: ${weak}`;
        }
    }

    function showManagePage() {
        showScreen('managePage');
        if(currentUser.user === 'idarah') {
            document.getElementById('idarahOnly').classList.remove('hidden');
            renderTeachers();
        }
        renderStudents();
    }

    function renderTeachers() {
        document.getElementById('teachersMasterList').innerHTML = teachers.map(t => `
            <div class="history-item">
                ğŸ‘¤ ${t.user} | Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ±: <b>${t.pass}</b> | Ø±ØªØ¨Ø©: ${t.role}
                <button onclick="delTeacher('${t.tid}')" style="color:red; float:left; border:none; background:none; cursor:pointer;">[Ø­Ø°Ù]</button>
            </div>`).join('');
    }

    function renderStudents() {
        document.getElementById('studentsMasterList').innerHTML = students.map(s => `
            <div class="history-item">
                ğŸ“ ${s.name} (ÙƒÙˆØ¯: ${s.code}) - ÙØµÙ„: ${s.class}
                <button onclick="delStudent('${s.id}')" style="color:red; float:left; border:none; background:none; cursor:pointer; margin-right:10px;">[Ø­Ø°Ù]</button>
                <button onclick="editS('${s.id}')" style="color:blue; float:left; border:none; background:none; cursor:pointer;">[ØªØ¹Ø¯ÙŠÙ„]</button>
            </div>`).join('');
    }

    function changeMyPass() {
        const oldP = document.getElementById('oldPass').value;
        const newP = document.getElementById('newPass').value;
        if(oldP === currentUser.pass) {
            db.ref('teachers/'+currentUser.tid+'/pass').set(newP).then(()=> { alert("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯"); location.reload(); });
        } else alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø®Ø§Ø·Ø¦Ø©");
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© (Ù…Ø®ØªØµØ±Ø©)
    function addNewTeacher() {
        const user = document.getElementById('tUser').value, pass = document.getElementById('tPass').value, role = document.getElementById('tRole').value;
        const cls = Array.from(document.getElementById('tClassAssign').selectedOptions).map(o => o.value);
        if(user && pass) db.ref('teachers').push({user, pass, role, assignedClass: cls}).then(()=>renderTeachers());
    }
    function addNewStudent() {
        const name = document.getElementById('newSName').value, code = document.getElementById('newSCode').value, cls = document.getElementById('newSClass').value;
        if(name && code) db.ref('students/'+(currentSID || Date.now())).update({id: currentSID||Date.now().toString(), name, code, class: cls}).then(()=>{currentSID=null; renderStudents();});
    }
    function delTeacher(id) { if(confirm("Ø­Ø°ÙØŸ")) db.ref('teachers/'+id).remove(); }
    function delStudent(id) { if(confirm("Ø­Ø°ÙØŸ")) db.ref('students/'+id).remove(); }
    function editS(id) { const s = students.find(x=>x.id===id); currentSID=s.id; document.getElementById('newSName').value=s.name; document.getElementById('newSCode').value=s.code; document.getElementById('newSClass').value=s.class; }
    function showScreen(id) { document.querySelectorAll('#app > div, #loginGate').forEach(d => d.classList.add('hidden')); document.getElementById('app').classList.remove('hidden'); document.getElementById(id).classList.remove('hidden'); }
    function showSettings() { showScreen('settingsPage'); }
    function renderStudentRecords(s) { document.getElementById('welcomeMsg').innerText = "Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨: " + s.name; document.getElementById('recordsList').innerHTML = (s.records || []).map(r => `<div class="history-item"><b>${r.week} - ${r.day}</b><br>Ø§Ù„Ù…ÙˆØ¶Ø¹: ${r.page}<br>Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status} | Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.mark}/7</div>`).reverse().join(''); }
    function filterGrid() { const q = document.getElementById('searchBox').value.toLowerCase(); document.querySelectorAll('.grid-item').forEach(i => i.style.display = i.innerText.toLowerCase().includes(q) ? 'block' : 'none'); }
</script>
</body>
</html>
