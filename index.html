<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ v3.0 | ØªØ·ÙˆÙŠØ± Ù…ØµØ·ÙÙ‰ & ÙŠØ²Ù†</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø«ÙŠÙ…Ø§Øª Ø§Ù„Ù…ØªØºÙŠØ± */
        :root { --bg: #f4f7f6; --card: #ffffff; --p: #2c3e50; --g: #27ae60; --txt: #2c3e50; --red: #e74c3c; --orange: #f39c12; --blue: #3498db; --yellow: #f1c40f; --header-bg: #fff; }
        
        [data-theme="dark"] { --bg: #1a1a2e; --card: #16213e; --txt: #e94560; --p: #0f3460; --header-bg: #0f3460; }
        [data-theme="royal"] { --bg: #2c3e50; --card: #34495e; --txt: #f1c40f; --g: #d4af37; --header-bg: #1a252f; }
        [data-theme="school"] { --bg: #fff9e6; --card: #ffffff; --txt: #5d4037; --g: #8bc34a; --blue: #03a9f4; }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        body { background: var(--bg); color: var(--txt); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù…ÙˆØ±ÙˆØ«Ø© */
        .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 800px; margin: 10px 0; position: relative; border: 1px solid rgba(0,0,0,0.05); }
        .mustafa-tag { color: var(--g); font-weight: bold; font-size: 13px; text-align: center; display: block; margin: 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .btn { padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.95); }
        .btn-tech { background: var(--g); color: white; }
        .btn-danger { background: var(--red); color: white; }
        .btn-back { background: rgba(0,0,0,0.1); color: var(--txt); width: auto; padding: 5px 15px; font-size: 11px; position: absolute; top: 15px; right: 15px; z-index: 100; border-radius: 8px; }
        
        input, select, textarea { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #ddd; background: white; font-size: 14px; outline: none; }
        input:focus { border-color: var(--blue); box-shadow: 0 0 8px rgba(52, 152, 219, 0.2); }
        
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 20px; }
        
        /* Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø±ØµØ¯ */
        .grid-item { background: var(--card); padding: 20px; border-radius: 15px; text-align: center; border: 2px solid #000; cursor: pointer; font-weight: bold; color: #000; position: relative; overflow: hidden; }
        .grid-item::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 5px; background: rgba(0,0,0,0.1); }
        
        /* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© - ØªØ±ÙƒÙŠØ² Ø®Ø§Øµ */
        .status-Ø­Ø§ÙØ¸ { background: #e8f5e9 !important; color: #1b5e20 !important; border: 2px solid #2e7d32 !important; box-shadow: inset 0 0 10px rgba(46,125,50,0.2); }
        .status-ØºÙŠØ±-Ø­Ø§ÙØ¸ { background: #fffde7 !important; color: #fbc02d !important; border: 2px solid #fbc02d !important; }
        .status-ØºØ§Ø¦Ø¨ { background: #e3f2fd !important; color: #0d47a1 !important; border: 2px solid #0d47a1 !important; }
        .status-Ù„Ù…-ÙŠØ³Ù…Ø¹ { background: #ffebee !important; color: #b71c1c !important; border: 2px solid #b71c1c !important; }
        .status-Ù…Ø­Ø±ÙˆÙ… { background: #333 !important; color: #fff !important; border: 2px solid #000 !important; }
        .status-Ø§Ø®ØªØ¨Ø§Ø± { background: #f3e5f5 !important; color: #7b1fa2 !important; border: 2px solid #7b1fa2 !important; font-style: italic; }

        /* Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…Ø·ÙˆØ± */
        .history-item { background: rgba(0,0,0,0.02); padding: 18px; border-radius: 15px; margin-bottom: 12px; border-right: 6px solid var(--g); position: relative; box-shadow: 2px 2px 10px rgba(0,0,0,0.02); }
        .modified-badge { background: var(--yellow); color: #000; padding: 3px 10px; border-radius: 6px; font-size: 10px; font-weight: bold; margin-top: 8px; display: inline-block; }
        .top-rank { background: linear-gradient(135deg, #f1c40f, #f39c12); color: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 20px rgba(241, 196, 15, 0.3); }
        .call-parent { background: #fff5f5; border: 2px dashed var(--red); color: var(--red); padding: 15px; border-radius: 15px; margin: 15px 0; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Switch */
        .switch-container { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f9f9f9; border-radius: 10px; margin-bottom: 5px; border: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        input:checked + .slider { background-color: var(--g); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Ù‚Ø³Ù… Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ù…Ø·ÙˆØ± */
        .guide-img { width: 100%; border-radius: 15px; margin: 15px 0; border: 3px solid #eee; }
        .guide-step { background: #fdfdfd; padding: 15px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid var(--blue); }
        .guide-step h4 { color: var(--blue); margin-top: 0; }

        footer { margin-top: 40px; padding: 20px; font-size: 13px; color: #777; text-align: center; border-top: 1px solid #ddd; width: 100%; }
    </style>
</head>
<body>

<div id="loginGate" class="card">
    <div class="mustafa-tag">| Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ |</div>
    <div style="text-align:center; margin-bottom: 20px;">
        <img src="https://cdn-icons-png.flaticon.com/512/2602/2602414.png" width="80" alt="Logo">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… ğŸ›¡ï¸</h2>
    </div>
    <input type="text" id="entryKey" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
    <div id="staffSection" class="hidden">
        <input type="password" id="entryPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø³Ø±ÙŠØ©">
    </div>
    <button class="btn btn-tech" onclick="mainAuth()">ğŸš€ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    <button class="btn" style="background:transparent; color:var(--g);" onclick="document.getElementById('staffSection').classList.toggle('hidden')">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ø¯Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</button>
    
    <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
        <div title="Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ" style="width:25px; height:25px; background:#f4f7f6; border:2px solid #ccc; cursor:pointer; border-radius:50%;" onclick="setTheme('default')"></div>
        <div title="Ø§Ù„Ù„ÙŠÙ„ÙŠ" style="width:25px; height:25px; background:#1a1a2e; border:2px solid #ccc; cursor:pointer; border-radius:50%;" onclick="setTheme('dark')"></div>
        <div title="Ø§Ù„Ù…Ù„ÙƒÙŠ" style="width:25px; height:25px; background:#2c3e50; border:2px solid #ccc; cursor:pointer; border-radius:50%;" onclick="setTheme('royal')"></div>
        <div title="Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ" style="width:25px; height:25px; background:#fff9e6; border:2px solid #ccc; cursor:pointer; border-radius:50%;" onclick="setTheme('school')"></div>
    </div>
</div>

<div id="app" class="hidden" style="width:100%; max-width:800px;">
    
    <div id="topTenSection" class="card top-rank">
        <h3 style="margin:0; text-align:center;">ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h3>
        <div id="topList" style="margin-top:15px; font-weight:bold; text-align:center; font-size: 1.1em;"></div>
    </div>

    <div id="studentPage" class="hidden card">
        <button class="btn btn-back" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        <h3 id="welcomeMsg" style="color:var(--blue)"></h3>
        <div id="parentCallArea"></div>
        <div id="lateStats" class="card" style="background:#f8f9fa; border:1px solid #dee2e6;"></div>
        <h4 style="border-right: 4px solid var(--g); padding-right: 10px;">ğŸ“‰ Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„:</h4>
        <div id="recordsList"></div>
    </div>

    <div id="teacherDash" class="hidden card">
        <button class="btn btn-back" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        <div id="roleDisplay" class="mustafa-tag"></div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="btn btn-tech" style="flex:1;" onclick="showScreen('teacherGuide')">ğŸ“– Ø´Ø±Ø­ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            <button id="idarahGuideBtn" class="btn hidden" style="flex:1; background:var(--p); color:white;" onclick="showScreen('idarahGuide')">ğŸ‘‘ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ†Ø±</button>
        </div>

        <div class="card" style="background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px;">
            <h4 style="margin-top:0;">ğŸ›¡ï¸ ØªØ£Ù…ÙŠÙ† Ø­Ø³Ø§Ø¨Ùƒ</h4>
            <div style="display:flex; gap:10px;">
                <input type="password" id="selfPassUpdate" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©" style="margin:0;">
                <button class="btn btn-tech" style="width:auto; margin:0;" onclick="updateMyPassword()">ØªØ­Ø¯ÙŠØ«</button>
            </div>
        </div>

        <div id="filterPanel" style="background:#eee; padding:15px; border-radius:15px; margin-bottom:15px;">
            <label>ğŸ” ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ø±Ø¶:</label>
            <div style="display:flex; gap:10px;">
                <select id="viewWeek" onchange="renderNamesGrid()"></select>
                <select id="viewDay" onchange="renderNamesGrid()">
                    <option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
                </select>
            </div>
        </div>

        <input type="text" id="searchBox" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." oninput="filterGrid()">
        
        <div id="broadcastPanel" class="card" style="background:#fffbeb; border:1px solid #fef3c7;">
            <h4 style="margin:0 0 10px 0;">ğŸ“¢ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="number" id="bcPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
                <button class="btn" style="background:var(--orange); color:white; margin:0;" onclick="applyBroadcast()">ØªØ¹Ù…ÙŠÙ… Ø¹Ù„Ù‰ Ø§Ù„ÙØµÙ„</button>
            </div>
            <small style="color: #666;">* Ø³ÙŠØªÙ… Ø±ØµØ¯ "Ù„Ù… ÙŠØ³Ù…Ø¹" Ù…Ø¹ Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…ÙØªÙˆØ­.</small>
        </div>

        <div id="classTabs" style="display:flex; gap:8px; margin:15px 0; flex-wrap: wrap;"></div>
        <div id="namesGrid" class="grid"></div>
        
        <button id="adminBtn" class="btn hidden" style="background:#2c3e50; color:white; margin-top:30px;" onclick="showScreen('managePage')">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        <button id="idarahBtn" class="btn hidden" style="background:#8e44ad; color:white;" onclick="showScreen('idarahPage')">ğŸ‘‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ (Owner)</button>
    </div>

    <div id="gradeScreen" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3 id="targetName" style="color:var(--g)"></h3>
        <div id="gradeForm">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="gWeek"></select>
                <select id="gDay">
                    <option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯">ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">ÙŠÙˆÙ… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">ÙŠÙˆÙ… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option value="ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³">ÙŠÙˆÙ… Ø§Ù„Ø®Ù…ÙŠØ³</option>
                </select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="number" id="gPage" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©">
                <input type="number" id="gMark" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø© / 7">
            </div>
            <select id="gStatus" onchange="toggleTestField()">
                <option value="Ø­Ø§ÙØ¸">Ø­Ø§ÙØ¸ âœ…</option>
                <option value="ØºÙŠØ± Ø­Ø§ÙØ¸">ØºÙŠØ± Ø­Ø§ÙØ¸ âš ï¸</option>
                <option value="Ù„Ù… ÙŠØ³Ù…Ø¹">Ù„Ù… ÙŠØ³Ù…Ø¹ âŒ</option>
                <option value="Ù…Ø­Ø±ÙˆÙ…">Ù…Ø­Ø±ÙˆÙ… ğŸš«</option>
                <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨ ğŸ’¤</option>
                <option value="Ø§Ø®ØªØ¨Ø§Ø±">Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙˆØ±Ø© ğŸ†</option>
            </select>
            <div id="testField" class="hidden">
                <input type="text" id="gTestPages" placeholder="Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø© (Ù…Ø«Ù„Ø§Ù‹ 1-5)">
            </div>
            <textarea id="gNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…..."></textarea>
            <label style="background:#fff1f1; padding:10px; border-radius:10px; display:block; cursor:pointer;">
                <input type="checkbox" id="gCall"> Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø±Ø³Ù…ÙŠ ğŸš©
            </label>
            <button class="btn btn-tech" onclick="saveGrade()">ğŸ’¾ Ø­ÙØ¸ ÙˆØ±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø©</button>
        </div>
        <hr>
        <div id="editHistoryArea"></div>
    </div>

    <div id="idarahPage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h2 style="text-align:center;">ğŸ‘‘ Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ø£ÙˆÙ†Ø±)</h2>
        
        <div class="card" style="border: 2px solid var(--p);">
            <h4>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù… Ø¬Ø¯ÙŠØ¯ Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ø¯Ø¯Ø©</h4>
            <input type="text" id="newStaffName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù„Ù„Ø¯Ø®ÙˆÙ„)">
            <input type="text" id="newStaffPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <input type="text" id="newStaffClasses" placeholder="Ø§Ù„ÙØµÙˆÙ„ (Ù…Ø«Ø§Ù„: 3/1,3/2)">
            <button class="btn btn-tech" onclick="addNewStaff()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card" style="margin:0; padding:15px;">
                <h4>ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h4>
                <button class="btn btn-tech" style="font-size:12px;" onclick="exportData()">ØªØµØ¯ÙŠØ± (JSON)</button>
                <button class="btn btn-tech" style="font-size:12px; background:var(--blue);" onclick="document.getElementById('importFile').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                <input type="file" id="importFile" class="hidden" onchange="importData(event)">
            </div>
            <div class="card" style="margin:0; padding:15px; border-color:var(--red);">
                <h4 style="color:var(--red)">ğŸš¨ Ø§Ù„ØªØµÙÙŠØ±</h4>
                <button class="btn btn-danger" style="font-size:12px;" onclick="factoryReset()">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>

        <div class="card" style="padding:15px;">
            <h4>ğŸ”§ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø¥ÙŠÙ‚Ø§Ù/ØªØ´ØºÙŠÙ„)</h4>
            <div class="switch-container"><span>ØªÙØ¹ÙŠÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</span><label class="switch"><input type="checkbox" id="conf_reg" onchange="updateConfig('reg', this.checked)" checked><span class="slider"></span></label></div>
            <div class="switch-container"><span>Ø¸Ù‡ÙˆØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</span><label class="switch"><input type="checkbox" id="conf_top" onchange="updateConfig('top', this.checked)" checked><span class="slider"></span></label></div>
            <div class="switch-container"><span>Ø¸Ù‡ÙˆØ± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ¹Ù…ÙŠÙ…</span><label class="switch"><input type="checkbox" id="conf_bc" onchange="updateConfig('bc', this.checked)" checked><span class="slider"></span></label></div>
            <div class="switch-container"><span>ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© (Ù‚ÙÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹)</span><label class="switch"><input type="checkbox" id="conf_maint" onchange="updateConfig('maint', this.checked)"><span class="slider"></span></label></div>
        </div>

        <div id="staffListArea" class="card">
            <h4>ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ø¯Ø± (ÙƒØ´Ù Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯Ø§Øª)</h4>
            <div id="fullStaffList"></div>
        </div>

        <div class="card" style="background:#f4f4f4;">
            <h4>ğŸ“œ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Logs)</h4>
            <div id="logsArea" style="height:150px; overflow-y:scroll; font-size:11px; background:white; padding:10px;"></div>
        </div>
    </div>

    <div id="teacherGuide" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±Ø­</button>
        <h2 style="text-align: center;">ğŸ“– Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„ÙØ§Ø¶Ù„ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¯Ù„ÙŠÙ„ ÙŠÙˆØ¶Ø­ Ù„Ùƒ ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†ØµØ© Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø© Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø±ØµØ¯.</p>
        
        <div class="guide-step">
            <h4>1ï¸âƒ£ ÙƒÙŠÙÙŠØ© Ø±ØµØ¯ Ø¯Ø±Ø¬Ø© Ù„Ø·Ø§Ù„Ø¨</h4>
            <p>Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø£Ø³Ù…Ø§Ø¡ Ø·Ù„Ø§Ø¨ ÙØµÙ„Ùƒ. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±ØµØ¯Ù‡ØŒ Ø³ØªÙØªØ­ Ù„Ùƒ Ù†Ø§ÙØ°Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:</p>
            <ul>
                <li>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ù„ÙŠÙˆÙ… (ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙŠØ¸Ù‡Ø± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ).</li>
                <li>Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªÙŠ ÙˆØµÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨.</li>
                <li>ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ù† 7 (ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­ÙØ¸).</li>
                <li>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„Ø© (Ø­Ø§ÙØ¸ØŒ ØºØ§Ø¦Ø¨ØŒ Ø¥Ù„Ø®). Ù„Ø§Ø­Ø¸ Ø£Ù† Ù„ÙˆÙ† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø³ÙŠØªØºÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©.</li>
            </ul>
            
        </div>

        <div class="guide-step">
            <h4>2ï¸âƒ£ Ù…ÙŠØ²Ø© "ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª" (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)</h4>
            <p>Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØªØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„ÙØµÙ„ Ø¨Ù†Ø¸Ø±Ø© ÙˆØ§Ø­Ø¯Ø©:</p>
            <ul>
                <li><b style="color:green;">Ø§Ù„Ø£Ø®Ø¶Ø±:</b> Ø§Ù„Ø·Ø§Ù„Ø¨ Ø­ÙØ¸ ÙˆØ³Ù…Ù‘Ø¹ Ø§Ù„ÙŠÙˆÙ….</li>
                <li><b style="color:red;">Ø§Ù„Ø£Ø­Ù…Ø±:</b> Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø³Ø¬Ù„ "Ù„Ù… ÙŠØ³Ù…Ø¹".</li>
                <li><b style="color:blue;">Ø§Ù„Ø£Ø²Ø±Ù‚:</b> Ø§Ù„Ø·Ø§Ù„Ø¨ "ØºØ§Ø¦Ø¨".</li>
                <li><b style="color:purple;">Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ:</b> Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø¯ÙŠÙ‡ "Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙˆØ±Ø©".</li>
            </ul>
        </div>

        <div class="guide-step">
            <h4>3ï¸âƒ£ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù…ÙŠÙ… (Broadcast)</h4>
            <p>Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒÙ„ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ Ø³ÙŠØ³Ù…Ø¹ÙˆÙ† Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø©ØŒ Ù„Ø§ ØªØªØ¹Ø¨ Ù†ÙØ³Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨. ÙÙ‚Ø· Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© ÙÙŠ "Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù…ÙŠÙ…" ÙˆØ§Ø¶ØºØ· Ø§Ù„Ø²Ø±ØŒ ÙˆØ³ÙŠØªÙ… Ø±ØµØ¯Ù‡Ø§ Ù„Ù„Ø¬Ù…ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒØ­Ø§Ù„Ø© "Ù„Ù… ÙŠØ³Ù…Ø¹" Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØµØ­ÙŠØ­Ù‡Ø§ Ù…Ù†Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ù…ÙŠØ¹.</p>
        </div>

        <div class="guide-step">
            <h4>4ï¸âƒ£ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h4>
            <p>Ø¥Ø°Ø§ Ø£Ø®Ø·Ø£Øª ÙÙŠ Ø±ØµØ¯ Ø¯Ø±Ø¬Ø©ØŒ Ø§ÙØªØ­ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙˆØ³ØªØ¬Ø¯ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ "Ø³Ø¬Ù„ Ø§Ù„Ø±ØµØ¯"ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø£ÙŠ Ø±ØµØ¯ Ù‚Ø¯ÙŠÙ… ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø±ØµØ¯Ù‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.</p>
        </div>
    </div>

    <div id="idarahGuide" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø¥ØºÙ„Ø§Ù‚</button>
        <h2 style="text-align: center;">ğŸ‘‘ Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø£ÙˆÙ†Ø±</h2>
        
        <div class="guide-step">
            <h4>ğŸ’ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Ø¥Ø¯Ø§Ø±ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©)</h4>
            <p>Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù„ÙƒÙ„ Ù…Ø¹Ù„Ù…. Ù…ÙŠØ²ØªÙ†Ø§ Ø§Ù„Ù‚ÙˆÙŠØ© Ù‡ÙŠ Ø£Ù†Ùƒ ØªØ­Ø¯Ø¯ Ù„Ù„ÙØµÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… "ÙØµÙˆÙ„Ù‡ ÙÙ‚Ø·". Ø§ÙƒØªØ¨ Ø§Ù„ÙØµÙˆÙ„ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© Ù…Ø«Ù„ (3/1,3/5). Ù„Ù† ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù… Ø±Ø¤ÙŠØ© Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰.</p>
        </div>

        <div class="guide-step">
            <h4>ğŸ” ÙƒØ´Ù Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯Ø§Øª (Ø§Ù„Ø±Ù‚Ø§Ø¨Ø©)</h4>
            <p>Ø­ØªÙ‰ Ù„Ùˆ Ù‚Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø¨ØªØºÙŠÙŠØ± Ø¨Ø§Ø³ÙˆØ±Ø¯Ù‡ Ù…Ù† Ø­Ø³Ø§Ø¨Ù‡ØŒ Ø³ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© "ÙƒØ§Ø¯Ø± Ø§Ù„Ø¹Ù…Ù„" Ø£Ø³ÙÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©. Ù‡Ø°Ù‡ Ù…ÙŠØ²Ø© Ø³Ø±ÙŠØ© Ù„Ùƒ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø¯Ø§Ø¦Ù….</p>
        </div>

        <div class="guide-step">
            <h4>âš™ï¸ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h4>
            <p>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø±Ù† Ø¬Ø¯Ø§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙŠÙ‚Ø§Ù "Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆØ§Ø¦Ù„" Ø¨Ø¶ØºØ·Ø© Ø²Ø± Ø¥Ø°Ø§ ÙƒÙ†Øª ÙÙŠ ÙØªØ±Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªØŒ Ø£Ùˆ ØªÙØ¹ÙŠÙ„ "ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©" Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹.</p>
        </div>

        <div class="guide-step">
            <h4>ğŸ“¥ Ø§Ù„Ø£Ø±Ø´ÙØ© ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h4>
            <p>ÙŠÙÙ†ØµØ­ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© ÙƒÙ„ Ø´Ù‡Ø± Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª". Ø³ÙŠØ­Ù…Ù„ Ù„Ùƒ Ù…Ù„ÙØ§Ù‹ ØµØºÙŠØ±Ø§Ù‹ ÙÙŠÙ‡ ÙƒÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØªØ§Ø±ÙŠØ®Ù‡Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¶ÙŠØ§Ø¹ Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø©.</p>
        </div>
    </div>

    <div id="managePage" class="hidden card">
        <button class="btn btn-back" onclick="showScreen('teacherDash')">Ø±Ø¬ÙˆØ¹</button>
        <h3>ğŸ‘¨â€ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
        <div style="background:#eee; padding:15px; border-radius:15px;">
            <input type="text" id="addSName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
            <input type="text" id="addSCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
            <select id="addSClass"></select>
            <button class="btn btn-tech" onclick="addNewStudent()">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        </div>
        <hr>
        <div id="adminStudentList"></div>
    </div>
</div>

<footer>
    <b>Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¥Ù…Ø§Ù… ÙˆØ±Ø´ Ø§Ù„Ø°ÙƒÙŠ Â© 2026</b><br>
    Ø¨Ø¥Ø´Ø±Ø§Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© | Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±: Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø­Ù…Ø¯ & ÙŠØ²Ù† Ø£Ù†Ø³
</footer>

<script>
    // 1. ØªÙØ¹ÙŠÙ„ Firebase
    const firebaseConfig = { apiKey: "AIzaSyAC9BzBpw66oBDriZoi9A5zsThKLFZiNv8", databaseURL: "https://imam-warsh-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    let students = [], classes = ["3/1", "3/2", "3/3", "3/4", "3/5"], currentUser = null, currentSID = null, selectedClass = "3/1";
    const weeksArr = Array.from({length: 35}, (_, i) => `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i + 1}`);

    // 3. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
    function init() {
        const weekOpts = weeksArr.map(w => `<option value="${w}">${w}</option>`).join('');
        ['viewWeek', 'gWeek'].forEach(id => document.getElementById(id).innerHTML = weekOpts);
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        db.ref('config').on('value', s => {
            const conf = s.val() || {};
            if(conf.maint && (!currentUser || currentUser.role !== 'idarah')) {
                document.body.innerHTML = "<h1 style='text-align:center; margin-top:100px;'>Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ğŸ› ï¸</h1>";
            }
            document.getElementById('topTenSection').classList.toggle('hidden', conf.top === false);
            document.getElementById('broadcastPanel').classList.toggle('hidden', conf.bc === false);
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨
        db.ref('students').on('value', snap => {
            students = snap.val() ? Object.entries(snap.val()).map(([id, v]) => ({...v, id})) : [];
            renderNamesGrid();
            renderAdminStudentList();
        });

        // Ø¬Ù„Ø¨ Ø§Ù„ÙƒØ§Ø¯Ø±
        db.ref('staff').on('value', snap => {
            const staffs = snap.val() || {};
            let html = "";
            Object.values(staffs).forEach(st => {
                html += `<div style="padding:5px; border-bottom:1px solid #eee;">
                    ğŸ‘¤ ${st.user} | ğŸ”‘ <b>${st.pass}</b> | ğŸ« ÙØµÙˆÙ„Ù‡: ${st.classes || 'Ø§Ù„ÙƒÙ„'}
                    <button onclick="deleteStaff('${st.user}')" style="color:red; background:none; border:none; float:left;">Ø­Ø°Ù</button>
                </div>`;
            });
            document.getElementById('fullStaffList').innerHTML = html;
        });

        db.ref('topTen').on('value', s => { document.getElementById('topList').innerHTML = (s.val() || []).join(' | '); });
        updateClassSelectors();
    }

    // 4. Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø£Ù…Ø§Ù†
    async function mainAuth() {
        const key = document.getElementById('entryKey').value.trim();
        const pass = document.getElementById('entryPass').value.trim();
        const isStaff = !document.getElementById('staffSection').classList.contains('hidden');

        if (isStaff) {
            if (key === 'idarah' && pass === 'idarah2026') {
                currentUser = {user: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§', role: 'idarah', classes: "Ø§Ù„ÙƒÙ„"}; setupDash();
            } else {
                db.ref('staff/'+key).once('value', s => {
                    const t = s.val();
                    if(t && t.pass === pass) { currentUser = t; setupDash(); }
                    else alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø¯Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
                });
            }
        } else {
            const std = students.find(x => x.code === key);
            if (std) { currentSID = std.id; showScreen('studentPage'); renderStudentView(std); }
            else alert("ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­");
        }
    }

    function setupDash() {
        showScreen('teacherDash');
        document.getElementById('roleDisplay').innerText = `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser.user} | Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ${currentUser.role}`;
        if(currentUser.role === 'idarah') {
            document.getElementById('idarahBtn').classList.remove('hidden');
            document.getElementById('adminBtn').classList.remove('hidden');
            document.getElementById('idarahGuideBtn').classList.remove('hidden');
            loadLogs();
        }
        renderClassTabs();
    }

    function updateMyPassword() {
        const p = document.getElementById('selfPassUpdate').value;
        if(p.length < 4) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©");
        db.ref('staff/'+currentUser.user+'/pass').set(p).then(() => {
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«");
            logAction(`Ù‚Ø§Ù… ${currentUser.user} Ø¨ØªØºÙŠÙŠØ± Ø¨Ø§Ø³ÙˆØ±Ø¯Ù‡`);
        });
    }

    // 5. Ø§Ù„Ø±ØµØ¯ ÙˆØ§Ù„ØªØ¹Ù…ÙŠÙ…
    function renderNamesGrid() {
        const g = document.getElementById('namesGrid'); g.innerHTML = "";
        const vW = document.getElementById('viewWeek').value;
        const vD = document.getElementById('viewDay').value;
        
        students.filter(s => s.class === selectedClass).forEach(s => {
            const d = document.createElement('div');
            d.className = 'grid-item';
            const rec = (s.records || []).find(r => r.week === vW && r.day === vD);
            if(rec) d.classList.add('status-' + rec.status.replace(" ", "-"));
            d.innerHTML = `${s.name} <br> <small>${rec ? 'ØµÙ€ '+rec.page : ''}</small>`;
            d.onclick = () => openGrade(s);
            g.appendChild(d);
        });
    }

    function openGrade(s) {
        currentSID = s.id;
        document.getElementById('targetName').innerText = s.name;
        document.getElementById('gWeek').value = document.getElementById('viewWeek').value;
        document.getElementById('gDay').value = document.getElementById('viewDay').value;
        
        const rec = (s.records || []).find(r => r.week === document.getElementById('gWeek').value && r.day === document.getElementById('gDay').value);
        if(rec) {
            document.getElementById('gPage').value = rec.page || "";
            document.getElementById('gMark').value = rec.mark || "";
            document.getElementById('gStatus').value = rec.status || "Ø­Ø§ÙØ¸";
            document.getElementById('gNote').value = rec.note || "";
            document.getElementById('gCall').checked = rec.isParentCall || false;
            document.getElementById('gTestPages').value = rec.testPages || "";
        } else {
            ['gPage', 'gMark', 'gNote', 'gTestPages'].forEach(id => document.getElementById(id).value = "");
            document.getElementById('gCall').checked = false;
        }
        toggleTestField();
        renderEditHistory(s);
        showScreen('gradeScreen');
    }

    function saveGrade() {
        const s = students.find(x => x.id == currentSID);
        if(!s.records) s.records = [];
        
        const data = {
            week: document.getElementById('gWeek').value, day: document.getElementById('gDay').value,
            page: document.getElementById('gPage').value, mark: document.getElementById('gMark').value,
            status: document.getElementById('gStatus').value, note: document.getElementById('gNote').value,
            isParentCall: document.getElementById('gCall').checked, testPages: document.getElementById('gTestPages').value
        };

        const idx = s.records.findIndex(r => r.week === data.week && r.day === data.day);
        if(idx > -1) {
            data.originalStatus = s.records[idx].status !== data.status ? s.records[idx].status : (s.records[idx].originalStatus || null);
            s.records[idx] = data;
        } else { s.records.push(data); }

        db.ref('students/'+currentSID+'/records').set(s.records).then(() => {
            logAction(`Ø±ØµØ¯ Ù„Ù€ ${s.name} - ${data.status}`);
            showScreen('teacherDash');
        });
    }

    function applyBroadcast() {
        const bP = document.getElementById('bcPage').value;
        if(!bP) return alert("Ø­Ø¯Ø¯ Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©");
        const bW = document.getElementById('viewWeek').value, bD = document.getElementById('viewDay').value;

        students.filter(s => s.class === selectedClass).forEach(s => {
            if(!s.records) s.records = [];
            const idx = s.records.findIndex(r => r.week === bW && r.day === bD);
            const entry = {week:bW, day:bD, page:bP, status:"Ù„Ù… ÙŠØ³Ù…Ø¹", mark:0};
            if(idx > -1) s.records[idx].page = bP; else s.records.push(entry);
            db.ref('students/'+s.id+'/records').set(s.records);
        });
        alert("ØªÙ… Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ù„Ù„ÙØµÙ„ " + selectedClass);
    }

    // 6. Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
    function renderStudentView(s) {
        document.getElementById('welcomeMsg').innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ: ${s.name} (ÙØµÙ„ ${s.class})`;
        const lates = (s.records || []).filter(r => r.status === "Ù„Ù… ÙŠØ³Ù…Ø¹");
        document.getElementById('lateStats').innerHTML = `<b>ğŸ“Š Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª: ${lates.length}</b><br>` + lates.map(l => `<small>${l.week} ØµÙ€${l.page}</small>`).join(' | ');
        const call = (s.records || []).find(r => r.isParentCall);
        document.getElementById('parentCallArea').innerHTML = call ? `<div class="call-parent">âš ï¸ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆÙ„ÙŠ Ø£Ù…Ø±: ${call.note}</div>` : "";

        document.getElementById('recordsList').innerHTML = (s.records || []).reverse().map(r => `
            <div class="history-item">
                <strong>${r.week} - ${r.day}</strong> <br>
                Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status} | Ø§Ù„ØµÙØ­Ø©: ${r.page} | Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.mark}/7
                ${r.note ? `<br><small style="color:blue">Ù…Ù„Ø§Ø­Ø¸Ø©: ${r.note}</small>` : ''}
            </div>
        `).join('');
    }

    // 7. Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (IDARAH)
    function addNewStaff() {
        const u = document.getElementById('newStaffName').value, p = document.getElementById('newStaffPass').value, c = document.getElementById('newStaffClasses').value;
        if(u && p) {
            db.ref('staff/'+u).set({user:u, pass:p, classes:c, role:'teacher'});
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù… Ø¨Ù†Ø¬Ø§Ø­");
        }
    }

    function updateConfig(key, val) { db.ref('config/'+key).set(val); }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({students}));
        const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "school_db.json"); dl.click();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = JSON.parse(event.target.result);
            if(data.students) { db.ref('students').set(data.students); alert("ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©"); }
        };
        reader.readAsText(e.target.files[0]);
    }

    function factoryReset() { if(confirm("Ø­Ø°Ù ÙƒØ§Ù…Ù„ØŸ")) { db.ref('/').remove(); location.reload(); } }

    function logAction(msg) { db.ref('logs').push({msg, time: new Date().toLocaleString()}); }

    function loadLogs() {
        db.ref('logs').limitToLast(15).on('value', s => {
            let html = "";
            if(s.val()) Object.values(s.val()).reverse().forEach(l => html += `<div>[${l.time}] ${l.msg}</div>`);
            document.getElementById('logsArea').innerHTML = html;
        });
    }

    // 8. Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª
    function showScreen(id) {
        document.querySelectorAll('#app > div, #loginGate').forEach(d => d.classList.add('hidden'));
        document.getElementById('app').classList.remove('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    function setTheme(t) { document.documentElement.setAttribute('data-theme', t); }

    function renderClassTabs() {
        const tabs = document.getElementById('classTabs'); tabs.innerHTML = "";
        let myClasses = currentUser.classes === "Ø§Ù„ÙƒÙ„" ? classes : currentUser.classes.split(',');
        myClasses.forEach(c => {
            const b = document.createElement('button'); b.className = 'btn btn-tech'; b.style.width = 'auto';
            b.innerText = `ÙØµÙ„ ${c}`; b.onclick = () => { selectedClass = c; renderNamesGrid(); };
            tabs.appendChild(b);
        });
        selectedClass = myClasses[0]; renderNamesGrid();
    }

    function updateClassSelectors() {
        document.getElementById('addSClass').innerHTML = classes.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function filterGrid() {
        const q = document.getElementById('searchBox').value.toLowerCase();
        document.querySelectorAll('.grid-item').forEach(i => i.style.display = i.innerText.toLowerCase().includes(q) ? 'block' : 'none');
    }

    function toggleTestField() { document.getElementById('testField').classList.toggle('hidden', document.getElementById('gStatus').value !== 'Ø§Ø®ØªØ¨Ø§Ø±'); }

    function renderEditHistory(s) {
        document.getElementById('editHistoryArea').innerHTML = "<h4>Ø§Ù„Ø³Ø¬Ù„:</h4>" + (s.records || []).map((r, i) => `
            <div style="font-size:12px; margin-bottom:5px;">${r.week} - ${r.status} <button onclick="deleteRec(${i})" style="color:red; border:none; background:none;">Ø­Ø°Ù</button></div>
        `).join('');
    }

    function deleteRec(i) {
        const s = students.find(x => x.id == currentSID);
        s.records.splice(i, 1); db.ref('students/'+currentSID+'/records').set(s.records);
    }

    function renderAdminStudentList() {
        document.getElementById('adminStudentList').innerHTML = students.map(s => `
            <div class="history-item">${s.name} (${s.class}) <button onclick="delStudent('${s.id}')" style="float:left; color:red; border:none; background:none;">Ø­Ø°Ù</button></div>
        `).join('');
    }

    function delStudent(id) { if(confirm("Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) db.ref('students/'+id).remove(); }

    function addNewStudent() {
        const n = document.getElementById('addSName').value, c = document.getElementById('addSCode').value, cl = document.getElementById('addSClass').value;
        if(n && c) { db.ref('students/std_'+Date.now()).set({name:n, code:c, class:cl, records:[]}); alert("ØªÙ…"); }
    }

    init();
</script>
</body>
</html>
